---
phase: 06-forced-signs-subs
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - backend/routes/profiles.py
  - backend/routes/wanted.py
  - frontend/src/lib/types.ts
  - frontend/src/api/client.ts
  - frontend/src/pages/Settings.tsx
  - frontend/src/pages/Wanted.tsx
  - frontend/src/components/shared/StatusBadge.tsx
autonomous: true

must_haves:
  truths:
    - "User can set forced_preference (disabled/separate/auto) when creating or editing a language profile"
    - "Wanted list shows subtitle_type badge distinguishing full from forced items"
    - "Wanted list can be filtered by subtitle_type"
    - "Language profile API endpoints accept and return forced_preference field"
    - "Forced wanted items display with distinct visual badge"
  artifacts:
    - path: "backend/routes/profiles.py"
      provides: "forced_preference in profile API create/update endpoints"
      contains: "forced_preference"
    - path: "backend/routes/wanted.py"
      provides: "subtitle_type filter parameter on wanted list endpoint"
      contains: "subtitle_type"
    - path: "frontend/src/lib/types.ts"
      provides: "Updated LanguageProfile and WantedItem TypeScript interfaces"
      contains: "forced_preference"
    - path: "frontend/src/pages/Settings.tsx"
      provides: "Forced preference dropdown in language profile editor"
      contains: "forced_preference"
    - path: "frontend/src/pages/Wanted.tsx"
      provides: "Subtitle type filter and forced badge display"
      contains: "subtitle_type"
    - path: "frontend/src/components/shared/StatusBadge.tsx"
      provides: "Forced/signs badge variant"
      contains: "forced"
  key_links:
    - from: "frontend/src/pages/Settings.tsx"
      to: "backend/routes/profiles.py"
      via: "PUT /api/v1/language-profiles/:id with forced_preference"
      pattern: "forced_preference"
    - from: "frontend/src/pages/Wanted.tsx"
      to: "backend/routes/wanted.py"
      via: "GET /api/v1/wanted?subtitle_type=forced"
      pattern: "subtitle_type"
    - from: "frontend/src/lib/types.ts"
      to: "backend/routes/profiles.py"
      via: "LanguageProfile interface matches API response shape"
      pattern: "forced_preference.*disabled.*separate.*auto"
---

<objective>
Expose forced subtitle management through API endpoints and frontend UI.

Purpose: Users can configure forced subtitle preferences per language profile and see forced wanted items with distinct visual indicators in the Wanted list.
Output: Updated profile and wanted API endpoints, TypeScript types, Settings forced preference UI, Wanted forced badges and filter.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-forced-signs-subs/06-RESEARCH.md
@.planning/phases/06-forced-signs-subs/06-01-SUMMARY.md
@.planning/phases/06-forced-signs-subs/06-02-SUMMARY.md
@backend/routes/profiles.py
@backend/routes/wanted.py
@frontend/src/lib/types.ts
@frontend/src/api/client.ts
@frontend/src/pages/Settings.tsx
@frontend/src/pages/Wanted.tsx
@frontend/src/components/shared/StatusBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile and Wanted API endpoints</name>
  <files>backend/routes/profiles.py, backend/routes/wanted.py</files>
  <action>
    1. In `backend/routes/profiles.py`:
       - Update the POST create profile endpoint to read `forced_preference` from request JSON.
         `forced_preference = data.get("forced_preference", "disabled")`
         Validate: must be one of ("disabled", "separate", "auto"). Return 400 if invalid.
         Pass to `create_language_profile(..., forced_preference=forced_preference)`.
       - Update the PUT update profile endpoint similarly:
         Read `forced_preference` from request JSON if provided.
         Pass to `update_language_profile(..., forced_preference=forced_preference)`.
       - Verify that GET profile endpoint already returns forced_preference via `_row_to_profile()` (should work automatically from Plan 01 changes to profiles.py).

    2. In `backend/routes/wanted.py`:
       - Update the GET wanted list endpoint to accept optional `subtitle_type` query parameter.
         `subtitle_type = request.args.get("subtitle_type")` -- if provided, filter wanted items.
       - Pass subtitle_type filter to the database query. In the `get_wanted_items()` call or directly in the SQL:
         If subtitle_type is provided: add `AND subtitle_type=?` to the WHERE clause.
         If not provided: return all items (both full and forced) -- backward compatible.
       - Update the wanted summary endpoint (GET /api/v1/wanted/summary) to include `by_subtitle_type` counts:
         Add a query: `SELECT subtitle_type, COUNT(*) FROM wanted_items GROUP BY subtitle_type`
         Include result as `by_subtitle_type: {"full": N, "forced": M}` in the summary response.
       - Ensure the wanted item response includes `subtitle_type` field in JSON output (should be automatic if the column is in the SELECT * query).
  </action>
  <verify>
    `cd backend && python -c "from routes.profiles import profiles_bp; print('Profiles routes load OK')"` succeeds.
    `cd backend && python -c "from routes.wanted import wanted_bp; print('Wanted routes load OK')"` succeeds.
  </verify>
  <done>
    Profile API create/update endpoints accept forced_preference with validation.
    Profile API get endpoints return forced_preference in response.
    Wanted list API supports subtitle_type filter parameter.
    Wanted summary includes by_subtitle_type breakdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend types, Settings forced preference, Wanted forced badges</name>
  <files>frontend/src/lib/types.ts, frontend/src/api/client.ts, frontend/src/pages/Settings.tsx, frontend/src/pages/Wanted.tsx, frontend/src/components/shared/StatusBadge.tsx</files>
  <action>
    1. In `frontend/src/lib/types.ts`:
       - Add `forced_preference: 'disabled' | 'separate' | 'auto'` to `LanguageProfile` interface.
       - Add `subtitle_type: 'full' | 'forced'` to `WantedItem` interface.
       - Add `by_subtitle_type: Record<string, number>` to `WantedSummary` interface.

    2. In `frontend/src/api/client.ts`:
       - Update `createLanguageProfile()` and `updateLanguageProfile()` to include `forced_preference` in the request body.
       - Update `getWantedItems()` to accept optional `subtitle_type` filter parameter, appending `&subtitle_type=X` to the query string when provided.

    3. In `frontend/src/components/shared/StatusBadge.tsx`:
       - Add a new badge variant for forced/signs subtitles.
       - Create an exported `SubtitleTypeBadge` component that renders:
         - "Full" -> no badge (default, don't clutter UI)
         - "Forced" -> small teal badge with text "Forced" (teal matches the *arr-style theme)
       - Use Tailwind classes consistent with existing StatusBadge styling.
       - The badge should be small/compact (text-xs, px-1.5, py-0.5, rounded-full).

    4. In `frontend/src/pages/Settings.tsx`, in the Language Profiles section:
       - Add a "Forced Subtitles" dropdown/select to the profile create and edit forms.
       - Options: "Disabled" (default), "Separate" (actively search), "Auto" (detect only).
       - Position it after the target languages field.
       - Include brief helper text below the select:
         - Disabled: "Do not manage forced/signs subtitles"
         - Separate: "Actively search and track forced subtitles separately"
         - Auto: "Detect forced subtitles if found, but don't actively search"
       - Style matches existing Settings form elements (same select styling, same label pattern).
       - Wire the value to the profile create/update API calls.

    5. In `frontend/src/pages/Wanted.tsx`:
       - Add a subtitle_type filter toggle/dropdown near existing filters.
         Options: "All" (default), "Full", "Forced".
         Use a simple button group or small select, consistent with existing filter UI.
       - Pass the selected subtitle_type filter to the API call.
       - Display `SubtitleTypeBadge` next to each wanted item that has subtitle_type="forced".
         Position it after the status badge, before the title.
       - In the summary section, show forced count if > 0: "X forced" alongside existing counts.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` passes (TypeScript type checking).
    `cd frontend && npm run lint` passes (ESLint).
    `cd frontend && npm run build` succeeds (Vite production build).
  </verify>
  <done>
    TypeScript interfaces include forced_preference on LanguageProfile and subtitle_type on WantedItem.
    Settings page has forced preference dropdown in language profile editor with helper text.
    Wanted page has subtitle_type filter and displays forced badges on forced wanted items.
    StatusBadge module exports SubtitleTypeBadge component for forced indicator.
    All frontend builds and passes type checking and lint.
  </done>
</task>

</tasks>

<verification>
- Profile API round-trip: create profile with forced_preference="separate" -> GET returns forced_preference="separate"
- Wanted API: GET /api/v1/wanted?subtitle_type=forced returns only forced items
- Wanted summary includes by_subtitle_type counts
- Frontend TypeScript compiles without errors
- Frontend builds successfully
- Settings page shows forced preference dropdown with three options
- Wanted page shows forced badge on forced items
- Wanted page filter works to show only forced or only full items
</verification>

<success_criteria>
- User can set forced_preference per language profile from Settings UI
- Wanted list distinguishes forced from full items with visual badges
- Wanted list can filter by subtitle_type
- API endpoints properly pass forced_preference and subtitle_type through
- Frontend compiles, lints, and builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-forced-signs-subs/06-03-SUMMARY.md`
</output>

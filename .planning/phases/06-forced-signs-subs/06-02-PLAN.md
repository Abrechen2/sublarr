---
phase: 06-forced-signs-subs
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/wanted_scanner.py
  - backend/wanted_search.py
  - backend/providers/opensubtitles.py
  - backend/providers/__init__.py
autonomous: true

must_haves:
  truths:
    - "Scanner creates forced wanted items when profile forced_preference is 'separate'"
    - "Scanner detects existing forced subtitle files and skips them"
    - "Provider search classifies results into full vs forced categories"
    - "OpenSubtitles reads foreign_parts_only from response to identify forced results"
    - "Forced search is single-pass: search once, classify results, not double-search"
  artifacts:
    - path: "backend/wanted_scanner.py"
      provides: "Forced wanted item creation based on profile forced_preference"
      contains: "forced_preference"
    - path: "backend/wanted_search.py"
      provides: "Forced-aware search with result classification"
      contains: "subtitle_type"
    - path: "backend/providers/opensubtitles.py"
      provides: "foreign_parts_only response parsing"
      contains: "foreign_parts_only"
    - path: "backend/providers/__init__.py"
      provides: "ProviderManager passes forced_only to providers"
      contains: "forced_only"
  key_links:
    - from: "backend/wanted_scanner.py"
      to: "backend/db/wanted.py"
      via: "upsert_wanted_item with subtitle_type='forced'"
      pattern: "subtitle_type.*forced"
    - from: "backend/wanted_scanner.py"
      to: "backend/translator.py"
      via: "detect_existing_target_for_lang with subtitle_type parameter"
      pattern: "detect_existing_target_for_lang.*subtitle_type"
    - from: "backend/wanted_search.py"
      to: "backend/forced_detection.py"
      via: "classify_forced_result for search result classification"
      pattern: "from forced_detection import"
    - from: "backend/providers/opensubtitles.py"
      to: "backend/providers/base.py"
      via: "SubtitleResult.forced field populated from API response"
      pattern: "forced.*foreign_parts_only"
---

<objective>
Wire forced subtitle detection into the scanner and search pipelines.

Purpose: The scanner creates forced wanted items based on language profile settings, and the search pipeline classifies provider results to fulfill both full and forced wanted items efficiently without double-searching.
Output: Updated wanted_scanner.py, wanted_search.py, OpenSubtitles provider, ProviderManager.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-forced-signs-subs/06-RESEARCH.md
@.planning/phases/06-forced-signs-subs/06-01-SUMMARY.md
@backend/wanted_scanner.py
@backend/wanted_search.py
@backend/providers/opensubtitles.py
@backend/providers/__init__.py
@backend/forced_detection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scanner forced item creation + OpenSubtitles foreign_parts_only</name>
  <files>backend/wanted_scanner.py, backend/providers/opensubtitles.py</files>
  <action>
    1. In `backend/wanted_scanner.py`, update `_scan_sonarr_series()`:
       - After importing profile, read `forced_preference = profile.get("forced_preference", "disabled")`.
       - In the per-target-language loop (around line 405), AFTER the existing full subtitle check:
         - If forced_preference is "separate":
           - Check for existing forced subtitle: call `detect_existing_target_for_lang(mapped_path, target_lang, probe_data, subtitle_type="forced")`.
           - If no forced subtitle found (result is None), create a forced wanted item:
             `upsert_wanted_item(..., subtitle_type="forced", ...)` with same metadata but subtitle_type="forced".
           - Title should include "[Forced]" suffix for UI clarity: `f"{title} [Forced]"`.
         - If forced_preference is "auto":
           - Do NOT create dedicated forced wanted items.
           - "auto" mode means: if forced subs are found during regular search, accept them. But don't actively create wanted items for forced subs.
           - This is the key behavioral difference: "separate" = actively seek, "auto" = opportunistically accept.
       - Also update `_scan_radarr_movie()` with the same forced logic (same pattern).
       - Import `from forced_detection import is_forced_external_sub` at the top (used indirectly via detect_existing_target_for_lang which was updated in Plan 01).
       - Pass `subtitle_type="full"` explicitly to existing `upsert_wanted_item()` calls (makes the default explicit).

    2. In `backend/providers/opensubtitles.py`, update `search()`:
       - In the response parsing loop (where SubtitleResult objects are built from API response items):
         - Read `is_forced = attrs.get("foreign_parts_only", False)` from `item["attributes"]`.
         - Set `forced=is_forced` on the SubtitleResult.
         - If `query.forced_only` is True and not is_forced: skip this result (continue).
         - If `query.forced_only` is False and is_forced: skip this result (don't mix forced into full results by default).
       - This enables clean separation: full search returns only full, forced search returns only forced.
  </action>
  <verify>
    `cd backend && python -c "from wanted_scanner import WantedScanner; print('Scanner loads OK')"` succeeds.
    `cd backend && python -c "from providers.opensubtitles import OpenSubtitlesProvider; print('Provider loads OK')"` succeeds.
  </verify>
  <done>
    Scanner creates forced wanted items when profile has forced_preference="separate".
    Scanner skips forced wanted creation for forced_preference="auto" and "disabled".
    OpenSubtitles provider populates SubtitleResult.forced from foreign_parts_only attribute.
    OpenSubtitles filters results based on query.forced_only flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Search pipeline forced-aware searching + ProviderManager</name>
  <files>backend/wanted_search.py, backend/providers/__init__.py</files>
  <action>
    1. In `backend/providers/__init__.py` (ProviderManager):
       - Update `search()` method to pass `query.forced_only` through to individual providers.
         The existing method already passes the entire VideoQuery to each provider, so providers that support it (OpenSubtitles) will automatically filter. No structural change needed to ProviderManager itself.
       - However, add post-search classification: after collecting all results from all providers, use `classify_forced_result()` from forced_detection to set `result.forced = True` on results that match forced filename patterns but weren't already flagged by the provider.
         This catches forced results from providers that don't have explicit forced support (AnimeTosho, Jimaku, SubDL).
       - Import `from forced_detection import classify_forced_result` at top.
       - In the results aggregation step (after parallel search), for each result where `result.forced` is not already True:
         `forced_type = classify_forced_result(result.filename, result.provider_data)`
         If forced_type in ("forced", "signs"): `result.forced = True`
       - If `query.forced_only` is True, filter out any result where `result.forced` is False (post-filter).

    2. In `backend/wanted_search.py`, update `search_wanted_item()`:
       - Read `subtitle_type = item.get("subtitle_type", "full")` from the wanted item.
       - If subtitle_type is "forced":
         - Set `target_query.forced_only = True` and `source_query.forced_only = True`.
         - Search follows same priority order (target ASS > source ASS > target SRT > source SRT) but with forced_only flag.
         - After search, when saving the downloaded subtitle, use `get_forced_output_path()` from translator instead of regular output path.
       - Update `build_query_from_wanted()` to set `query.forced_only` based on wanted item's subtitle_type:
         `query.forced_only = wanted_item.get("subtitle_type", "full") == "forced"`.
       - In `_process_search_result()` (or equivalent download+save logic), if the wanted item subtitle_type is "forced", save to forced output path (.lang.forced.ext).
       - Import `from translator import get_forced_output_path` at top.
       - Forced subtitles are download-only (no translation per research recommendation). If subtitle_type is "forced", skip the translation step and just save the downloaded file directly. Log: "Forced subtitle downloaded, skipping translation".
  </action>
  <verify>
    `cd backend && python -c "from wanted_search import build_query_from_wanted, search_wanted_item; print('Search loads OK')"` succeeds.
    `cd backend && python -c "from providers import get_provider_manager; print('ProviderManager loads OK')"` succeeds.
  </verify>
  <done>
    ProviderManager classifies results using forced_detection for providers without native forced support.
    search_wanted_item handles forced wanted items: sets forced_only flag, saves to forced output path, skips translation.
    build_query_from_wanted sets forced_only based on wanted item subtitle_type.
    Single-pass search pattern: search once, classify results, no double-searching (avoids research pitfall #5).
  </done>
</task>

</tasks>

<verification>
- Scanner with forced_preference="separate" creates both full and forced wanted items for same file/language
- Scanner with forced_preference="disabled" creates only full wanted items (no change from before)
- Scanner with forced_preference="auto" creates only full wanted items (no dedicated forced tracking)
- OpenSubtitles provider returns forced=True on results with foreign_parts_only attribute
- ProviderManager classifies results from all providers using filename pattern matching
- search_wanted_item with subtitle_type="forced" sets forced_only on queries
- Forced downloads save to .lang.forced.ext path without triggering translation
</verification>

<success_criteria>
- Scanner produces forced wanted items for profiles with forced_preference="separate"
- Provider search is forced-aware: classifies results and filters on forced_only
- Forced subtitles download to correct file path (.lang.forced.ext)
- No double-searching: single provider search, post-classification
- No regression: default behavior unchanged for subtitle_type="full"
</success_criteria>

<output>
After completion, create `.planning/phases/06-forced-signs-subs/06-02-SUMMARY.md`
</output>

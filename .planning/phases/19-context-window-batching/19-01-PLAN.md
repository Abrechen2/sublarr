---
phase: 19-context-window-batching
plan: 01
type: execute
wave: 1
depends_on: ["18-02"]
files_modified:
  - backend/translator.py
  - backend/translation/__init__.py
  - backend/db/config.py
  - backend/routes/translate.py
autonomous: true

must_haves:
  truths:
    - "When context_window_size > 0, the LLM prompt includes N preceding and N following lines as [CONTEXT - DO NOT TRANSLATE] blocks around [TRANSLATE THESE LINES]"
    - "Context window size is read from config_entry translation.context_window_size (default 3, range 0-10); 0 disables the feature"
    - "Scene break: time gap > 5 seconds between context line and target block stops context inclusion in that direction"
    - "Start/end of file use only available lines (no padding); files with < 3 lines use all as context"
  artifacts:
    - path: "backend/translator.py"
      provides: "Context assembly from subtitle events, scene-break logic, and call path passing context to translation"
    - path: "backend/translation/__init__.py"
      provides: "translate_with_fallback / backend.translate_batch accepting optional context_before, context_after or equivalent"
    - path: "backend/db/config.py"
      provides: "Config entry translation.context_window_size read/write"
  key_links:
    - from: "backend/translator.py"
      to: "backend/db/config.py"
      via: "get_config_entry('translation.context_window_size')"
      pattern: "context_window_size"
    - from: "backend/translator.py"
      to: "backend/translation/__init__.py"
      via: "translate_with_fallback with context data"
      pattern: "translate_with_fallback"
---

<objective>
Backend: inject surrounding subtitle lines as read-only context into the LLM translation pipeline.

Purpose: Each translation call includes N lines before and after the target batch so the LLM produces more coherent output (pronouns, scene continuity). Context is never translated. When context_window_size = 0, behavior is unchanged.

Output: Config entry for context window size; context assembly with scene-break (5s gap) and edge handling; prompt structure [CONTEXT - DO NOT TRANSLATE] / [TRANSLATE THESE LINES]; integration in translator.py and translation manager/backends.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-context-window-batching/19-RESEARCH.md
@.planning/phases/19-context-window-batching/19-CONTEXT.md

@backend/translator.py
@backend/translation/__init__.py
@backend/db/config.py
@backend/db/repositories/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config entry for context window size</name>
  <files>
    backend/db/config.py
    backend/routes/translate.py
  </files>
  <action>
1. **Config entry:** Key `translation.context_window_size`, default 3, range 0-10. Store/read via existing `get_config_entry` / `save_config_entry` (backend/db/config.py or repositories/config.py). No new DB table; config_entries already supports arbitrary keys.
2. **API (optional for 19-01):** If config is exposed via existing GET/PUT /config or /settings, add the key there so the frontend can read/write it in 19-02. Otherwise document that 19-02 will need an endpoint or use existing config API.
  </action>
  <verify>
    Run: `cd backend && python -c "from db.config import get_config_entry; print(get_config_entry('translation.context_window_size'))"` â€” returns None or stored value; after save_config_entry('translation.context_window_size', '3') round-trip works.
  </verify>
  <done>
    translation.context_window_size is readable and writable via config_entries; default 3 when unset.
  </done>
</task>

<task type="auto">
  <name>Task 2: Context assembly in translator.py</name>
  <files>
    backend/translator.py
  </files>
  <action>
1. In the three call sites that build dialog_texts and call _translate_with_manager (translate_ass_embedded, _translate_srt, translate_external_ass), obtain full subtitle events (with start/end times) in order. Load context_window_size from config; if 0, skip context and call _translate_with_manager as today (lines only).
2. For each batch of dialog lines to translate:
   - Determine preceding context: up to N lines before, but stop when time gap from context line to first target line > 5 seconds (scene break).
   - Determine following context: up to N lines after, but stop when time gap from last target line to context line > 5 seconds.
   - For start/end of file: use only available lines (0 to N-1).
   - Very short files (< 3 lines total): use all available as context per 19-CONTEXT.
3. Pass context to _translate_with_manager: either (context_before, lines, context_after) where each is a list of (time_ms, text) or (text_only) as needed by the next layer. Backends need timing + text for context lines per CONTEXT ("Each context line shown with its timing + text").
  </action>
  <verify>
    Unit test or manual run: with context_window_size=3, a 10-line file produces context for middle batches; with gap > 5s between two blocks, context does not cross the gap.
  </verify>
  <done>
    Context assembly implemented with 5s scene break and edge rules; translator passes context to translation layer.
  </done>
</task>

<task type="auto">
  <name>Task 3: TranslationManager and backends accept context</name>
  <files>
    backend/translation/__init__.py
    backend/translation/ollama.py
    backend/translation/openai_compat.py
  </files>
  <action>
1. **TranslationManager.translate_with_fallback:** Add optional parameters context_before and context_after (list of dicts with keys e.g. start_ms, end_ms, text). When present, pass them to backend.translate_batch. When absent (or context_window_size=0), backends behave as today.
2. **Backend contract:** Extend translate_batch signature to accept optional context_before, context_after. Build prompt with:
   - [CONTEXT - DO NOT TRANSLATE] block: each line as timing + text (format at implementer discretion, e.g. HH:MM:SS or ms).
   - [TRANSLATE THESE LINES] block: target lines.
   - [CONTEXT - DO NOT TRANSLATE] block: following lines.
   - System prompt addition: translate ONLY the lines in the TRANSLATE block.
3. Implement in at least Ollama and one OpenAI-compat backend so the feature is usable; other backends can ignore context until updated.
  </action>
  <verify>
    Run backend tests; translate a short file with context_window_size=3 and confirm prompt contains context blocks (inspect logs or mock).
  </verify>
  <done>
    translate_with_fallback and translate_batch accept context; prompt structure matches 19-CONTEXT; at least one LLM backend uses context.
  </done>
</task>

</tasks>

<verification>
1. Config: translation.context_window_size 0-10, default 3, stored in config_entries.
2. Translator: context assembled with 5s scene break and edge rules; passed to manager.
3. Manager/backends: context_before/context_after in prompt as [CONTEXT - DO NOT TRANSLATE] and [TRANSLATE THESE LINES]; system prompt reinforces translate-only target lines.
4. When context_window_size=0, no behavior change (no context passed).
</verification>

<success_criteria>
- Context window size is configurable (0-10, default 3) via config entry.
- LLM receives surrounding lines as read-only context with correct prompt structure.
- Scene break (5s gap) and file-edge behavior as specified.
- Pipeline unchanged when context window is 0.
</success_criteria>

<output>
After completion, create `.planning/phases/19-context-window-batching/19-01-SUMMARY.md`
</output>

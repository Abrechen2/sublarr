---
phase: 21-translation-quality-scoring
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/components/editor/SubtitleEditorModal.tsx
  - frontend/src/components/editor/SubtitlePreview.tsx
  - frontend/src/components/editor/SubtitleTimeline.tsx
  - frontend/src/pages/Activity.tsx
  - frontend/src/api/client.ts
autonomous: false

must_haves:
  truths:
    - "Quality scores are visible per line in the Subtitle Editor (Timeline or Preview)"
    - "Aggregate quality score per file is visible in Activity / Job History"
    - "User can configure quality threshold and max retries in Settings Translation"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "SubtitleCue extended with optional quality_score"
    - path: "frontend/src/components/editor/"
      provides: "Display of per-line quality in editor/timeline"
    - path: "frontend/src/pages/Activity.tsx"
      provides: "Job row or expanded row shows avg_quality / quality info"
    - path: "frontend/src/pages/Settings/TranslationTab.tsx"
      provides: "Quality threshold and max retries config"
  key_links:
    - from: "frontend/src/components/editor"
      to: "frontend/src/api/client.ts"
      via: "parseSubtitleCues or getSubtitleContent returning scores"
    - from: "frontend/src/pages/Activity.tsx"
      to: "job.stats"
      via: "avg_quality, low_quality_lines"
---

<objective>
Frontend: display translation quality scores per line in the editor and aggregate in Activity; Settings for threshold and max retries.

Purpose: Users see which lines had low quality and the overall job quality in Activity. Users configure retry threshold and max retries in Settings.

Output: SubtitleCue.quality_score (optional); editor/timeline show score per line; Activity shows job quality; Settings Translation has quality threshold and max retries.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-translation-quality-scoring/21-01-SUMMARY.md

@frontend/src/lib/types.ts
@frontend/src/components/editor/SubtitleEditorModal.tsx
@frontend/src/components/editor/SubtitlePreview.tsx
@frontend/src/components/editor/SubtitleTimeline.tsx
@frontend/src/pages/Activity.tsx
@frontend/src/api/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types and API for quality scores</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/api/client.ts
  </files>
  <action>
1. In types.ts: add optional quality_score?: number to SubtitleCue (or to the type returned by parse).
2. Ensure parseSubtitleCues (or equivalent) response type includes quality_score per cue when backend returns it. Update client and hooks if response shape changes.
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit`.
  </verify>
  <done>
    SubtitleCue (or parse result) has optional quality_score; API client typed accordingly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Per-line quality in editor and timeline</name>
  <files>
    frontend/src/components/editor/SubtitleEditorModal.tsx
    frontend/src/components/editor/SubtitlePreview.tsx
    frontend/src/components/editor/SubtitleTimeline.tsx
  </files>
  <action>
1. Where cues are rendered (Timeline, Preview, or list in modal), show quality_score when present: e.g. small badge or color cue (green/yellow/red by score band). Tooltip or label with numeric score.
2. Do not block editing if scores are missing (optional field).
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit` and `npm run lint`. Manually open editor for a file with scores; confirm display.
  </verify>
  <done>
    Editor/Timeline/Preview show per-line quality when available.
  </done>
</task>

<task type="auto">
  <name>Task 3: Activity job history quality display</name>
  <files>
    frontend/src/pages/Activity.tsx
  </files>
  <action>
1. In Activity table or expanded row, display job.stats.avg_quality and job.stats.low_quality_lines when present (e.g. "Avg quality: 78, Low: 2 lines").
2. Use existing job.stats typing (Record<string, unknown> or extend with optional avg_quality, low_quality_lines).
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit`. After a translation job with quality enabled, Activity shows quality info.
  </verify>
  <done>
    Activity shows aggregate quality per job when stats include it.
  </done>
</task>

<task type="auto">
  <name>Task 4: Settings for quality threshold and max retries</name>
  <files>
    frontend/src/pages/Settings/TranslationTab.tsx
    frontend/src/api/client.ts
    frontend/src/hooks/useApi.ts
  </files>
  <action>
1. In Translation tab, add "Translation quality" section: number input for threshold (0-100, default 50), number input for max retries (0-5, default 2). Save via config API (translation_quality_threshold, translation_quality_max_retries).
2. Short help text: "Lines scoring below threshold are retried up to max retries."
  </action>
  <verify>
    Run: `cd frontend && npm run build`. Save settings and confirm values persist.
  </verify>
  <done>
    Settings Translation has quality threshold and max retries; values persist.
  </done>
</task>

</tasks>

<verification>
1. SubtitleCue or parse result includes optional quality_score.
2. Editor/Timeline/Preview show per-line quality when present.
3. Activity shows job quality (avg_quality, low_quality_lines).
4. Settings: quality threshold and max retries configurable.
</verification>

<success_criteria>
- Quality scores visible per line in the Subtitle Editor.
- Aggregate quality visible in Job History (Activity).
- User can configure threshold and max retries in Settings.
</success_criteria>

<output>
After completion, create `.planning/phases/21-translation-quality-scoring/21-02-SUMMARY.md`
</output>

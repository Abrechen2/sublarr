---
phase: 26-whisper-fallback-threshold
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/translator.py
  - backend/db/config.py
  - backend/db/models/providers.py
  - backend/db/providers.py
  - backend/whisper/queue.py
autonomous: true

must_haves:
  truths:
    - "User can configure a minimum provider score threshold (0-100) below which Whisper is triggered (default: disabled)"
    - "When threshold is set and all provider results score below it, Whisper runs automatically and its result is used"
    - "Whisper-generated subtitles are tagged as whisper_generated and flagged as upgrade candidates"
  artifacts:
    - path: "backend/translator.py"
      provides: "Min score threshold check; call search with min_score; when best < threshold trigger Whisper (Case D)"
    - path: "backend/db/config.py"
      provides: "Config whisper_fallback_min_score (0-100, 0 = disabled)"
    - path: "backend/db/models/providers.py"
      provides: "subtitle_downloads extended with source/whisper_generated"
    - path: "backend/whisper/queue.py"
      provides: "On Whisper success: write SRT to file, record_subtitle_download with whisper_generated"
  key_links:
    - from: "backend/translator.py"
      to: "search_and_download_best(..., min_score=threshold)"
    - from: "backend/whisper/queue.py"
      to: "backend/db/providers.py"
      via: "record_subtitle_download(..., source='whisper')"
---

<objective>
Backend + Frontend: Configurable min provider score threshold; when all results below threshold trigger Whisper; tag Whisper results as whisper_generated and upgrade candidates.

Purpose: If no provider subtitle is good enough (all below threshold), automatically use Whisper; mark result so better provider subs can replace later.

Output: Config whisper_fallback_min_score (0 = disabled); translator passes min_score to search; when best score < threshold do not use provider result and run Case D (Whisper); subtitle_downloads has source or whisper_generated flag; Whisper completion writes SRT and records download with flag; Frontend Settings for threshold.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@backend/translator.py
@backend/whisper/queue.py
@backend/db/providers.py
@backend/db/models/providers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Min score threshold and translator logic</name>
  <files>
    backend/translator.py
    backend/providers/__init__.py
  </files>
  <action>
1. Config: whisper_fallback_min_score (int 0-100). 0 = disabled (current behavior: only trigger Whisper when zero results). Stored in config_entries.
2. In translator.translate_file (Case C3): when calling _search_providers_for_source_sub, pass min_score from config. In ProviderManager.search_and_download_best: when min_score > 0, after search filter out results below min_score; if best result exists but its score < min_score, treat as no acceptable result (return None or equivalent) so caller falls through to Case D.
3. When _search_providers_for_source_sub gets no acceptable result (none or best < threshold), do not download; return so Case D (Whisper) runs.
  </action>
  <verify>
    With threshold=80 and only low-scoring results, Whisper is triggered; with threshold=0, behavior unchanged.
  </verify>
  <done>
    Min score threshold configurable; translator triggers Whisper when best provider score < threshold.
  </done>
</task>

<task type="auto">
  <name>Task 2: subtitle_downloads whisper_generated and Whisper completion</name>
  <files>
    backend/db/models/providers.py
    backend/db/repositories/providers.py
    backend/db/providers.py
    backend/whisper/queue.py
  </files>
  <action>
1. Extend SubtitleDownload model: add source (str, default 'provider') or whisper_generated (bool). Migration for new column.
2. record_subtitle_download: add optional parameter source='provider' or whisper_generated=True. When Whisper completes: write SRT content to file (e.g. {base}.{lang}.srt), then call record_subtitle_download(file_path, ..., source='whisper') or whisper_generated=True so DB marks it. Ensure upgrade logic treats whisper_generated as upgrade candidate (existing upgrade path may already allow replacing by score).
  </action>
  <verify>
    Run Whisper to completion; check subtitle_downloads row has source='whisper' or whisper_generated=true; file exists.
  </verify>
  <done>
    Whisper results recorded with whisper_generated/source; SRT written; upgrade candidates work.
  </done>
</task>

<task type="auto">
  <name>Task 3: Frontend Settings for threshold</name>
  <files>
    frontend/src/pages/Settings/
  </files>
  <action>
1. In Settings (Translation or Whisper section): add "Whisper fallback min score" number input (0-100). 0 = disabled. Help text: "When all provider results are below this score, use Whisper instead. 0 = only when no results." Save to config whisper_fallback_min_score.
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit`. Save and reload; value persists.
  </verify>
  <done>
    Settings has Whisper fallback min score; 0 = disabled.
  </done>
</task>

</tasks>

<verification>
1. whisper_fallback_min_score config; translator uses it in Case C3; Whisper runs when best < threshold.
2. subtitle_downloads has source/whisper_generated; Whisper completion writes file and records with flag.
3. Frontend: threshold setting in Settings.
</verification>

<success_criteria>
- User can set min provider score below which Whisper is used; default disabled.
- Whisper results tagged and stored; upgrade path can replace them with better provider subs.
</success_criteria>

<output>
After completion, create `.planning/phases/26-whisper-fallback-threshold/26-01-SUMMARY.md`
</output>

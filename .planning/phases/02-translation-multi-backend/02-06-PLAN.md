---
phase: 02-translation-multi-backend
plan: 06
type: execute
wave: 4
depends_on: ["02-04", "02-05"]
files_modified:
  - backend/tests/test_translation_backends.py
autonomous: true

must_haves:
  truths:
    - "Unit tests verify TranslationBackend ABC contract enforcement"
    - "Unit tests verify TranslationManager registration, config loading, and fallback chain logic"
    - "Unit tests verify OllamaBackend prompt building and response parsing via LLM utilities"
    - "Unit tests verify backend stats recording in database"
    - "Unit tests verify profile-based backend resolution"
  artifacts:
    - path: "backend/tests/test_translation_backends.py"
      provides: "Comprehensive test suite for translation multi-backend system"
      contains: "test_"
      min_lines: 100
  key_links:
    - from: "backend/tests/test_translation_backends.py"
      to: "backend/translation/base.py"
      via: "tests import and verify ABC contract"
      pattern: "from translation\\.base import"
    - from: "backend/tests/test_translation_backends.py"
      to: "backend/translation/__init__.py"
      via: "tests verify TranslationManager behavior"
      pattern: "TranslationManager"
---

<objective>
Create a comprehensive test suite for the translation multi-backend system covering the ABC contract, manager orchestration, LLM utilities, backend stats, and profile integration.

Purpose: Tests verify the Phase 2 system works correctly end-to-end without requiring actual external services. All backends are tested with mocked HTTP calls.
Output: Test file that passes with `pytest`.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-translation-multi-backend/02-01-SUMMARY.md
@.planning/phases/02-translation-multi-backend/02-04-SUMMARY.md

@backend/translation/base.py
@backend/translation/__init__.py
@backend/translation/llm_utils.py
@backend/tests/test_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create translation backend test suite</name>
  <files>
    backend/tests/test_translation_backends.py
  </files>
  <action>
Create `backend/tests/test_translation_backends.py` with the following test groups:

**1. ABC Contract Tests:**
- `test_cannot_instantiate_abc()` — Verify `TranslationBackend()` raises TypeError
- `test_concrete_backend_must_implement_methods()` — Subclass without implementing abstract methods raises TypeError
- `test_translation_result_defaults()` — TranslationResult has correct default values
- `test_translation_result_success_false()` — TranslationResult with success=False

**2. LLM Utilities Tests:**
- `test_build_translation_prompt_basic()` — Numbered lines, no glossary
- `test_build_translation_prompt_with_glossary()` — Glossary entries prepended
- `test_build_translation_prompt_glossary_max_15()` — Max 15 glossary entries
- `test_parse_llm_response_exact_count()` — Correct number of lines
- `test_parse_llm_response_numbered()` — Strip "1: ", "2. " prefixes
- `test_parse_llm_response_too_many_merge()` — Merge excess lines
- `test_parse_llm_response_too_few_returns_none()` — Line count mismatch
- `test_has_cjk_hallucination_true()` — Chinese chars detected
- `test_has_cjk_hallucination_false()` — Normal German/English text

**3. TranslationManager Tests (use a MockBackend):**
Create a `MockBackend(TranslationBackend)` that implements all methods:
- `translate_batch()` returns configurable results (success or failure via constructor flag)
- `health_check()` returns `(True, "mock OK")`
- `get_config_fields()` returns empty list

Tests:
- `test_register_backend()` — Backend class appears in registry
- `test_get_backend_creates_instance()` — Lazy creation works
- `test_get_all_backends_lists_registered()` — Returns info dicts
- `test_translate_with_fallback_success()` — First backend succeeds, returns result
- `test_translate_with_fallback_tries_next()` — First fails, second succeeds
- `test_translate_with_fallback_all_fail()` — All backends fail, returns error result
- `test_translate_with_fallback_skips_circuit_breaker_open()` — Open circuit breaker skips backend
- `test_invalidate_backend_clears_cache()` — Invalidated backend is re-created on next use

**4. Backend Stats Tests:**
- `test_record_backend_success()` — Stats row created/updated with success
- `test_record_backend_failure()` — Stats row created/updated with failure
- `test_consecutive_failures_reset_on_success()` — Counter resets
- `test_get_backend_stats()` — Returns list of all stats
- `test_avg_response_time_weighted()` — Running average formula correct

**5. Profile Backend Resolution Tests:**
- `test_resolve_default_profile_backend()` — No context returns default profile's backend
- `test_resolve_series_profile_backend()` — Series context returns series profile's backend
- `test_fallback_chain_from_profile()` — Profile's fallback chain is used
- `test_primary_backend_prepended_to_chain()` — Primary always first in chain

**6. Individual Backend Smoke Tests (with mocked HTTP):**
Use `unittest.mock.patch` or `responses` library to mock HTTP calls:
- `test_ollama_backend_config_fields()` — Has expected config fields
- `test_deepl_backend_config_fields()` — Has api_key field
- `test_libretranslate_backend_config_fields()` — Has url and api_key fields
- `test_openai_compat_backend_config_fields()` — Has api_key, base_url, model fields
- `test_google_backend_config_fields()` — Has project_id field

Use `create_app(testing=True)` for tests that need DB access. Use `tmp_path` fixture or in-memory DB.

Follow existing test patterns from `backend/tests/` — use `pytest` style, no classes unless grouping helps readability.
  </action>
  <verify>
Run: `cd backend && python -m pytest tests/test_translation_backends.py -v 2>&1 | tail -30`
All tests should pass. Report count of passed tests.
  </verify>
  <done>
Test suite covers ABC contract, LLM utilities, manager orchestration, fallback chains, backend stats, profile resolution, and individual backend config. All tests pass with mocked external services.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_translation_backends.py -v` — all tests pass
2. Tests cover: ABC contract, LLM utilities, manager, stats, profiles, individual backends
3. No tests require actual external services (all HTTP mocked)
4. Test file follows existing pytest conventions from backend/tests/
</verification>

<success_criteria>
- All tests pass
- Coverage spans the critical paths: registration, config loading, translate_with_fallback, stats recording, profile resolution
- LLM utilities (prompt building, response parsing, CJK detection) have thorough input/output test cases
- No external service calls during tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-translation-multi-backend/02-06-SUMMARY.md`
</output>

---
phase: 02-translation-multi-backend
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-04"]
files_modified:
  - frontend/src/pages/Settings.tsx
  - frontend/src/lib/types.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/api/client.ts
autonomous: true

must_haves:
  truths:
    - "Settings page has a 'Translation Backends' tab showing all registered backends with config forms"
    - "Each backend has a Test button that calls health_check and shows result"
    - "Language profile editor shows translation backend dropdown and fallback chain editor"
    - "Backend stats are visible (success rate, error count, last used)"
  artifacts:
    - path: "frontend/src/pages/Settings.tsx"
      provides: "Translation Backends tab with config forms, test buttons, fallback editor"
      contains: "Translation Backends"
    - path: "frontend/src/lib/types.ts"
      provides: "TranslationBackend and BackendStats TypeScript interfaces"
      contains: "TranslationBackend"
    - path: "frontend/src/hooks/useApi.ts"
      provides: "React Query hooks for backend API"
      contains: "useBackends"
  key_links:
    - from: "frontend/src/pages/Settings.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useBackends, useTestBackend, useBackendConfig hooks"
      pattern: "useBackends|useTestBackend"
    - from: "frontend/src/hooks/useApi.ts"
      to: "frontend/src/api/client.ts"
      via: "axios API calls to /api/v1/backends/*"
      pattern: "/backends"
---

<objective>
Build the frontend UI for translation backend management: a Settings tab for configuring backends with test buttons, backend selection in language profile editor, fallback chain configuration, and backend statistics display.

Purpose: Users need to configure, test, and manage translation backends through the UI (TRAN-09). Backend stats provide visibility into translation quality per backend (TRAN-10).
Output: Complete frontend for multi-backend translation management.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-translation-multi-backend/02-RESEARCH.md
@.planning/phases/02-translation-multi-backend/02-04-SUMMARY.md

@frontend/src/pages/Settings.tsx
@frontend/src/lib/types.ts
@frontend/src/hooks/useApi.ts
@frontend/src/api/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TypeScript types and API hooks for translation backends</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/api/client.ts
    frontend/src/hooks/useApi.ts
  </files>
  <action>
**types.ts** — Add interfaces:
```typescript
export interface TranslationBackendInfo {
  name: string
  display_name: string
  config_fields: ConfigField[]
  configured: boolean
  supports_glossary: boolean
  max_batch_size: number
}

export interface ConfigField {
  key: string
  label: string
  type: 'text' | 'password' | 'number'
  required: boolean
  default: string
  help?: string
}

export interface BackendConfig {
  [key: string]: string
}

export interface BackendHealthResult {
  healthy: boolean
  message: string
  usage?: Record<string, unknown>
}

export interface BackendStats {
  backend_name: string
  total_requests: number
  successful_translations: number
  failed_translations: number
  total_characters: number
  avg_response_time_ms: number
  last_response_time_ms: number
  last_success_at: string | null
  last_failure_at: string | null
  last_error: string
  consecutive_failures: number
}
```

Update `LanguageProfile` interface to include:
```typescript
export interface LanguageProfile {
  // ... existing fields ...
  translation_backend: string
  fallback_chain: string[]
}
```

**client.ts** — Add API functions:
- `getBackends(): Promise<{backends: TranslationBackendInfo[]}>` — GET `/api/v1/backends`
- `testBackend(name: string): Promise<BackendHealthResult>` — POST `/api/v1/backends/test/{name}`
- `getBackendConfig(name: string): Promise<BackendConfig>` — GET `/api/v1/backends/{name}/config`
- `saveBackendConfig(name: string, config: BackendConfig): Promise<void>` — PUT `/api/v1/backends/{name}/config`
- `getBackendStats(): Promise<{stats: BackendStats[]}>` — GET `/api/v1/backends/stats`

**hooks/useApi.ts** — Add React Query hooks:
- `useBackends()` — `useQuery(['backends'], getBackends)` with 30s stale time
- `useTestBackend()` — `useMutation(testBackend)`, shows toast on result
- `useBackendConfig(name: string)` — `useQuery(['backend-config', name], () => getBackendConfig(name))`, enabled only when name is truthy
- `useSaveBackendConfig()` — `useMutation(saveBackendConfig)`, invalidates `['backends']` and `['backend-config']` on success, shows success toast
- `useBackendStats()` — `useQuery(['backend-stats'], getBackendStats)` with 60s stale time
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit 2>&1 | head -20` — should have no new type errors related to backend types.
  </verify>
  <done>
TypeScript interfaces defined for backends, config, health, and stats. API client functions call all 5 backend endpoints. React Query hooks manage caching and mutations for backend management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Translation Backends Settings tab and profile backend selector</name>
  <files>
    frontend/src/pages/Settings.tsx
  </files>
  <action>
**Settings.tsx** — Add "Translation Backends" tab and enhance profile editor:

1. **Add tab:** Insert `'Translation Backends'` into the TABS array (after 'Ollama' or 'Translation').

2. **Backend list section** (rendered when tab is 'Translation Backends'):
   - Use `useBackends()` to fetch all backends
   - Use `useBackendStats()` to fetch stats
   - For each backend, render a collapsible card (same expand/collapse pattern used in Providers tab):
     - **Header:** Backend display_name, configured badge (green/gray), supports_glossary badge
     - **Stats row** (if stats exist for this backend): Success rate (successful/total as percentage), avg response time, last error (truncated), consecutive failures count
     - **Config form:** Dynamically render form fields from `backend.config_fields`:
       - `type: "text"` -> text input
       - `type: "password"` -> password input with show/hide toggle
       - `type: "number"` -> number input
       - Show `help` text below each field if provided
       - Show `(required)` indicator on required fields
     - **Action buttons:**
       - "Test" button: calls `useTestBackend()` mutation with backend name, shows result in toast (green for healthy, red for unhealthy with message)
       - "Save" button: calls `useSaveBackendConfig()` mutation, saves all form field values
   - Load existing config values via `useBackendConfig(selectedBackend)` when card is expanded

3. **Profile backend selector** (in Language Profiles section):
   - Add a dropdown `<select>` for "Translation Backend" showing all registered backends
   - Value comes from `profile.translation_backend`
   - onChange: update profile via existing `useUpdateProfile()` mutation

4. **Fallback chain editor** (in Language Profiles section, below backend selector):
   - Display current fallback chain as ordered list of backend names
   - Each item has up/down arrow buttons to reorder and an X button to remove
   - "Add Backend" dropdown to append a backend not already in the chain
   - The primary backend (from dropdown) is always first in the chain and cannot be removed
   - onChange: update profile's `fallback_chain` via mutation

5. **Remove old Ollama tab fields** that are now managed per-backend:
   - Keep the "Ollama" tab for now but add a note: "Ollama settings are now managed in the Translation Backends tab. Changes here apply as defaults for new installations."
   - Alternatively: Remove the Ollama tab entirely and let all Ollama config go through the Translation Backends tab. Use your judgment here — if removing the tab is cleaner, do it; if keeping it as a legacy convenience helps, keep it with the note.

6. **Styling:** Follow existing Settings.tsx patterns:
   - Teal accent color (#14b8a6) for active states and badges
   - Same card/section layout as Providers tab
   - Tailwind v4 classes consistent with rest of Settings page
   - Responsive: stack on mobile, side-by-side on desktop
  </action>
  <verify>
Run: `cd frontend && npm run build 2>&1 | tail -5` — build should succeed with no errors.
  </verify>
  <done>
Settings page has a "Translation Backends" tab with dynamic config forms, test buttons, and stats display for all 5 backends. Language profile editor includes backend selection dropdown and fallback chain editor with drag reordering. UI follows existing *arr-style teal theme.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without type errors
2. Settings page shows "Translation Backends" tab
3. Opening the tab shows all registered backends with config forms
4. Test button triggers health check and shows result
5. Save button persists backend config
6. Language profile editor shows backend dropdown and fallback chain
7. Backend stats (success rate, response time) are displayed per backend
</verification>

<success_criteria>
- User can configure all 5 translation backends from the Settings page (TRAN-09)
- User can test each backend with a single click
- User can select translation backend per language profile (TRAN-07 UI)
- User can configure fallback chain order per profile (TRAN-08 UI)
- Backend stats are visible: success rate, error history, response time (TRAN-10)
- UI follows existing teal *arr-style design patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-translation-multi-backend/02-05-SUMMARY.md`
</output>

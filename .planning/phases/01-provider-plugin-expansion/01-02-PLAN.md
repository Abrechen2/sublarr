---
phase: 01-provider-plugin-expansion
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/db/__init__.py
  - backend/db/providers.py
  - backend/providers/__init__.py
  - backend/routes/providers.py
  - frontend/src/lib/types.ts
  - frontend/src/pages/Settings.tsx
autonomous: true

must_haves:
  truths:
    - "Provider health dashboard shows per-provider success rate, response time, and download count"
    - "Unhealthy providers auto-disable with configurable cooldown"
    - "Provider stats include response time tracking (avg and last)"
    - "Frontend displays provider health stats in the Providers tab"
  artifacts:
    - path: "backend/db/providers.py"
      provides: "Response time tracking in provider stats"
      contains: "response_time_ms"
    - path: "backend/db/__init__.py"
      provides: "Schema migration for response_time_ms columns"
      contains: "avg_response_time_ms"
    - path: "backend/routes/providers.py"
      provides: "Enhanced stats endpoint with response times and health history"
      contains: "response_time"
    - path: "frontend/src/lib/types.ts"
      provides: "Updated ProviderInfo and ProviderStats types with response times"
      contains: "response_time"
  key_links:
    - from: "backend/providers/__init__.py"
      to: "backend/db/providers.py"
      via: "records response time after each search"
      pattern: "update_provider_stats.*response_time"
    - from: "backend/routes/providers.py"
      to: "backend/db/providers.py"
      via: "reads stats including response times for API response"
      pattern: "get_provider_stats"
    - from: "frontend/src/pages/Settings.tsx"
      to: "backend/routes/providers.py"
      via: "fetches and displays provider stats via API"
      pattern: "useProviderStats"
---

<objective>
Enhance provider health monitoring with response time tracking, auto-disable with configurable cooldown, and a richer stats API for the frontend dashboard. This extends the existing provider_stats table and circuit breaker system.

Purpose: PROV-09 (Provider Health Monitoring) and PROV-10 (Provider Statistics Dashboard) enable users to see which providers are performing well and which are failing, with automatic degradation for unhealthy providers.

Output: Enhanced backend stats tracking + frontend displays health metrics per provider.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 refactors ProviderManager; this plan hooks into the refactored search flow
@.planning/phases/01-provider-plugin-expansion/01-01-SUMMARY.md

@backend/db/__init__.py
@backend/db/providers.py
@backend/providers/__init__.py
@backend/circuit_breaker.py
@backend/routes/providers.py
@frontend/src/lib/types.ts
@frontend/src/pages/Settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add response time tracking to provider stats and enhance auto-disable</name>
  <files>
    backend/db/__init__.py
    backend/db/providers.py
    backend/providers/__init__.py
    backend/routes/providers.py
  </files>
  <action>
    1. In `backend/db/__init__.py`, add a migration in `_run_migrations()` to add response time columns to `provider_stats` table:
       ```python
       cursor = conn.execute("PRAGMA table_info(provider_stats)")
       columns = {row[1] for row in cursor.fetchall()}
       if "avg_response_time_ms" not in columns:
           conn.execute("ALTER TABLE provider_stats ADD COLUMN avg_response_time_ms REAL DEFAULT 0")
       if "last_response_time_ms" not in columns:
           conn.execute("ALTER TABLE provider_stats ADD COLUMN last_response_time_ms REAL DEFAULT 0")
       if "auto_disabled" not in columns:
           conn.execute("ALTER TABLE provider_stats ADD COLUMN auto_disabled INTEGER DEFAULT 0")
       if "disabled_until" not in columns:
           conn.execute("ALTER TABLE provider_stats ADD COLUMN disabled_until TEXT DEFAULT ''")
       ```
       Also update the SCHEMA DDL to include these columns in the CREATE TABLE statement for new installations.

    2. In `backend/db/providers.py`:
       a. Extend `update_provider_stats()` to accept an optional `response_time_ms: float = None` parameter. When provided, update `last_response_time_ms` and calculate running average for `avg_response_time_ms` (weighted average: `new_avg = (old_avg * (n-1) + new_value) / n` where n = total_searches).
       b. Add `auto_disable_provider(provider_name: str, cooldown_minutes: int)`: sets `auto_disabled = 1` and `disabled_until = now + cooldown_minutes`.
       c. Add `is_provider_auto_disabled(provider_name: str) -> bool`: checks if `auto_disabled = 1` AND `disabled_until > now`. If `disabled_until < now`, automatically clears the auto-disable (sets `auto_disabled = 0`).
       d. Add `get_provider_health_history(provider_name: str = None, days: int = 7) -> list[dict]`: query `provider_stats` for daily aggregated success/failure data. This uses the existing `updated_at` timestamps. Returns list of dicts with date, success_count, failure_count, avg_response_time.

    3. In `backend/providers/__init__.py`:
       a. In `_search_provider_with_retry()`, wrap the `provider.search(query)` call with timing:
          ```python
          import time
          start = time.monotonic()
          results = provider.search(query)
          elapsed_ms = (time.monotonic() - start) * 1000
          ```
          Pass `elapsed_ms` to the stats update.
       b. In the `search()` method, when collecting results from futures, pass the response time to `update_provider_stats()`.
       c. In `_init_providers()`, check `is_provider_auto_disabled(name)` before initializing a provider. If auto-disabled, skip with a log message.
       d. Add auto-disable logic: in the `search()` method, after recording a circuit breaker failure, check `consecutive_failures` from stats. If >= `circuit_breaker_failure_threshold * 2` (double the CB threshold), call `auto_disable_provider()` with a configurable cooldown (default 30 minutes, read from settings).

    4. In `backend/routes/providers.py`:
       a. Extend the `provider_stats()` endpoint to include response time data in the performance stats dict.
       b. Add `GET /providers/health` endpoint that returns a health overview: for each provider, return name, healthy (bool), success_rate, avg_response_time_ms, last_response_time_ms, auto_disabled, disabled_until, consecutive_failures. This is a dedicated dashboard-oriented endpoint.
       c. Add `POST /providers/<name>/enable` endpoint to manually re-enable an auto-disabled provider (clears auto_disabled flag).
  </action>
  <verify>
    - `cd backend && python -c "from db.providers import update_provider_stats; update_provider_stats('test', True, 100, response_time_ms=150.5); print('Stats update with response time OK')"`
    - `cd backend && python -c "from db.providers import is_provider_auto_disabled; print('Auto-disable check:', is_provider_auto_disabled('test'))"`
    - `cd backend && python -m pytest tests/ -x -q --timeout=30`
  </verify>
  <done>
    Provider stats track response_time_ms (avg and last). Auto-disable kicks in after sustained failures with configurable cooldown. /providers/health endpoint returns dashboard-ready health data. /providers/<name>/enable allows manual re-enable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend types and Settings page to display provider health metrics</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/pages/Settings.tsx
  </files>
  <action>
    1. In `frontend/src/lib/types.ts`:
       a. Update `ProviderInfo` interface to include stats fields (they are already partially returned by the backend but not typed):
          ```typescript
          export interface ProviderInfo {
            name: string
            enabled: boolean
            initialized: boolean
            healthy: boolean
            message: string
            priority: number
            downloads: number
            config_fields: ProviderConfigField[]
            stats: ProviderHealthStats
          }

          export interface ProviderHealthStats {
            total_searches: number
            successful_downloads: number
            failed_downloads: number
            success_rate: number
            avg_score: number
            consecutive_failures: number
            last_success_at: string | null
            last_failure_at: string | null
            avg_response_time_ms: number
            last_response_time_ms: number
            auto_disabled: boolean
            disabled_until: string
          }
          ```
       b. Update `ProviderStats` to include performance data with response times.

    2. In `frontend/src/pages/Settings.tsx`:
       a. In the `ProviderCard` component, add a health stats section below the existing stats row. Display:
          - **Success rate bar:** Use `stats.success_rate` (0.0-1.0 from backend, already computed). Render as:
            ```tsx
            <div className="flex items-center gap-2">
              <span className="text-xs w-8" style={{ color: 'var(--text-muted)' }}>
                {Math.round(stats.success_rate * 100)}%
              </span>
              <div className="flex-1 h-1.5 rounded-full" style={{ backgroundColor: 'var(--bg-primary)' }}>
                <div
                  className="h-full rounded-full transition-all"
                  style={{
                    width: `${stats.success_rate * 100}%`,
                    backgroundColor: stats.success_rate > 0.8
                      ? 'rgb(16 185 129)'   // emerald-500
                      : stats.success_rate > 0.5
                        ? 'rgb(245 158 11)'  // amber-500
                        : 'rgb(239 68 68)',  // red-500
                  }}
                />
              </div>
            </div>
            ```
          - Average response time (formatted as "XXms") and last response time, shown as compact spans.
          - Auto-disabled badge if provider is auto-disabled: a small red/orange badge with "Disabled until HH:MM" text.
          - Consecutive failures count (only show if > 0): small warning-colored text like "3 consecutive failures".
       b. Add a small "Re-enable" button that appears when a provider is auto-disabled. It calls `POST /providers/<name>/enable` (add this mutation to useApi hooks if not already present, or use a direct fetch call via `apiClient.post`).
       c. Use Tailwind utility classes and CSS custom properties consistent with the existing teal theme. Do not introduce new color variables.
       d. Keep the UI compact -- health stats should fit in 1-2 rows below the existing download/cache stats row.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` (TypeScript compiles without errors)
    - `cd frontend && npm run lint` (no lint errors)
    - Visual: Run `npm run dev` and check the Providers tab in Settings -- each provider should show success rate bar, response time, and health indicators.
  </verify>
  <done>
    Frontend types include provider health stats (response time, auto-disable status). Settings page Providers tab shows per-provider success rate bar (emerald/amber/red), response times, consecutive failures, and auto-disable badge with re-enable button.
  </done>
</task>

</tasks>

<verification>
1. Backend: `cd backend && python -m pytest tests/ -x -q --timeout=30` -- all tests pass.
2. Frontend: `cd frontend && npx tsc --noEmit && npm run lint` -- no errors.
3. API: Start app, `GET /api/v1/providers/health` returns health data for all providers.
4. API: Provider status includes `stats.avg_response_time_ms` and `stats.auto_disabled` fields.
</verification>

<success_criteria>
- provider_stats table has avg_response_time_ms, last_response_time_ms, auto_disabled, disabled_until columns
- Each provider search records response time in stats
- Auto-disable triggers after sustained failures (2x circuit breaker threshold)
- Auto-disable expires after cooldown period
- /providers/health endpoint returns dashboard-ready health data
- /providers/<name>/enable allows manual re-enable
- Frontend displays success rate bar (emerald >80%, amber >50%, red <50%), response times, and auto-disable status per provider
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-provider-plugin-expansion/01-02-SUMMARY.md`
</output>

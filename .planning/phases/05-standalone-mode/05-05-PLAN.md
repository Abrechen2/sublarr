---
phase: 05-standalone-mode
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/api/client.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/pages/Settings.tsx
  - frontend/src/pages/Onboarding.tsx
autonomous: false

must_haves:
  truths:
    - "User can configure watched folders in Settings with add/edit/delete/enable-disable"
    - "Settings shows Library Sources tab with folder management UI"
    - "Onboarding wizard offers a standalone setup path that skips Sonarr/Radarr"
    - "TypeScript types, API client functions, and React Query hooks exist for all standalone endpoints"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "TypeScript interfaces for WatchedFolder, StandaloneSeries, StandaloneMovie, StandaloneStatus"
      contains: "WatchedFolder"
    - path: "frontend/src/api/client.ts"
      provides: "API functions for standalone endpoints"
      contains: "getWatchedFolders"
    - path: "frontend/src/hooks/useApi.ts"
      provides: "React Query hooks for standalone data"
      contains: "useWatchedFolders"
    - path: "frontend/src/pages/Settings.tsx"
      provides: "Library Sources tab with watched folder management"
      contains: "Library Sources"
    - path: "frontend/src/pages/Onboarding.tsx"
      provides: "Standalone setup path in onboarding wizard"
      contains: "standalone"
  key_links:
    - from: "frontend/src/pages/Settings.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useWatchedFolders, useSaveWatchedFolder hooks"
      pattern: "useWatchedFolders"
    - from: "frontend/src/hooks/useApi.ts"
      to: "frontend/src/api/client.ts"
      via: "getWatchedFolders, saveWatchedFolder API functions"
      pattern: "getWatchedFolders"
    - from: "frontend/src/api/client.ts"
      to: "/api/v1/standalone/*"
      via: "axios HTTP calls"
      pattern: "standalone"
---

<objective>
Add TypeScript types, API client functions, React Query hooks, Settings "Library Sources" tab, and Onboarding standalone path.

Purpose: Users need a UI to configure watched folders, see standalone status, and set up Sublarr without Sonarr/Radarr.
Output: Updated `types.ts`, `client.ts`, `useApi.ts`, `Settings.tsx`, `Onboarding.tsx`.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-standalone-mode/05-RESEARCH.md
@.planning/phases/05-standalone-mode/05-04-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/api/client.ts
@frontend/src/hooks/useApi.ts
@frontend/src/pages/Settings.tsx
@frontend/src/pages/Onboarding.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, API client, and React Query hooks</name>
  <files>frontend/src/lib/types.ts, frontend/src/api/client.ts, frontend/src/hooks/useApi.ts</files>
  <action>
  1. In `frontend/src/lib/types.ts`, add these interfaces at the end of the file:

  ```typescript
  // Standalone Mode
  export interface WatchedFolder {
    id: number
    path: string
    label: string
    media_type: 'auto' | 'tv' | 'movie'
    enabled: boolean
    last_scan_at: string
    created_at: string
    updated_at: string
  }

  export interface StandaloneSeries {
    id: number
    title: string
    year: number | null
    folder_path: string
    tmdb_id: number | null
    tvdb_id: number | null
    anilist_id: number | null
    imdb_id: string
    poster_url: string
    is_anime: boolean
    episode_count: number
    season_count: number
    metadata_source: string
    wanted_count?: number  // from joined query
    created_at: string
    updated_at: string
  }

  export interface StandaloneMovie {
    id: number
    title: string
    year: number | null
    file_path: string
    tmdb_id: number | null
    imdb_id: string
    poster_url: string
    metadata_source: string
    wanted?: boolean  // from joined query
    created_at: string
    updated_at: string
  }

  export interface StandaloneStatus {
    enabled: boolean
    watcher_running: boolean
    folders_count: number
    scanner_scanning: boolean
  }

  export interface StandaloneScanResult {
    folders_scanned: number
    series_found: number
    movies_found: number
    wanted_added: number
    duration_seconds: number
  }
  ```

  2. In `frontend/src/api/client.ts`, add API functions at the end (following the existing pattern of `export async function` with axios):

  ```typescript
  // Standalone Mode
  export async function getWatchedFolders(): Promise<WatchedFolder[]> {
    const { data } = await api.get('/standalone/folders')
    return data
  }

  export async function saveWatchedFolder(folder: Partial<WatchedFolder> & { path: string }): Promise<WatchedFolder> {
    if (folder.id) {
      const { data } = await api.put(`/standalone/folders/${folder.id}`, folder)
      return data
    }
    const { data } = await api.post('/standalone/folders', folder)
    return data
  }

  export async function deleteWatchedFolder(folderId: number): Promise<void> {
    await api.delete(`/standalone/folders/${folderId}`)
  }

  export async function getStandaloneSeries(): Promise<StandaloneSeries[]> {
    const { data } = await api.get('/standalone/series')
    return data
  }

  export async function getStandaloneMovies(): Promise<StandaloneMovie[]> {
    const { data } = await api.get('/standalone/movies')
    return data
  }

  export async function triggerStandaloneScan(): Promise<{ message: string }> {
    const { data } = await api.post('/standalone/scan')
    return data
  }

  export async function getStandaloneStatus(): Promise<StandaloneStatus> {
    const { data } = await api.get('/standalone/status')
    return data
  }

  export async function refreshSeriesMetadata(seriesId: number): Promise<void> {
    await api.post(`/standalone/series/${seriesId}/refresh-metadata`)
  }
  ```

  Import the new types at the top of client.ts:
  ```typescript
  import type { WatchedFolder, StandaloneSeries, StandaloneMovie, StandaloneStatus } from '@/lib/types'
  ```

  3. In `frontend/src/hooks/useApi.ts`, add React Query hooks at the end (following existing hook patterns with useQuery/useMutation):

  ```typescript
  // Standalone Mode
  export function useWatchedFolders() {
    return useQuery({ queryKey: ['watchedFolders'], queryFn: getWatchedFolders })
  }

  export function useSaveWatchedFolder() {
    const qc = useQueryClient()
    return useMutation({
      mutationFn: saveWatchedFolder,
      onSuccess: () => { void qc.invalidateQueries({ queryKey: ['watchedFolders'] }) },
    })
  }

  export function useDeleteWatchedFolder() {
    const qc = useQueryClient()
    return useMutation({
      mutationFn: deleteWatchedFolder,
      onSuccess: () => { void qc.invalidateQueries({ queryKey: ['watchedFolders'] }) },
    })
  }

  export function useStandaloneSeries() {
    return useQuery({ queryKey: ['standaloneSeries'], queryFn: getStandaloneSeries })
  }

  export function useStandaloneMovies() {
    return useQuery({ queryKey: ['standaloneMovies'], queryFn: getStandaloneMovies })
  }

  export function useTriggerStandaloneScan() {
    const qc = useQueryClient()
    return useMutation({
      mutationFn: triggerStandaloneScan,
      onSuccess: () => {
        void qc.invalidateQueries({ queryKey: ['standaloneSeries'] })
        void qc.invalidateQueries({ queryKey: ['standaloneMovies'] })
      },
    })
  }

  export function useStandaloneStatus() {
    return useQuery({ queryKey: ['standaloneStatus'], queryFn: getStandaloneStatus, refetchInterval: 10000 })
  }

  export function useRefreshSeriesMetadata() {
    const qc = useQueryClient()
    return useMutation({
      mutationFn: refreshSeriesMetadata,
      onSuccess: () => { void qc.invalidateQueries({ queryKey: ['standaloneSeries'] }) },
    })
  }
  ```

  Import the API functions at the top of useApi.ts alongside the existing imports:
  ```typescript
  import { getWatchedFolders, saveWatchedFolder, deleteWatchedFolder, getStandaloneSeries, getStandaloneMovies, triggerStandaloneScan, getStandaloneStatus, refreshSeriesMetadata } from '@/api/client'
  ```
  </action>
  <verify>
  ```bash
  cd frontend && npx tsc --noEmit 2>&1 | head -20
  ```
  If TypeScript compilation has errors, they should only be pre-existing ones (not related to new standalone types). Check specifically that the new types, client functions, and hooks have no type errors.
  </verify>
  <done>TypeScript interfaces (WatchedFolder, StandaloneSeries, StandaloneMovie, StandaloneStatus) defined. API client has 8 standalone functions. React Query hooks provide useWatchedFolders, useSaveWatchedFolder, useDeleteWatchedFolder, useStandaloneSeries, useStandaloneMovies, useTriggerStandaloneScan, useStandaloneStatus, useRefreshSeriesMetadata.</done>
</task>

<task type="auto">
  <name>Task 2: Settings Library Sources tab and Onboarding standalone path</name>
  <files>frontend/src/pages/Settings.tsx, frontend/src/pages/Onboarding.tsx</files>
  <action>
  1. In `frontend/src/pages/Settings.tsx`:

  a) Add 'Library Sources' to the TABS array, positioned AFTER 'Radarr' and BEFORE 'Media Servers':
  ```typescript
  const TABS = [
    'General',
    'Translation',
    'Translation Backends',
    'Languages',
    'Automation',
    'Wanted',
    'Providers',
    'Sonarr',
    'Radarr',
    'Library Sources',  // NEW
    'Media Servers',
    'Whisper',
    'Notifications',
    'Prompt Presets',
  ]
  ```

  b) Add standalone config fields to the FIELDS array (for the General or a Library Sources section):
  ```typescript
  // Library Sources (Standalone Mode)
  { key: 'standalone_enabled', label: 'Enable Standalone Mode', type: 'text', placeholder: 'false', tab: 'Library Sources' },
  { key: 'tmdb_api_key', label: 'TMDB API Key (Bearer Token)', type: 'password', tab: 'Library Sources' },
  { key: 'tvdb_api_key', label: 'TVDB API Key (Optional)', type: 'password', tab: 'Library Sources' },
  { key: 'tvdb_pin', label: 'TVDB PIN (Optional)', type: 'password', tab: 'Library Sources' },
  { key: 'standalone_scan_interval_hours', label: 'Scan Interval (hours, 0=disabled)', type: 'number', placeholder: '6', tab: 'Library Sources' },
  { key: 'standalone_debounce_seconds', label: 'File Detection Debounce (seconds)', type: 'number', placeholder: '10', tab: 'Library Sources' },
  ```

  c) Add imports for the new hooks at the top (alongside existing useApi imports):
  ```typescript
  useWatchedFolders, useSaveWatchedFolder, useDeleteWatchedFolder, useTriggerStandaloneScan, useStandaloneStatus,
  ```

  d) In the component body, add the Library Sources tab content. When `activeTab === 'Library Sources'`, render:

  - The standard config fields (standalone_enabled, tmdb_api_key, etc.) using the existing field rendering pattern
  - A "Watched Folders" section below the config fields, with:
    * A header row: "Watched Folders" with an "Add Folder" button (Plus icon)
    * List of configured folders, each showing:
      - Path (text, editable)
      - Label (text, optional)
      - Media Type dropdown (auto/tv/movie)
      - Enabled toggle
      - Last scan timestamp
      - Delete button (Trash2 icon)
    * "Scan All Folders" button (RefreshCw icon) that triggers useTriggerStandaloneScan
    * Status indicator showing watcher running state from useStandaloneStatus

  Use the same styling patterns as the Media Servers tab (collapsible cards are not needed here -- a simple list is more appropriate for folders). Each folder row should have:
  - Path input (text, full width, monospace font)
  - Label input (shorter)
  - Media type select dropdown
  - Enabled checkbox/toggle
  - Delete button

  For adding a new folder: inline form at the bottom of the list (same pattern as Sonarr instances) with path and label inputs, a Save button, and a Cancel button.

  Style using existing CSS variables: `var(--bg-primary)`, `var(--bg-secondary)`, `var(--border)`, `var(--text-primary)`, `var(--text-secondary)`, `var(--teal)`.

  2. In `frontend/src/pages/Onboarding.tsx`:

  a) Modify the STEPS array to add a standalone option. Insert a new first step that lets the user choose their setup path:

  Replace the current STEPS with:
  ```typescript
  const STEPS = [
    { title: 'Setup Mode', icon: Server, description: 'Choose how you want to use Sublarr.' },
    { title: 'Sonarr / Radarr', icon: Server, description: 'Connect your *arr instances to detect missing subtitles.' },
    { title: 'Standalone Folders', icon: FolderOpen, description: 'Point Sublarr at your media folders directly.' },
    { title: 'Path Mapping', icon: Globe, description: 'Map remote paths to local paths (if *arr runs on a different host).' },
    { title: 'Providers', icon: Search, description: 'Configure subtitle provider API keys for searching.' },
    { title: 'Ollama', icon: Cpu, description: 'Set up the LLM translation backend.' },
    { title: 'Media Servers (Optional)', icon: Monitor, description: 'Configure media servers for automatic library refresh after subtitle downloads.' },
    { title: 'First Scan', icon: Play, description: 'Run your first wanted scan to find missing subtitles.' },
  ]
  ```

  Import `FolderOpen` from lucide-react.

  b) Add state for setup mode:
  ```typescript
  const [setupMode, setSetupMode] = useState<'arr' | 'standalone' | null>(null)
  ```

  c) Step 0 (Setup Mode) renders two large cards:
  - **"Sonarr / Radarr Mode"** -- "Use with Sonarr and/or Radarr for automatic media detection" -- sets setupMode to 'arr'
  - **"Standalone Mode"** -- "Point at media folders directly, no Sonarr/Radarr needed" -- sets setupMode to 'standalone'

  Both cards have a teal border on hover and show a CheckCircle when selected.

  d) Step navigation logic:
  - If setupMode is 'arr': show steps 1 (Sonarr/Radarr), 3 (Path Mapping), 4 (Providers), 5 (Ollama), 6 (Media Servers), 7 (First Scan) -- skip step 2
  - If setupMode is 'standalone': show steps 2 (Standalone Folders), 4 (Providers), 5 (Ollama), 6 (Media Servers), 7 (First Scan) -- skip steps 1 and 3

  Implement this by computing `visibleSteps` based on setupMode and mapping step indices.

  e) Step 2 (Standalone Folders) renders:
  - TMDB API Key input (required for metadata)
  - TVDB API Key input (optional)
  - Folder path input with "Add Folder" button
  - List of added folders with delete buttons
  - On save: send standalone_enabled=true, tmdb_api_key, tvdb_api_key to config, and POST each folder to /api/v1/standalone/folders

  f) On the First Scan step, if setupMode is 'standalone', trigger standalone scan instead of wanted scan.
  </action>
  <verify>
  ```bash
  cd frontend && npm run lint 2>&1 | tail -20 && npx tsc --noEmit 2>&1 | tail -20
  ```
  Verify no new lint errors or TypeScript errors from the standalone additions.
  </verify>
  <done>Settings.tsx has "Library Sources" tab with standalone config fields and watched folder management UI (add/edit/delete/scan). Onboarding.tsx offers Setup Mode choice between Sonarr/Radarr and Standalone, with standalone path skipping *arr steps and showing folder configuration instead.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete standalone mode frontend: Settings "Library Sources" tab with watched folder management and Onboarding standalone setup path</what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev` (from project root)
    2. Navigate to http://localhost:5173/settings
    3. Click the "Library Sources" tab
    4. Verify you see: standalone_enabled toggle, TMDB API Key field, TVDB fields, scan interval, debounce
    5. Verify "Watched Folders" section with Add Folder button appears
    6. Navigate to http://localhost:5173/onboarding
    7. Verify first step shows "Setup Mode" with two cards: "Sonarr / Radarr Mode" and "Standalone Mode"
    8. Click "Standalone Mode" card -- verify it navigates to folder setup step (not Sonarr step)
    9. Click "Sonarr / Radarr Mode" card -- verify it navigates to Sonarr step (not folder step)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` has no new errors from standalone additions
- `cd frontend && npm run lint` has no new lint errors
- Settings page shows "Library Sources" tab
- Onboarding shows Setup Mode choice
- All standalone API hooks and client functions are typed correctly
</verification>

<success_criteria>
1. TypeScript interfaces for WatchedFolder, StandaloneSeries, StandaloneMovie, StandaloneStatus exist in types.ts
2. API client has functions for all standalone endpoints (folders CRUD, series/movies list, scan trigger, status)
3. React Query hooks wrap all API functions with proper cache invalidation
4. Settings "Library Sources" tab shows standalone config fields and watched folder management
5. Onboarding wizard has Setup Mode step with arr/standalone choice, standalone path skips Sonarr/Radarr
</success_criteria>

<output>
After completion, create `.planning/phases/05-standalone-mode/05-05-SUMMARY.md`
</output>

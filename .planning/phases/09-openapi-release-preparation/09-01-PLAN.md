---
phase: 09-openapi-release-preparation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/version.py
  - backend/openapi.py
  - backend/app.py
  - backend/routes/__init__.py
  - backend/routes/system.py
  - backend/routes/translate.py
  - backend/routes/providers.py
  - backend/routes/wanted.py
  - backend/routes/library.py
  - backend/routes/config.py
  - backend/requirements.txt
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/openapi.json returns a valid OpenAPI 3.0.3 spec with paths for all documented endpoints"
    - "GET /api/docs loads Swagger UI and renders interactive API documentation"
    - "Version string is centralized in version.py and used consistently in health, openapi spec, and system info"
  artifacts:
    - path: "backend/version.py"
      provides: "Centralized version string"
      contains: "__version__"
    - path: "backend/openapi.py"
      provides: "APISpec instance and register_all_paths helper"
      contains: "register_all_paths"
    - path: "backend/routes/system.py"
      provides: "OpenAPI JSON endpoint and Swagger UI registration"
      contains: "openapi.json"
  key_links:
    - from: "backend/openapi.py"
      to: "backend/app.py"
      via: "register_all_paths called in create_app after register_blueprints"
      pattern: "register_all_paths"
    - from: "backend/routes/system.py"
      to: "backend/openapi.py"
      via: "import spec for /openapi.json endpoint"
      pattern: "from openapi import spec"
---

<objective>
Set up OpenAPI infrastructure (apispec + flask-swagger-ui), centralize version string, add Swagger UI at /api/docs, and document the 6 highest-priority Blueprints with YAML docstrings (system, translate, providers, wanted, library, config -- ~66 endpoints).

Purpose: Establish the API documentation foundation so all endpoints are discoverable via Swagger UI. The HIGH-priority blueprints cover the core feature set that community users interact with most.

Output: version.py, openapi.py, Swagger UI at /api/docs, /api/v1/openapi.json endpoint, YAML docstrings on ~66 endpoints across 6 blueprints.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-openapi-release-preparation/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version.py, openapi.py, install dependencies, wire into app factory</name>
  <files>
    backend/version.py
    backend/openapi.py
    backend/app.py
    backend/routes/__init__.py
    backend/routes/system.py
    backend/requirements.txt
  </files>
  <action>
1. Create `backend/version.py` with `__version__ = "0.9.0-beta"`.

2. Add `apispec>=6.9.0`, `apispec-webframeworks>=1.3.0`, `flask-swagger-ui>=5.21.0` to `backend/requirements.txt`.

3. Create `backend/openapi.py`:
   - Import APISpec from apispec, FlaskPlugin from apispec_webframeworks.flask
   - Import __version__ from version
   - Create spec instance: title="Sublarr API", version=__version__, openapi_version="3.0.3", info with description ("Standalone Subtitle Manager & Translator for Anime/Media") and GPL-3.0 license, plugins=[FlaskPlugin()]
   - Add security scheme for X-Api-Key header (apiKeyAuth, in: header, name: X-Api-Key)
   - Create `register_all_paths(app)` function that iterates `app.view_functions` within `app.test_request_context()`, skipping "static" and functions without "---" in docstring, calling `spec.path(view=fn)` with try/except for each

4. Update `backend/routes/system.py`:
   - Import __version__ from version
   - Replace all 3 hardcoded "0.1.0" version strings with __version__
   - Add GET `/openapi.json` endpoint that returns `jsonify(spec.to_dict())` importing spec from openapi module

5. Update `backend/app.py` create_app():
   - After `register_blueprints(app)`, call `register_all_paths(app)` from openapi module
   - Register flask-swagger-ui blueprint: `get_swaggerui_blueprint("/api/docs", "/api/v1/openapi.json", config={"app_name": "Sublarr API", "layout": "BaseLayout"})`, register on app

6. Update `backend/routes/__init__.py`:
   - No changes needed (Swagger UI blueprint registered in app.py, not here)

Note: The spec object is a module-level singleton. register_all_paths must be called AFTER register_blueprints and WITHIN app context to discover all views. Use try/except around each spec.path() call to skip views that fail parsing.
  </action>
  <verify>
Run: `cd backend && python -c "from app import create_app; app = create_app(); client = app.test_client(); resp = client.get('/api/v1/openapi.json'); data = resp.get_json(); print(f'Status: {resp.status_code}'); print(f'Title: {data.get(\"info\", {}).get(\"title\", \"MISSING\")}'); print(f'Version: {data.get(\"info\", {}).get(\"version\", \"MISSING\")}'); print(f'Paths: {len(data.get(\"paths\", {}))}')"`

Expected: Status 200, Title "Sublarr API", Version "0.9.0-beta", Paths > 0. Also verify /api/docs returns 200 (Swagger UI HTML).
  </verify>
  <done>
  - version.py exists with __version__ = "0.9.0-beta"
  - openapi.py exists with spec instance and register_all_paths()
  - /api/v1/openapi.json returns valid OpenAPI 3.0.3 spec
  - /api/docs serves Swagger UI
  - All 3 hardcoded "0.1.0" in system.py replaced with __version__
  - Requirements updated with 3 new packages
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OpenAPI YAML docstrings to HIGH-priority Blueprints (system, translate, providers, wanted, library, config)</name>
  <files>
    backend/routes/system.py
    backend/routes/translate.py
    backend/routes/providers.py
    backend/routes/wanted.py
    backend/routes/library.py
    backend/routes/config.py
  </files>
  <action>
Add YAML docstrings to all view functions in the 6 HIGH-priority blueprints. Each docstring follows this pattern:

```python
def endpoint_name():
    """One-line summary.
    ---
    get:  # or post/put/delete matching the route method
      tags:
        - TagName  # Blueprint name (System, Translate, Providers, Wanted, Library, Config)
      summary: Brief description
      description: Detailed description if needed
      parameters:  # if query params or path params exist
        - in: query/path
          name: param_name
          schema:
            type: string/integer/boolean
          required: true/false
          description: What this param does
      requestBody:  # if POST/PUT with JSON body
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                field_name:
                  type: string
                  description: Field description
      responses:
        200:
          description: Success description
          content:
            application/json:
              schema:
                type: object
                properties:
                  key:
                    type: string
        400:
          description: Bad request
        401:
          description: Unauthorized (API key required)
        404:
          description: Not found
    """
```

**Blueprint-specific guidance:**

**system.py (~20 endpoints):** Tags: System. Include health, health/detailed, stats, version, backup endpoints, logs, tasks. Mark health endpoints as not requiring auth. The openapi.json endpoint itself does NOT need a docstring (it serves the spec).

**translate.py (~14 endpoints):** Tags: Translate. Document POST /translate, /translate/sync, GET /status/{id}, /jobs, /batch, retranslate endpoints. Include request body schemas for translate (file_path, source_language, target_language). Note that translate returns a job_id for async processing.

**providers.py (~7 endpoints):** Tags: Providers. Document GET /providers, POST /providers/test/{name}, /providers/search. Search endpoint has complex request body (series_title, season, episode, etc.).

**wanted.py (~11 endpoints):** Tags: Wanted. Document GET /wanted (paginated), POST /wanted/{id}/search, /wanted/{id}/process, /wanted/batch-search, /wanted/refresh. Include pagination params (page, per_page, sort, direction).

**library.py (~7 endpoints):** Tags: Library. Document GET /library (list series/movies), /library/{type}/{id} (detail), stats endpoint.

**config.py (~7 endpoints):** Tags: Config. Document GET /config, PUT /config, /config/import, /config/export. PUT /config accepts partial key-value updates.

**Important:** Do NOT modify any function logic. Only add/modify the docstring. Keep the `---` separator between the human-readable summary and YAML block. Use consistent 4-space or 2-space indentation in YAML (be consistent within each docstring). For endpoints that accept multiple HTTP methods, document each method in the YAML.

For response schemas, document at minimum: status codes and top-level response shape. Detailed nested schemas can use `type: object` with `additionalProperties: true` for complex responses -- don't try to document every nested field.
  </action>
  <verify>
Run: `cd backend && python -c "from app import create_app; app = create_app(); client = app.test_client(); resp = client.get('/api/v1/openapi.json'); data = resp.get_json(); paths = data.get('paths', {}); print(f'Total paths: {len(paths)}'); tags = set(); [tags.update(op.get('tags', []) for method_info in v.values() if isinstance(method_info, dict) for op in [method_info]) for v in paths.values()]; print(f'Tags found: {sorted(tags)}')"`

Expected: Total paths >= 50 (covering the 6 HIGH-priority blueprints), Tags include System, Translate, Providers, Wanted, Library, Config.
  </verify>
  <done>
  - All ~66 endpoints across system, translate, providers, wanted, library, config have YAML docstrings
  - /api/v1/openapi.json paths count >= 50
  - Tags System, Translate, Providers, Wanted, Library, Config present in spec
  - No functional code changes -- only docstrings modified
  </done>
</task>

</tasks>

<verification>
1. `curl http://localhost:5765/api/v1/openapi.json | python -m json.tool` returns valid JSON with OpenAPI 3.0.3 structure
2. `curl -s http://localhost:5765/api/docs` returns HTML containing "swagger-ui"
3. Health endpoint shows version "0.9.0-beta"
4. Spec paths count covers HIGH-priority blueprints (>= 50 paths)
5. `cd backend && python -m pytest tests/ -x -q` passes (no regressions)
</verification>

<success_criteria>
- OpenAPI spec served at /api/v1/openapi.json with 50+ paths documented
- Swagger UI accessible at /api/docs with interactive documentation
- Version centralized to single source (version.py) used by health, openapi, and system info endpoints
- All 6 HIGH-priority blueprint endpoints have YAML docstrings with tags, summary, parameters, and response codes
</success_criteria>

<output>
After completion, create `.planning/phases/09-openapi-release-preparation/09-01-SUMMARY.md`
</output>

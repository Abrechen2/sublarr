---
phase: 00-architecture-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - backend/extensions.py
  - backend/app.py
  - backend/routes/__init__.py
  - backend/routes/translate.py
  - backend/routes/providers.py
  - backend/routes/library.py
  - backend/routes/wanted.py
  - backend/routes/config.py
  - backend/routes/webhooks.py
  - backend/routes/system.py
  - backend/routes/profiles.py
  - backend/routes/blacklist.py
autonomous: true

must_haves:
  truths:
    - "Application starts via create_app() factory function in app.py"
    - "SocketIO is initialized via init_app() pattern, not module-level binding"
    - "All 67 routes from server.py are distributed across 9 Blueprint files"
    - "Each Blueprint uses url_prefix='/api/v1'"
    - "Shared mutable state (batch_state, wanted_batch_state, _memory_stats) lives in its owning route module"
    - "SocketIO events (connect/disconnect) are registered inside create_app()"
    - "Logging setup (StructuredJSONFormatter, SocketIOLogHandler, file handler) happens inside create_app()"
    - "Schedulers (wanted_scanner, backup) start inside create_app() with testing guard"
    - "App-level routes (/metrics, SPA fallback) are registered in app.py"
  artifacts:
    - path: "backend/extensions.py"
      provides: "Unbound SocketIO instance for import by route modules and app.py"
      contains: "socketio = SocketIO()"
    - path: "backend/app.py"
      provides: "create_app() factory, _setup_logging(), _register_app_routes(), _start_schedulers()"
      contains: "def create_app"
    - path: "backend/routes/__init__.py"
      provides: "register_blueprints() helper that imports and registers all 9 blueprints"
      contains: "def register_blueprints"
    - path: "backend/routes/translate.py"
      provides: "translate blueprint with /translate, /translate/sync, /status/<id>, /jobs, /batch, /batch/status, /retranslate/* routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/providers.py"
      provides: "providers blueprint with /providers, /providers/test/<name>, /providers/search, /providers/stats, /providers/cache/clear routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/library.py"
      provides: "library blueprint with /library, /library/series/<id>, /sonarr/*, /radarr/*, /episodes/* routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/wanted.py"
      provides: "wanted blueprint with /wanted, /wanted/summary, /wanted/refresh, /wanted/<id>/*, /wanted/batch-search/*, /wanted/search-all routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/config.py"
      provides: "config blueprint with /config, /settings/*, /onboarding/*, /config/export, /config/import routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/webhooks.py"
      provides: "webhooks blueprint with /webhook/sonarr, /webhook/radarr routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/system.py"
      provides: "system blueprint with /health, /health/detailed, /stats, /database/*, /logs, /notifications/* routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/profiles.py"
      provides: "profiles blueprint with /language-profiles/*, /glossary/*, /prompt-presets/* routes"
      contains: "bp = Blueprint"
    - path: "backend/routes/blacklist.py"
      provides: "blacklist blueprint with /blacklist/*, /history/* routes"
      contains: "bp = Blueprint"
  key_links:
    - from: "backend/app.py"
      to: "backend/extensions.py"
      via: "from extensions import socketio"
      pattern: "from extensions import socketio"
    - from: "backend/app.py"
      to: "backend/routes/__init__.py"
      via: "from routes import register_blueprints"
      pattern: "register_blueprints\\(app\\)"
    - from: "backend/routes/translate.py"
      to: "backend/extensions.py"
      via: "from extensions import socketio"
      pattern: "from extensions import socketio"
    - from: "backend/routes/translate.py"
      to: "backend/db/jobs.py"
      via: "from db.jobs import create_job"
      pattern: "from db\\.jobs import"
    - from: "backend/app.py"
      to: "backend/db/__init__.py"
      via: "from db import init_db"
      pattern: "from db import init_db"
---

<objective>
Create the Application Factory pattern: extensions.py (unbound SocketIO), app.py (create_app() factory), and routes/ package (9 Blueprint files extracted from server.py's 67 routes).

Purpose: Fulfill ARCH-01 (Application Factory), ARCH-02 (Blueprint routing). server.py is not deleted yet -- Plan 03 handles cleanup.
Output: `backend/extensions.py`, `backend/app.py`, `backend/routes/` package with 9 blueprint files.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-architecture-refactoring/00-CONTEXT.md
@.planning/phases/00-architecture-refactoring/00-RESEARCH.md
@.planning/phases/00-architecture-refactoring/00-01-SUMMARY.md
@backend/server.py
@backend/auth.py
@backend/error_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extensions.py and app.py with factory function</name>
  <files>
    backend/extensions.py
    backend/app.py
  </files>
  <action>
**extensions.py** -- Minimal file:
```python
from flask_socketio import SocketIO
socketio = SocketIO()
```
That's it. No app binding. Route modules and app.py both import `socketio` from here.

**app.py** -- Create the `create_app()` factory function following the research pattern (RESEARCH.md Pattern 1). Include:

1. `LOG_FORMAT` constant (moved from server.py line 45)
2. `StructuredJSONFormatter` class (moved from server.py lines 59-86)
3. `_has_app_context()` helper (moved from server.py lines 89-95)
4. `SocketIOLogHandler` class (moved from server.py lines 98-106). Modify to accept `socketio` as constructor parameter: `def __init__(self, sio): self.sio = sio` and use `self.sio.emit()` in `emit()`.
5. `_setup_logging(settings)` function (adapted from server.py lines 109-138). Takes settings as argument instead of using module-level variable. Creates SocketIOLogHandler with `socketio` from extensions.
6. `create_app(testing=False)` function following this order:
   a. `app = Flask(__name__, static_folder="static", static_url_path="")`
   b. Load config: `from config import get_settings, reload_settings`
   c. Call `_setup_logging(settings)`
   d. `socketio.init_app(app, cors_allowed_origins="*", async_mode="threading")`
   e. Register error handlers: `from error_handler import register_error_handlers; register_error_handlers(app)`
   f. Initialize auth: `from auth import init_auth; init_auth(app)`
   g. Initialize database: `from db import init_db; init_db()`
   h. Apply DB config overrides: `from db.config import get_all_config_entries` then `reload_settings(overrides)` if any
   i. Bazarr deprecation warning (from server.py lines 161-165)
   j. Register blueprints: `from routes import register_blueprints; register_blueprints(app)`
   k. Register app-level routes: `_register_app_routes(app)`
   l. Register SocketIO events (connect/disconnect -- trivial, just debug logs)
   m. Start schedulers if not testing: `_start_schedulers(settings)`
   n. Return `app`
7. `_register_app_routes(app)` -- Move /metrics and SPA fallback from server.py (lines 2582-2612)
8. `_start_schedulers(settings)` -- Move wanted_scanner and backup scheduler init from server.py (lines 168-177)
9. `if __name__ == "__main__":` block -- `app = create_app(); socketio.run(app, host="0.0.0.0", port=get_settings().port, debug=True, allow_unsafe_werkzeug=True)`

CRITICAL: Use deferred imports inside create_app() for everything except Flask and extensions -- prevents circular imports. The research explicitly recommends this (Pitfall 1).

CRITICAL: Do NOT use `global settings` anywhere. Every route handler calls `get_settings()` at execution time. The `_setup_logging()` and `_start_schedulers()` receive settings as a parameter because they run once during startup.
  </action>
  <verify>
Run from backend/:
```bash
python -c "from extensions import socketio; print('extensions OK')"
python -c "from app import create_app; print('create_app importable')"
```
  </verify>
  <done>
extensions.py exports unbound SocketIO instance. app.py exports create_app() factory function with logging, error handling, auth, database init, config overrides, blueprint registration, app-level routes, SocketIO events, and schedulers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create routes/ package with 9 Blueprint files</name>
  <files>
    backend/routes/__init__.py
    backend/routes/translate.py
    backend/routes/providers.py
    backend/routes/library.py
    backend/routes/wanted.py
    backend/routes/config.py
    backend/routes/webhooks.py
    backend/routes/system.py
    backend/routes/profiles.py
    backend/routes/blacklist.py
  </files>
  <action>
Create the `backend/routes/` package directory.

**routes/__init__.py** -- Contains `register_blueprints(app)` that imports all 9 blueprints using deferred imports and registers them:
```python
def register_blueprints(app):
    from routes.translate import bp as translate_bp
    from routes.providers import bp as providers_bp
    # ... all 9
    for blueprint in [translate_bp, providers_bp, ...]:
        app.register_blueprint(blueprint)
```

**Each route file** follows this pattern:
```python
import logging
from flask import Blueprint, request, jsonify

bp = Blueprint("{name}", __name__, url_prefix="/api/v1")
logger = logging.getLogger(__name__)

@bp.route("/...", methods=["..."])
def handler():
    # Use deferred imports for db, config, etc.
    from config import get_settings
    from db.jobs import create_job
    ...
```

Extract routes from server.py into blueprints per the CONTEXT.md mapping:

**routes/translate.py** (server.py lines ~447-717, ~2108-2243):
- Routes: /translate POST, /translate/sync POST, /status/<job_id> GET, /jobs GET, /jobs/<job_id>/retry POST, /batch POST, /batch/status GET, /retranslate/status GET, /retranslate/<job_id> POST, /retranslate/batch POST
- Include: `batch_state`, `batch_lock`, `_memory_stats`, `stats_lock` (owned state)
- Include: `_update_stats()`, `_run_job()`, `_build_arr_context()`, `_validate_callback_url()`, `_send_callback()` helper functions
- Import `socketio` from `extensions` for emit calls (batch_progress, job_update, etc.)
- Import db functions from `db.jobs` (create_job, update_job, get_job, get_jobs, get_pending_job_count, record_stat)
- Import `translate_file`, `scan_directory` from `translator`
- Import `check_ollama_health` from `ollama_client` (for batch progress)
- Replace `global settings` with `get_settings()` calls inside handlers

**routes/providers.py** (server.py lines ~1031-1234):
- Routes: /providers GET, /providers/test/<name> POST, /providers/search POST, /providers/stats GET, /providers/cache/clear POST
- Import `from providers import get_provider_manager`
- Import db functions from `db.providers` (get_provider_cache_stats, get_provider_download_stats, get_provider_stats, get_provider_success_rate, clear_provider_cache)

**routes/library.py** (server.py lines ~833-929, ~2268-2347):
- Routes: /library GET, /library/series/<series_id> GET, /sonarr/instances GET, /sonarr/instances/test POST, /radarr/instances GET, /radarr/instances/test POST, /episodes/<episode_id>/search POST, /episodes/<episode_id>/history GET
- Import from `sonarr_client`, `radarr_client` (deferred)
- Import db functions from `db.library`, `db.profiles`, `db.wanted`, `db.cache`

**routes/wanted.py** (server.py lines ~1593-1975):
- Routes: /wanted GET, /wanted/summary GET, /wanted/refresh POST, /wanted/<item_id>/status PUT, /wanted/<item_id> DELETE, /wanted/<item_id>/search POST, /wanted/<item_id>/process POST, /wanted/batch-search POST, /wanted/batch-search/status GET, /wanted/search-all POST, /wanted/<item_id>/extract POST
- Include: `wanted_batch_state`, `wanted_batch_lock` (owned state)
- Import db functions from `db.wanted`
- Import `socketio` from `extensions`

**routes/config.py** (server.py lines ~755-832, ~2244-2267, ~2377-2437):
- Routes: /config GET, /config PUT, /settings/path-mapping/test POST, /onboarding/status GET, /onboarding/complete POST, /config/export GET, /config/import POST
- Import `from config import get_settings, reload_settings, map_path`
- Import db functions from `db.config`

**routes/webhooks.py** (server.py lines ~1975-2085):
- Routes: /webhook/sonarr POST, /webhook/radarr POST
- Import `socketio` from `extensions`
- Import db functions from `db.wanted`, `db.jobs`

**routes/system.py** (server.py lines ~289-453, ~729-754, ~2438-2582):
- Routes: /health GET, /health/detailed GET, /stats GET, /database/health GET, /database/backup POST, /database/backups GET, /database/restore POST, /database/vacuum POST, /logs GET, /notifications/test POST, /notifications/status GET
- Import from `ollama_client`, `database_health`, `database_backup`, `notifier`
- Import db functions from `db.jobs` (get_stats_summary)

**routes/profiles.py** (server.py lines ~1320-1506):
- Routes: /language-profiles GET/POST, /language-profiles/<id> PUT/DELETE, /language-profiles/assign PUT, /glossary GET/POST, /glossary/<id> PUT/DELETE, /prompt-presets GET/POST, /prompt-presets/default GET, /prompt-presets/<id> PUT/DELETE
- Import db functions from `db.profiles`, `db.translation`

**routes/blacklist.py** (server.py lines ~1236-1318):
- Routes: /blacklist GET/POST/DELETE, /blacklist/<id> DELETE, /blacklist/count GET, /history GET, /history/stats GET
- Import db functions from `db.blacklist`, `db.library`

CRITICAL RULES:
1. Copy route handler bodies EXACTLY from server.py. Do NOT rewrite logic.
2. Replace `global settings` pattern with `settings = get_settings()` calls inside handler bodies.
3. Use `from extensions import socketio` (not `from server import socketio`).
4. Use `from db.{module} import {function}` (not `from database import`).
5. Keep deferred imports inside handler functions for heavy modules (translator, sonarr_client, etc.) -- the codebase already does this extensively.
6. The `_map_path()` helper used by several routes becomes `from config import map_path` (it's just a delegate).
7. Do NOT include `require_api_key` decorator on routes -- auth is handled by `before_request` hook in `init_auth()`.

Do NOT delete server.py yet -- Plan 03 handles cleanup.
  </action>
  <verify>
Run from backend/:
```bash
python -c "
from routes import register_blueprints
from app import create_app
app = create_app(testing=True)
rules = [rule.rule for rule in app.url_map.iter_rules()]
# Verify key routes exist
assert '/api/v1/health' in rules, 'Missing /health'
assert '/api/v1/translate' in rules, 'Missing /translate'
assert '/api/v1/providers' in rules, 'Missing /providers'
assert '/api/v1/wanted' in rules, 'Missing /wanted'
assert '/api/v1/config' in rules, 'Missing /config'
assert '/api/v1/library' in rules, 'Missing /library'
assert '/api/v1/webhook/sonarr' in rules, 'Missing /webhook/sonarr'
assert '/api/v1/language-profiles' in rules, 'Missing /language-profiles'
assert '/api/v1/blacklist' in rules, 'Missing /blacklist'
assert '/metrics' in rules, 'Missing /metrics'
print(f'All routes registered: {len(rules)} total')
"
```
  </verify>
  <done>
9 Blueprint files exist in routes/ with all 67+ routes extracted from server.py. register_blueprints() registers all of them. create_app() produces a working Flask app with all routes accessible at the same URL paths as before.
  </done>
</task>

</tasks>

<verification>
1. `from extensions import socketio` works
2. `from app import create_app` works
3. `create_app(testing=True)` returns a Flask app
4. All 67+ API routes are registered at their original URL paths
5. /metrics and SPA fallback routes exist on the app directly
6. SocketIO connect/disconnect events are registered
7. No route uses `global settings` -- all use `get_settings()` calls
8. No route imports from `server` -- all use `extensions` and `db.*`
</verification>

<success_criteria>
- backend/extensions.py exports unbound SocketIO instance
- backend/app.py exports create_app() factory function
- backend/routes/ contains __init__.py + 9 Blueprint files
- All routes from server.py are present in the new Blueprint files
- create_app(testing=True) produces a fully configured app
- No module-level app or socketio binding (factory pattern only)
</success_criteria>

<output>
After completion, create `.planning/phases/00-architecture-refactoring/00-02-SUMMARY.md`
</output>

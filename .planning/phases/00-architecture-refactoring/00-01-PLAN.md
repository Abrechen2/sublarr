---
phase: 00-architecture-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/__init__.py
  - backend/db/jobs.py
  - backend/db/config.py
  - backend/db/providers.py
  - backend/db/library.py
  - backend/db/wanted.py
  - backend/db/blacklist.py
  - backend/db/profiles.py
  - backend/db/translation.py
  - backend/db/cache.py
autonomous: true

must_haves:
  truths:
    - "All database functions from database.py are accessible via db/ package modules"
    - "Database connection uses the same thread-safe singleton pattern (_db_lock + global _connection)"
    - "Schema DDL and migrations live in db/__init__.py"
    - "Each domain module imports get_db and _db_lock from db package"
  artifacts:
    - path: "backend/db/__init__.py"
      provides: "get_db(), close_db(), init_db(), _db_lock, SCHEMA, _run_migrations"
      contains: "def get_db"
    - path: "backend/db/jobs.py"
      provides: "create_job, update_job, get_job, get_jobs, get_pending_job_count, record_stat, get_stats_summary, get_outdated_jobs_count, get_outdated_jobs"
      contains: "def create_job"
    - path: "backend/db/config.py"
      provides: "save_config_entry, get_config_entry, get_all_config_entries"
      contains: "def save_config_entry"
    - path: "backend/db/providers.py"
      provides: "cache_provider_results, get_cached_results, cleanup_expired_cache, get_provider_cache_stats, get_provider_download_stats, clear_provider_cache, record_subtitle_download, update_provider_stats, get_provider_stats, get_provider_success_rate"
      contains: "def cache_provider_results"
    - path: "backend/db/library.py"
      provides: "record_subtitle_download (alias if needed), get_download_history, get_download_stats, record_upgrade, get_upgrade_history, get_upgrade_stats"
      contains: "def get_download_history"
    - path: "backend/db/wanted.py"
      provides: "upsert_wanted_item, get_wanted_items, get_wanted_item, update_wanted_status, update_wanted_search, delete_wanted_items, delete_wanted_item, get_wanted_count, get_wanted_summary, get_all_wanted_file_paths, get_wanted_items_for_cleanup, delete_wanted_items_by_ids, get_wanted_item_by_path, get_upgradeable_count, find_wanted_by_episode"
      contains: "def upsert_wanted_item"
    - path: "backend/db/blacklist.py"
      provides: "add_blacklist_entry, remove_blacklist_entry, clear_blacklist, is_blacklisted, get_blacklist_entries, get_blacklist_count"
      contains: "def add_blacklist_entry"
    - path: "backend/db/profiles.py"
      provides: "create_language_profile, get_language_profile, get_all_language_profiles, update_language_profile, delete_language_profile, get_default_profile, get_series_profile, get_movie_profile, assign_series_profile, assign_movie_profile, get_series_profile_assignments, get_movie_profile_assignments, get_series_profile_map, get_series_missing_counts"
      contains: "def create_language_profile"
    - path: "backend/db/translation.py"
      provides: "record_translation_config, add_glossary_entry, get_glossary_entries, get_glossary_for_series, get_glossary_entry, update_glossary_entry, delete_glossary_entry, delete_glossary_entries_for_series, search_glossary_terms, add_prompt_preset, get_prompt_presets, get_prompt_preset, get_default_prompt_preset, update_prompt_preset, delete_prompt_preset"
      contains: "def record_translation_config"
    - path: "backend/db/cache.py"
      provides: "get_ffprobe_cache, set_ffprobe_cache, clear_ffprobe_cache, get_episode_history, get_anidb_mapping, save_anidb_mapping, cleanup_old_anidb_mappings, get_anidb_mapping_stats"
      contains: "def get_ffprobe_cache"
  key_links:
    - from: "backend/db/jobs.py"
      to: "backend/db/__init__.py"
      via: "from db import get_db, _db_lock"
      pattern: "from db import get_db"
    - from: "backend/db/wanted.py"
      to: "backend/db/__init__.py"
      via: "from db import get_db, _db_lock"
      pattern: "from db import get_db"
    - from: "backend/db/profiles.py"
      to: "backend/db/__init__.py"
      via: "from db import get_db, _db_lock"
      pattern: "from db import get_db"
---

<objective>
Split database.py (2153 lines, 80+ functions, 17 tables) into the `db/` package with 9 domain modules per the locked directory layout from CONTEXT.md.

Purpose: Unblock ARCH-04 (modular database) and provide the import targets that Plan 02 (routes/) and Plan 03 (import updates) depend on.
Output: `backend/db/` package with __init__.py + 9 domain modules. database.py remains temporarily (removed in Plan 03 after all imports are updated).
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-architecture-refactoring/00-CONTEXT.md
@.planning/phases/00-architecture-refactoring/00-RESEARCH.md
@backend/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create db/__init__.py with schema, connection, and migrations</name>
  <files>backend/db/__init__.py</files>
  <action>
Create the `backend/db/` package directory and `__init__.py`.

Extract from `database.py` into `db/__init__.py`:
1. All imports needed for connection management (os, json, sqlite3, logging, threading, datetime, typing)
2. The `_db_lock = threading.Lock()` and `_connection: Optional[sqlite3.Connection] = None` globals
3. The entire `SCHEMA` string (all CREATE TABLE and CREATE INDEX statements -- ~220 lines of DDL)
4. The `get_db()` function (creates/returns singleton connection, sets WAL mode, busy timeout, runs schema+migrations)
5. The `close_db()` function
6. The `_run_migrations(conn)` function (all ALTER TABLE, table existence checks, default profile creation, default preset creation)
7. A new `init_db()` convenience function that simply calls `get_db()` -- used by the factory in Plan 02

The `_row_to_job()` and `_row_to_wanted()` and `_row_to_profile()` helper functions should NOT go here -- they belong in their respective domain modules (jobs.py, wanted.py, profiles.py).

Export `get_db`, `close_db`, `init_db`, `_db_lock` from the package level so domain modules can do `from db import get_db, _db_lock`.

Keep the exact same connection logic: `sqlite3.connect(settings.db_path, check_same_thread=False, isolation_level="DEFERRED")`, `row_factory = sqlite3.Row`, `PRAGMA journal_mode=WAL`, `PRAGMA busy_timeout=5000`.
  </action>
  <verify>
Run from backend/: `python -c "from db import get_db, close_db, init_db, _db_lock; print('db/__init__.py imports OK')"`
  </verify>
  <done>
db/__init__.py exists with schema DDL, get_db(), close_db(), init_db(), _db_lock, _run_migrations(). Module imports cleanly without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create 9 domain modules extracting functions from database.py</name>
  <files>
    backend/db/jobs.py
    backend/db/config.py
    backend/db/providers.py
    backend/db/library.py
    backend/db/wanted.py
    backend/db/blacklist.py
    backend/db/profiles.py
    backend/db/translation.py
    backend/db/cache.py
  </files>
  <action>
Extract functions from database.py into 9 domain modules per the CONTEXT.md table. Each module follows this pattern:

```python
import json
import logging
from datetime import datetime
# ... only imports actually needed by this module's functions

from db import get_db, _db_lock

logger = logging.getLogger(__name__)
```

**db/jobs.py** -- Extract:
- `_row_to_job()` (private helper, stays with the functions that use it)
- `create_job()`, `update_job()`, `get_job()`, `get_jobs()`, `get_pending_job_count()`
- `record_stat()`, `get_stats_summary()`
- `get_outdated_jobs_count()`, `get_outdated_jobs()`

**db/config.py** -- Extract:
- `save_config_entry()`, `get_config_entry()`, `get_all_config_entries()`

**db/providers.py** -- Extract:
- `cache_provider_results()`, `get_cached_results()`, `cleanup_expired_cache()`
- `get_provider_cache_stats()`, `get_provider_download_stats()`, `clear_provider_cache()`
- `record_subtitle_download()` (note: this records downloads per-provider, belongs here not library)
- `update_provider_stats()`, `get_provider_stats()`, `get_provider_success_rate()`

**db/library.py** -- Extract:
- `get_download_history()`, `get_download_stats()`
- `record_upgrade()`, `get_upgrade_history()`, `get_upgrade_stats()`

**db/wanted.py** -- Extract:
- `_row_to_wanted()` (private helper)
- `upsert_wanted_item()`, `get_wanted_items()`, `get_wanted_item()`, `get_wanted_item_by_path()`
- `update_wanted_status()`, `update_wanted_search()`
- `delete_wanted_items()`, `delete_wanted_item()`, `delete_wanted_items_by_ids()`
- `get_wanted_count()`, `get_wanted_summary()`
- `get_all_wanted_file_paths()`, `get_wanted_items_for_cleanup()`
- `get_upgradeable_count()`, `find_wanted_by_episode()`

**db/blacklist.py** -- Extract:
- `add_blacklist_entry()`, `remove_blacklist_entry()`, `clear_blacklist()`
- `is_blacklisted()`, `get_blacklist_entries()`, `get_blacklist_count()`

**db/profiles.py** -- Extract:
- `_row_to_profile()` (private helper)
- `create_language_profile()`, `get_language_profile()`, `get_all_language_profiles()`
- `update_language_profile()`, `delete_language_profile()`
- `get_default_profile()`, `get_series_profile()`, `get_movie_profile()`
- `assign_series_profile()`, `assign_movie_profile()`
- `get_series_profile_assignments()`, `get_movie_profile_assignments()`
- `get_series_profile_map()`, `get_series_missing_counts()`

**db/translation.py** -- Extract:
- `record_translation_config()`
- `add_glossary_entry()`, `get_glossary_entries()`, `get_glossary_for_series()`
- `get_glossary_entry()`, `update_glossary_entry()`, `delete_glossary_entry()`
- `delete_glossary_entries_for_series()`, `search_glossary_terms()`
- `add_prompt_preset()`, `get_prompt_presets()`, `get_prompt_preset()`
- `get_default_prompt_preset()`, `update_prompt_preset()`, `delete_prompt_preset()`

**db/cache.py** -- Extract:
- `get_ffprobe_cache()`, `set_ffprobe_cache()`, `clear_ffprobe_cache()`
- `get_episode_history()`
- `get_anidb_mapping()`, `save_anidb_mapping()`, `cleanup_old_anidb_mappings()`, `get_anidb_mapping_stats()`

CRITICAL: Copy function bodies EXACTLY from database.py. Do NOT rewrite logic. This is a mechanical extraction. The only changes are:
- `from db import get_db, _db_lock` instead of referencing module-level globals
- Each module has its own `logger = logging.getLogger(__name__)`
- Import only what each module needs (json, uuid, datetime, etc.)

Do NOT delete database.py yet -- Plan 03 will update all external imports and then remove it.
  </action>
  <verify>
Run from backend/:
```bash
python -c "
from db.jobs import create_job, get_jobs, get_stats_summary
from db.config import get_all_config_entries
from db.providers import cache_provider_results, get_provider_stats
from db.library import get_download_history, record_upgrade
from db.wanted import get_wanted_items, get_wanted_summary
from db.blacklist import add_blacklist_entry, is_blacklisted
from db.profiles import get_default_profile, get_series_profile
from db.translation import get_glossary_entries, get_prompt_presets
from db.cache import get_ffprobe_cache, get_anidb_mapping
print('All 9 db modules import cleanly')
"
```
  </verify>
  <done>
All 9 domain modules exist under backend/db/ with every function from database.py extracted to its correct domain. All modules import cleanly. Function signatures and bodies are identical to the originals.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from db import get_db, init_db, close_db, _db_lock"` succeeds
2. `python -c "from db.jobs import create_job; from db.wanted import get_wanted_items; from db.profiles import get_default_profile"` succeeds
3. Every public function from database.py is importable from exactly one db.* module
4. database.py still exists (backward compat for other modules until Plan 03)
</verification>

<success_criteria>
- backend/db/ package exists with __init__.py + 9 domain modules
- All 80+ functions from database.py are distributed across the 9 modules per CONTEXT.md domain boundaries
- Schema DDL and migrations are in db/__init__.py
- Connection management (get_db, close_db, _db_lock) is in db/__init__.py
- All db/ modules import without errors
- No function logic was changed -- purely mechanical extraction
</success_criteria>

<output>
After completion, create `.planning/phases/00-architecture-refactoring/00-01-SUMMARY.md`
</output>

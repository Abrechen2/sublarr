---
phase: 00-architecture-refactoring
plan: 03
type: execute
wave: 3
depends_on: ["00-01", "00-02"]
files_modified:
  - backend/translator.py
  - backend/wanted_scanner.py
  - backend/wanted_search.py
  - backend/ollama_client.py
  - backend/anidb_mapper.py
  - backend/ass_utils.py
  - backend/config.py
  - backend/metrics.py
  - backend/providers/__init__.py
  - backend/tests/conftest.py
  - backend/tests/test_server.py
  - backend/tests/test_database.py
  - backend/tests/integration/test_database_operations.py
  - backend/tests/performance/test_api_performance.py
  - Dockerfile
  - package.json
autonomous: false

must_haves:
  truths:
    - "No file in the codebase imports from 'database' -- all use 'db' or 'db.*'"
    - "No file in the codebase imports from 'server' -- all use 'app', 'extensions', or 'routes.*'"
    - "database.py and server.py are deleted"
    - "All existing test assertions pass with updated imports"
    - "Docker builds and starts successfully with new entry point"
    - "npm run dev:backend starts the Flask dev server via app.py"
    - "Gunicorn uses workers=1 (Flask-SocketIO requirement)"
  artifacts:
    - path: "backend/translator.py"
      provides: "Updated imports from db.translation, db.cache"
      contains: "from db"
    - path: "backend/wanted_scanner.py"
      provides: "Updated imports from db.wanted, db.profiles, db.config"
      contains: "from db"
    - path: "backend/wanted_search.py"
      provides: "Updated imports from db.wanted, db.providers, db.blacklist, db.library"
      contains: "from db"
    - path: "backend/providers/__init__.py"
      provides: "Updated imports from db.providers, db.blacklist"
      contains: "from db"
    - path: "backend/tests/conftest.py"
      provides: "Factory-pattern test fixture using create_app(testing=True)"
      contains: "from app import create_app"
    - path: "Dockerfile"
      provides: "Updated CMD using app:create_app() with workers=1"
      contains: "app:create_app()"
    - path: "package.json"
      provides: "Updated dev:backend script using FLASK_APP=app.py"
      contains: "FLASK_APP=app.py"
  key_links:
    - from: "backend/tests/conftest.py"
      to: "backend/app.py"
      via: "from app import create_app"
      pattern: "from app import create_app"
    - from: "backend/translator.py"
      to: "backend/db/translation.py"
      via: "from db.translation import record_translation_config"
      pattern: "from db\\.translation import"
    - from: "backend/wanted_scanner.py"
      to: "backend/db/wanted.py"
      via: "from db.wanted import ..."
      pattern: "from db\\.wanted import"
    - from: "Dockerfile"
      to: "backend/app.py"
      via: "gunicorn app:create_app()"
      pattern: "app:create_app"
---

<objective>
Update all import paths across the codebase (from database -> db.*, from server -> app/extensions), update entry points (Dockerfile, package.json), delete the old monolith files, update test fixtures, and run full test suite to verify backward compatibility.

Purpose: Complete the migration by ensuring no file references the old modules. Fulfills the "clean break" decision from CONTEXT.md and validates ARCH-01 through ARCH-04.
Output: Fully migrated codebase with no references to database.py or server.py.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-architecture-refactoring/00-CONTEXT.md
@.planning/phases/00-architecture-refactoring/00-RESEARCH.md
@.planning/phases/00-architecture-refactoring/00-01-SUMMARY.md
@.planning/phases/00-architecture-refactoring/00-02-SUMMARY.md
@backend/translator.py
@backend/wanted_scanner.py
@backend/wanted_search.py
@backend/ollama_client.py
@backend/anidb_mapper.py
@backend/ass_utils.py
@backend/config.py
@backend/metrics.py
@backend/providers/__init__.py
@backend/tests/conftest.py
@backend/tests/test_server.py
@backend/tests/test_database.py
@Dockerfile
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all external module imports and entry points</name>
  <files>
    backend/translator.py
    backend/wanted_scanner.py
    backend/wanted_search.py
    backend/ollama_client.py
    backend/anidb_mapper.py
    backend/ass_utils.py
    backend/config.py
    backend/metrics.py
    backend/providers/__init__.py
    backend/tests/conftest.py
    backend/tests/test_server.py
    backend/tests/test_database.py
    backend/tests/integration/test_database_operations.py
    backend/tests/performance/test_api_performance.py
    Dockerfile
    package.json
  </files>
  <action>
Update every `from database import` and `from server import` statement in the codebase. This is a mechanical, systematic replacement. Here is the complete list of files and the exact changes needed:

**backend/translator.py** (1 import site, line ~559):
- `from database import record_translation_config` -> `from db.translation import record_translation_config`

**backend/wanted_scanner.py** (5 import sites):
- Top-level (line ~18): `from database import (upsert_wanted_item, get_wanted_items, get_all_wanted_file_paths, ...)` -> Update to import from correct db.* modules:
  - `from db.wanted import upsert_wanted_item, get_wanted_items, get_all_wanted_file_paths, get_wanted_items_for_cleanup, delete_wanted_items_by_ids, get_wanted_count`
  - `from db.profiles import get_default_profile, get_series_profile, get_movie_profile, get_series_profile_map, get_series_missing_counts, get_series_profile_assignments, get_movie_profile_assignments`
- Deferred imports inside functions (lines ~142, ~472, ~501, ~525): Update each `from database import ...` to `from db.{module} import ...`

**backend/wanted_search.py** (1 import site, line ~13):
- `from database import (...)` -> Split across db.wanted, db.providers, db.blacklist, db.library, db.profiles as needed

**backend/ollama_client.py** (1 import site, line ~13):
- `from database import get_glossary_for_series` -> `from db.translation import get_glossary_for_series`

**backend/anidb_mapper.py** (1 import site, line ~16):
- `from database import get_anidb_mapping, save_anidb_mapping` -> `from db.cache import get_anidb_mapping, save_anidb_mapping`

**backend/ass_utils.py** (1 import site, line ~338, deferred):
- `from database import get_ffprobe_cache, set_ffprobe_cache` -> `from db.cache import get_ffprobe_cache, set_ffprobe_cache`

**backend/config.py** (1 import site, line ~152, deferred):
- `from database import get_default_prompt_preset` -> `from db.translation import get_default_prompt_preset`

**backend/metrics.py** (1 import site, line ~111, deferred):
- `from database import get_pending_job_count, get_wanted_summary` -> `from db.jobs import get_pending_job_count` and `from db.wanted import get_wanted_summary`

**backend/providers/__init__.py** (4 import sites, all deferred):
- Line ~136: `from database import get_provider_stats, get_provider_success_rate` -> `from db.providers import get_provider_stats, get_provider_success_rate`
- Line ~374: `from database import get_cached_results, cache_provider_results` -> `from db.providers import get_cached_results, cache_provider_results`
- Line ~485: `from database import is_blacklisted` -> `from db.blacklist import is_blacklisted`
- Line ~624: `from database import update_provider_stats` -> `from db.providers import update_provider_stats`
- Line ~671: `from database import get_provider_download_stats, get_provider_stats, get_provider_success_rate` -> `from db.providers import get_provider_download_stats, get_provider_stats, get_provider_success_rate`

**backend/tests/conftest.py**:
- `from database import init_db, get_db` -> `from db import init_db, get_db`
- `from server import app` -> Replace with factory pattern:
  ```python
  from app import create_app
  ```
- Update `client` fixture to use factory:
  ```python
  @pytest.fixture
  def client(temp_db):
      app = create_app(testing=True)
      app.config["TESTING"] = True
      with app.test_client() as client:
          yield client
  ```

**backend/tests/test_server.py**:
- `from server import app` -> `from app import create_app`
- Update any direct `app` usage to use factory pattern (create app in fixture or at module level)

**backend/tests/test_database.py**:
- `from database import get_db, create_job, update_job, get_job, record_stat, get_stats_summary, close_db` -> `from db import get_db, close_db` and `from db.jobs import create_job, update_job, get_job, record_stat, get_stats_summary`

**backend/tests/integration/test_database_operations.py**:
- `from database import (...)` -> Update to import from correct db.* modules

**backend/tests/performance/test_api_performance.py**:
- `from database import get_wanted_items` -> `from db.wanted import get_wanted_items`
- `from database import get_download_history` -> `from db.library import get_download_history`

**Dockerfile** (line 58):
- Change: `CMD ["gunicorn", "--bind", "0.0.0.0:5765", "--worker-class", "gthread", "--workers", "2", "--threads", "4", "--timeout", "300", "server:app"]`
- To: `CMD ["gunicorn", "--bind", "0.0.0.0:5765", "--worker-class", "gthread", "--workers", "1", "--threads", "4", "--timeout", "300", "app:create_app()"]`
- Note: workers changed from 2 to 1 per RESEARCH.md (Flask-SocketIO requirement)

**package.json** (dev:backend script):
- Change: `"dev:backend": "cd backend && cross-env FLASK_APP=server.py FLASK_ENV=development FLASK_DEBUG=1 python -m flask run --host=0.0.0.0 --port=5765 --reload"`
- To: `"dev:backend": "cd backend && cross-env FLASK_APP=app.py FLASK_ENV=development FLASK_DEBUG=1 python -m flask run --host=0.0.0.0 --port=5765 --reload"`

**After all imports are updated, DELETE the old files:**
- Delete `backend/database.py`
- Delete `backend/server.py`

**Verification grep** -- Run `grep -r "from database import" backend/` and `grep -r "from server import" backend/` to confirm zero results.
  </action>
  <verify>
```bash
cd backend
# Verify no old imports remain
grep -r "from database import" . --include="*.py" | grep -v __pycache__ | grep -v ".pyc"
grep -r "from server import" . --include="*.py" | grep -v __pycache__ | grep -v ".pyc"
# Both should return empty

# Verify old files are deleted
test ! -f database.py && echo "database.py deleted OK" || echo "FAIL: database.py still exists"
test ! -f server.py && echo "server.py deleted OK" || echo "FAIL: server.py still exists"

# Verify app starts
python -c "from app import create_app; app = create_app(testing=True); print('App creates successfully')"
```
  </verify>
  <done>
All import paths updated from database/server to db.*/app/extensions. database.py and server.py deleted. Dockerfile uses app:create_app() with workers=1. package.json uses FLASK_APP=app.py.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete architecture refactoring: Application Factory pattern (create_app()), 9 Blueprint route files, 9 database domain modules, updated entry points. The monolithic server.py (2618 lines) and database.py (2153 lines) have been replaced by modular files.
  </what-built>
  <how-to-verify>
1. Run the test suite from the backend directory:
   ```bash
   cd backend && python -m pytest -x -v
   ```
   All tests should pass. Import paths have changed but test assertions are identical.

2. Start the dev server to verify it boots:
   ```bash
   npm run dev:backend
   ```
   Should start Flask on port 5765 without errors. Check the terminal output for:
   - "Database initialized at ..."
   - No ImportError or ModuleNotFoundError
   - Health endpoint works: visit http://localhost:5765/api/v1/health

3. (Optional) Check route count:
   ```bash
   cd backend && python -c "from app import create_app; app = create_app(testing=True); print(len([r.rule for r in app.url_map.iter_rules()]))"
   ```
   Should show 70+ rules (67 API routes + metrics + SPA fallback + static).
  </how-to-verify>
  <resume-signal>Type "approved" if tests pass and dev server starts cleanly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `grep -r "from database import" backend/ --include="*.py"` returns zero results
2. `grep -r "from server import" backend/ --include="*.py"` returns zero results
3. `backend/database.py` does not exist
4. `backend/server.py` does not exist
5. `python -m pytest` passes all tests
6. `npm run dev:backend` starts successfully
7. Dockerfile CMD uses `app:create_app()` with `--workers 1`
8. package.json dev:backend uses `FLASK_APP=app.py`
9. All API endpoints respond at the same paths as before
</verification>

<success_criteria>
- Zero imports from `database` or `server` modules anywhere in the codebase
- database.py and server.py are deleted (clean break per CONTEXT.md decision)
- All existing tests pass (backward compatibility preserved for test assertions)
- Dev server boots cleanly via npm run dev:backend
- Docker CMD uses correct factory entry point with workers=1
- Phase 0 requirements ARCH-01 through ARCH-04 are all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/00-architecture-refactoring/00-03-SUMMARY.md`
</output>

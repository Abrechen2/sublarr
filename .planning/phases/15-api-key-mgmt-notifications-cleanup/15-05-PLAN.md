---
phase: 15-api-key-mgmt-notifications-cleanup
plan: 05
type: execute
wave: 2
depends_on: ["15-03"]
files_modified:
  - frontend/src/pages/Settings/CleanupTab.tsx
  - frontend/src/pages/Settings/index.tsx
  - frontend/src/components/cleanup/DedupGroupList.tsx
  - frontend/src/components/cleanup/DiskSpaceWidget.tsx
  - frontend/src/components/cleanup/CleanupPreview.tsx
  - frontend/src/components/dashboard/widgets/DiskSpaceWidget.tsx
  - frontend/src/hooks/useApi.ts
  - frontend/src/lib/types.ts
  - frontend/src/i18n/locales/en/settings.json
  - frontend/src/i18n/locales/de/settings.json
autonomous: true

must_haves:
  truths:
    - "User can trigger a dedup scan and see progress via WebSocket updates"
    - "Duplicate groups display file paths, sizes, and formats with radio buttons to select which to keep"
    - "Batch delete enforces keep-at-least-one selection in the UI before enabling the delete button"
    - "Cleanup rules are configurable from the Settings tab"
    - "Disk space widget shows total subtitle storage, duplicate waste, and format breakdown"
    - "Dashboard includes a disk space analysis widget"
  artifacts:
    - path: "frontend/src/pages/Settings/CleanupTab.tsx"
      provides: "Cleanup management tab with dedup, orphaned, rules, and disk analysis"
      min_lines: 200
    - path: "frontend/src/components/cleanup/DedupGroupList.tsx"
      provides: "Grouped duplicate display with keep/delete selection"
      min_lines: 100
    - path: "frontend/src/components/cleanup/DiskSpaceWidget.tsx"
      provides: "Disk usage analysis visualization"
      min_lines: 60
    - path: "frontend/src/components/dashboard/widgets/DiskSpaceWidget.tsx"
      provides: "Dashboard widget wrapper for disk space analysis"
      min_lines: 30
  key_links:
    - from: "frontend/src/pages/Settings/CleanupTab.tsx"
      to: "/api/v1/cleanup"
      via: "React Query hooks for scan, duplicates, rules, stats"
      pattern: "useCleanupScan|useDuplicates|useCleanupRules|useCleanupStats"
    - from: "frontend/src/components/cleanup/DedupGroupList.tsx"
      to: "frontend/src/pages/Settings/CleanupTab.tsx"
      via: "Component rendering duplicate groups with selection state"
      pattern: "DedupGroupList"
    - from: "frontend/src/components/dashboard/widgets/DiskSpaceWidget.tsx"
      to: "/api/v1/cleanup/stats"
      via: "Dashboard widget fetching disk space data"
      pattern: "useCleanupStats"
---

<objective>
Frontend cleanup management tab and dashboard disk space widget.

Purpose: Creates the CleanupTab in Settings with deduplication scanning, duplicate group management, orphaned subtitle detection, cleanup rules, and disk space analysis. Adds a dashboard widget for disk space monitoring.
Output: CleanupTab + cleanup components + dashboard widget + hooks + types + i18n
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-api-key-mgmt-notifications-cleanup/15-RESEARCH.md

@frontend/src/pages/Settings/index.tsx
@frontend/src/hooks/useApi.ts
@frontend/src/lib/types.ts
@frontend/src/components/dashboard/widgets/
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript Types, Hooks, and Cleanup Components</name>
  <files>frontend/src/lib/types.ts, frontend/src/hooks/useApi.ts, frontend/src/components/cleanup/DedupGroupList.tsx, frontend/src/components/cleanup/DiskSpaceWidget.tsx, frontend/src/components/cleanup/CleanupPreview.tsx</files>
  <action>
Add TypeScript interfaces to frontend/src/lib/types.ts:
- SubtitleHashEntry: {file_path: string, content_hash: string, file_size: number, format: string, language: string|null, line_count: number|null, last_scanned: string}
- DuplicateGroup: {content_hash: string, files: SubtitleHashEntry[]}
- CleanupRule: {id: number, name: string, rule_type: "dedup"|"orphaned"|"old_backups", config_json: Record<string, unknown>, enabled: boolean, last_run_at: string|null, created_at: string}
- CleanupHistoryEntry: {id: number, rule_id: number|null, action_type: string, files_processed: number, files_deleted: number, bytes_freed: number, performed_at: string}
- DiskSpaceStats: {total_files: number, total_size_bytes: number, by_format: {format: string, count: number, size_bytes: number}[], duplicate_files: number, duplicate_size_bytes: number, potential_savings_bytes: number, trends: {date: string, bytes_freed: number}[]}
- ScanStatus: {status: "idle"|"scanning", progress: number, total: number, scan_id: string|null}

Add React Query hooks to frontend/src/hooks/useApi.ts:
- useCleanupStats() -- GET /api/v1/cleanup/stats
- useStartCleanupScan() -- POST mutation /api/v1/cleanup/scan
- useCleanupScanStatus() -- GET /api/v1/cleanup/scan/status (polling every 2s when scanning)
- useDuplicates(page?) -- GET /api/v1/cleanup/duplicates
- useDeleteDuplicates() -- POST mutation /api/v1/cleanup/duplicates/delete
- useOrphanedScan() -- POST mutation /api/v1/cleanup/orphaned/scan
- useOrphanedFiles() -- GET /api/v1/cleanup/orphaned
- useDeleteOrphaned() -- POST mutation
- useCleanupRules() -- GET /api/v1/cleanup/rules
- useCreateCleanupRule() -- POST mutation
- useUpdateCleanupRule() -- PUT mutation
- useDeleteCleanupRule() -- DELETE mutation
- useRunCleanupRule() -- POST mutation /api/v1/cleanup/rules/<id>/run
- useCleanupHistory(page?) -- GET /api/v1/cleanup/history
- useCleanupPreview() -- POST mutation /api/v1/cleanup/preview

Create frontend/src/components/cleanup/DedupGroupList.tsx:
- Props: groups: DuplicateGroup[], onDelete: (selections: {keep: string, delete: string[]}[]) => void
- Each group rendered as a card with the shared content_hash (truncated)
- Inside each group: list of files with radio button to select KEEP and checkboxes for DELETE
- Default: first file pre-selected as KEEP
- File info: path (truncated with tooltip), size (human-readable), format badge, language badge
- Delete button per group or batch delete all groups
- CRITICAL: Delete button disabled unless exactly one file is marked KEEP per group

Create frontend/src/components/cleanup/DiskSpaceWidget.tsx:
- Props: stats: DiskSpaceStats
- Pie chart (Recharts) showing format breakdown (ASS vs SRT vs SSA)
- Bar showing total vs duplicate storage with potential savings highlighted
- Trend line (last 30 days of bytes_freed from cleanup_history)
- Human-readable file sizes (KB, MB, GB)

Create frontend/src/components/cleanup/CleanupPreview.tsx:
- Props: preview data from /cleanup/preview endpoint
- Lists files that would be affected by the cleanup operation
- Shows total size that would be freed
- Confirm/Cancel buttons
  </action>
  <verify>
Run: cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20
Expect: No errors in new files
  </verify>
  <done>Cleanup types, hooks, and components are created and type-check correctly</done>
</task>

<task type="auto">
  <name>Task 2: CleanupTab, Dashboard Widget, i18n, and Settings Integration</name>
  <files>frontend/src/pages/Settings/CleanupTab.tsx, frontend/src/pages/Settings/index.tsx, frontend/src/components/dashboard/widgets/DiskSpaceWidget.tsx, frontend/src/i18n/locales/en/settings.json, frontend/src/i18n/locales/de/settings.json</files>
  <action>
Create frontend/src/pages/Settings/CleanupTab.tsx with four sections:

1. Disk Space Overview (top):
   - DiskSpaceWidget showing current stats from useCleanupStats
   - Quick summary: total files, total size, duplicate count, potential savings

2. Deduplication section:
   - "Scan for Duplicates" button triggering useStartCleanupScan
   - Progress bar during scan (poll useCleanupScanStatus every 2s, also listen to WebSocket scan_progress events)
   - After scan: DedupGroupList showing duplicate groups
   - Batch delete with confirmation modal (CleanupPreview)

3. Orphaned Subtitles section:
   - "Scan for Orphaned" button
   - List of orphaned files with checkboxes for deletion
   - Delete button with confirmation

4. Cleanup Rules section:
   - List of configured rules as cards (collapsible)
   - Create rule form: name, type dropdown, config fields (varies by type), enabled toggle
   - Run Now button per rule
   - Schedule display (next run time based on interval)

5. History section (collapsible at bottom):
   - Paginated table of past cleanup operations

Create frontend/src/components/dashboard/widgets/DiskSpaceWidget.tsx:
- Dashboard widget wrapper (follows pattern from existing widgets in components/dashboard/widgets/)
- Shows compact disk space summary: total subtitle files, duplicate count, potential savings
- Uses Recharts for a small donut chart of format breakdown
- Links to Settings Cleanup tab for details

Update frontend/src/pages/Settings/index.tsx:
- Add "Cleanup" to TABS array (position after "Subtitle Tools")
- Import CleanupTab (lazy via React.lazy)
- Add tab render case

Add i18n keys to en/settings.json and de/settings.json:
- settings.cleanup.* (title, scan, duplicates, orphaned, rules, history, diskSpace)
- settings.cleanup.dedup.* (scanButton, scanning, progress, noResults, keepLabel, deleteLabel)
- settings.cleanup.orphaned.* (scanButton, noResults, deleteSelected)
- settings.cleanup.rules.* (create, edit, runNow, schedule, types)
- settings.cleanup.diskSpace.* (totalFiles, totalSize, duplicates, savings, byFormat, trends)
- dashboard.widgets.diskSpace.* (title, subtitle, duplicates, savings)
  </action>
  <verify>
Run: cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20
Expect: No errors
  </verify>
  <done>CleanupTab with all sections integrated into Settings, dashboard widget created, i18n complete</done>
</task>

</tasks>

<verification>
- TypeScript compilation succeeds
- Settings page shows new Cleanup tab
- Dedup scan shows progress and results
- Duplicate groups enforce keep-at-least-one selection
- Dashboard shows disk space widget
- i18n keys exist in both en and de locales
</verification>

<success_criteria>
- Dedup scan triggers background operation with progress bar
- Duplicate groups render with radio/checkbox selection pattern
- Delete button disabled until valid selection (one keep per group)
- Orphaned subtitle scan finds and lists files without parent media
- Cleanup rules are configurable with all three types
- Disk space widget shows format breakdown and savings potential
- Dashboard widget provides at-a-glance storage overview
</success_criteria>

<output>
After completion, create .planning/phases/15-api-key-mgmt-notifications-cleanup/15-05-SUMMARY.md
</output>

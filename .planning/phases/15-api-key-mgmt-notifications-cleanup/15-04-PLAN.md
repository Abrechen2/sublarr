---
phase: 15-api-key-mgmt-notifications-cleanup
plan: 04
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - frontend/src/pages/Settings/ApiKeysTab.tsx
  - frontend/src/pages/Settings/NotificationTemplatesTab.tsx
  - frontend/src/pages/Settings/index.tsx
  - frontend/src/hooks/useApi.ts
  - frontend/src/lib/types.ts
  - frontend/src/components/notifications/TemplateEditor.tsx
  - frontend/src/components/notifications/TemplatePreview.tsx
  - frontend/src/components/notifications/QuietHoursConfig.tsx
  - frontend/src/i18n/locales/en/settings.json
  - frontend/src/i18n/locales/de/settings.json
autonomous: true

must_haves:
  truths:
    - "User can view all API keys in a centralized tab with masked display and status indicators"
    - "User can test, rotate, export, and import API keys from the management page"
    - "Bazarr migration UI accepts a config file upload and shows preview before importing"
    - "User can create and edit notification templates with a variable-aware editor and live preview"
    - "User can configure quiet hours with time pickers and day-of-week checkboxes"
    - "Notification history table shows past notifications with re-send button"
  artifacts:
    - path: "frontend/src/pages/Settings/ApiKeysTab.tsx"
      provides: "Centralized API key management UI"
      min_lines: 150
    - path: "frontend/src/pages/Settings/NotificationTemplatesTab.tsx"
      provides: "Notification templates, quiet hours, and history management UI"
      min_lines: 200
    - path: "frontend/src/components/notifications/TemplateEditor.tsx"
      provides: "Variable-aware template text editor"
      min_lines: 80
    - path: "frontend/src/components/notifications/QuietHoursConfig.tsx"
      provides: "Quiet hours time range and day-of-week configuration"
      min_lines: 60
  key_links:
    - from: "frontend/src/pages/Settings/ApiKeysTab.tsx"
      to: "/api/v1/api-keys"
      via: "React Query hooks for CRUD operations"
      pattern: "useApiKeys|useUpdateApiKey|useTestApiKey"
    - from: "frontend/src/pages/Settings/NotificationTemplatesTab.tsx"
      to: "/api/v1/notifications"
      via: "React Query hooks for template and quiet hours CRUD"
      pattern: "useNotificationTemplates|useQuietHours|useNotificationHistory"
    - from: "frontend/src/pages/Settings/index.tsx"
      to: "frontend/src/pages/Settings/ApiKeysTab.tsx"
      via: "Tab import and TABS array registration"
      pattern: "ApiKeysTab"
---

<objective>
Frontend Settings tabs for API key management and notification templates.

Purpose: Creates two new Settings tab components -- ApiKeysTab for centralized key management (KEYS-01..05) and NotificationTemplatesTab for templates, quiet hours, event filters, and history (NOTF-01..05). Includes TypeScript types, React Query hooks, and i18n translations.
Output: Two new Settings tabs with supporting components, hooks, types, and translations
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-api-key-mgmt-notifications-cleanup/15-RESEARCH.md

@frontend/src/pages/Settings/index.tsx
@frontend/src/hooks/useApi.ts
@frontend/src/lib/types.ts
@frontend/src/i18n/locales/en/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript Types, React Query Hooks, and ApiKeysTab</name>
  <files>frontend/src/lib/types.ts, frontend/src/hooks/useApi.ts, frontend/src/pages/Settings/ApiKeysTab.tsx, frontend/src/pages/Settings/index.tsx</files>
  <action>
Add TypeScript interfaces to frontend/src/lib/types.ts:
- ApiKeyService: {service: string, keys: {name: string, status: "configured"|"missing", masked_value: string}[], testable: boolean}
- ApiKeyExportData: {config: Record<string, string>, profiles: unknown[], glossary: unknown[]}
- BazarrMigrationPreview: {config_entries: {key: string, value: string, current_value: string}[], profiles: unknown[], blacklist_count: number, warnings: string[]}
- NotificationTemplate: {id: number, name: string, title_template: string, body_template: string, event_type: string|null, service_name: string|null, enabled: boolean, created_at: string, updated_at: string}
- NotificationHistoryEntry: {id: number, event_type: string, title: string, body: string, template_id: number|null, status: string, error: string, sent_at: string}
- QuietHoursConfig: {id: number, name: string, start_time: string, end_time: string, days_of_week: number[], exception_events: string[], enabled: boolean}
- TemplateVariable: {name: string, description: string, sample_value: string}
- NotificationFilter: {include_events: string[], exclude_events: string[], content_filters: {field: string, operator: string, value: string}[]}

Add React Query hooks to frontend/src/hooks/useApi.ts:
- useApiKeys() -- GET /api/v1/api-keys
- useApiKeyService(service) -- GET /api/v1/api-keys/<service>
- useUpdateApiKey() -- PUT mutation
- useTestApiKey() -- POST mutation
- useExportApiKeys() -- POST /api/v1/api-keys/export (blob download)
- useImportApiKeys() -- POST /api/v1/api-keys/import (FormData upload)
- useBazarrMigration() -- POST /api/v1/api-keys/import/bazarr

Create frontend/src/pages/Settings/ApiKeysTab.tsx:
- Table/card list of all services from useApiKeys()
- Each service shows: name, key status badges (green=configured, red=missing), masked values
- Inline edit mode: click to reveal password input for updating keys
- Test button per service (if testable) showing success/failure toast
- Export button: downloads ZIP via blob
- Import section: file upload for ZIP or CSV, with preview of what will be imported
- Bazarr Migration section: file upload for Bazarr config, preview modal showing what will be imported with confirm/cancel
- Use teal theme colors consistent with existing Settings tabs

Update frontend/src/pages/Settings/index.tsx:
- Add "API Keys" to TABS array (position after "General")
- Import ApiKeysTab component (lazy import via React.lazy for code splitting)
- Add tab render case
  </action>
  <verify>
Run: cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20
Expect: No errors in new files
  </verify>
  <done>ApiKeysTab renders all services with masked keys, test buttons, export/import, and Bazarr migration</done>
</task>

<task type="auto">
  <name>Task 2: Notification Components and NotificationTemplatesTab</name>
  <files>frontend/src/components/notifications/TemplateEditor.tsx, frontend/src/components/notifications/TemplatePreview.tsx, frontend/src/components/notifications/QuietHoursConfig.tsx, frontend/src/pages/Settings/NotificationTemplatesTab.tsx, frontend/src/hooks/useApi.ts, frontend/src/pages/Settings/index.tsx</files>
  <action>
Add remaining React Query hooks to frontend/src/hooks/useApi.ts:
- useNotificationTemplates() -- GET /api/v1/notifications/templates
- useCreateTemplate() -- POST mutation
- useUpdateTemplate() -- PUT mutation
- useDeleteTemplate() -- DELETE mutation
- usePreviewTemplate(id) -- POST /api/v1/notifications/templates/<id>/preview
- useTemplateVariables(eventType?) -- GET /api/v1/notifications/variables
- useQuietHours() -- GET /api/v1/notifications/quiet-hours
- useCreateQuietHours() -- POST mutation
- useUpdateQuietHours() -- PUT mutation
- useDeleteQuietHours() -- DELETE mutation
- useNotificationHistory(page, eventType?) -- GET /api/v1/notifications/history
- useResendNotification() -- POST mutation
- useNotificationFilters() -- GET /api/v1/notifications/filters
- useUpdateNotificationFilters() -- PUT mutation

Create frontend/src/components/notifications/TemplateEditor.tsx:
- Textarea for title_template and body_template
- Sidebar/dropdown showing available variables for the selected event_type (from useTemplateVariables)
- Click-to-insert variable into cursor position ({{ variable_name }})
- Jinja2 syntax highlighting hints (use a simple regex-based approach, not a full parser)
- Name field and event_type/service_name dropdowns
- Enabled toggle

Create frontend/src/components/notifications/TemplatePreview.tsx:
- Takes template_id as prop
- Calls usePreviewTemplate to render with sample data
- Shows rendered title and body in a notification-style card
- Auto-refreshes on template text changes (debounced 500ms)

Create frontend/src/components/notifications/QuietHoursConfig.tsx:
- Time range inputs (HH:MM format) for start and end
- Day-of-week checkboxes (Mon-Sun)
- Exception events multi-select from EVENT_CATALOG event types
- Enabled toggle
- Visual timeline showing quiet period as a highlighted bar on a 24h scale

Create frontend/src/pages/Settings/NotificationTemplatesTab.tsx with three sections:
1. Templates section: list of templates as cards, create/edit/delete, preview panel
2. Quiet Hours section: list of quiet hour configs, create/edit/delete
3. History section: paginated table of past notifications with event_type filter and re-send button
4. Filters section: collapsible advanced event filter config (include/exclude events, content filters)

Update frontend/src/pages/Settings/index.tsx:
- Replace existing simple "Notifications" tab with "Notification Templates" that uses the new NotificationTemplatesTab
- Keep existing simple notification toggles in the original Notifications tab position OR merge them into the new tab (prefer merge: show the toggle fields at the top of NotificationTemplatesTab for backward compat)

Add i18n keys to frontend/src/i18n/locales/en/settings.json and de/settings.json for:
- settings.apiKeys.* (title, services, test, export, import, bazarr, masks)
- settings.notifications.templates.* (title, create, edit, preview, variables)
- settings.notifications.quietHours.* (title, startTime, endTime, days, exceptions)
- settings.notifications.history.* (title, resend, clear, status)
- settings.notifications.filters.* (title, include, exclude, content)
  </action>
  <verify>
Run: cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20
Expect: No errors in new files
  </verify>
  <done>NotificationTemplatesTab with template editor, preview, quiet hours, history, and filters is working and integrated into Settings</done>
</task>

</tasks>

<verification>
- TypeScript compilation succeeds with no errors in new files
- Settings page shows new API Keys and Notification Templates tabs
- API Keys tab lists services with masked values and test buttons
- Template editor shows available variables per event type
- Quiet hours config has time pickers and day-of-week checkboxes
- i18n keys exist in both en and de locale files
</verification>

<success_criteria>
- All API key services visible with correct status indicators
- Key rotation updates values and shows success/error feedback
- Export downloads a ZIP, import accepts ZIP/CSV with preview
- Bazarr migration shows preview before confirming import
- Template editor inserts variables and validates Jinja2 syntax
- Template preview renders with sample data in real-time
- Quiet hours config saves and displays correctly
- Notification history is paginated with re-send capability
</success_criteria>

<output>
After completion, create .planning/phases/15-api-key-mgmt-notifications-cleanup/15-04-SUMMARY.md
</output>

---
phase: 08-i18n-backup-admin-polish
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - frontend/src/pages/Statistics.tsx
  - frontend/src/components/charts/TranslationChart.tsx
  - frontend/src/components/charts/ProviderChart.tsx
  - frontend/src/components/charts/FormatChart.tsx
  - frontend/src/components/charts/DownloadChart.tsx
  - frontend/src/pages/Settings.tsx
  - frontend/src/pages/Logs.tsx
  - frontend/src/hooks/useApi.ts
  - frontend/src/api/client.ts
  - frontend/src/lib/types.ts
  - frontend/src/App.tsx
  - frontend/src/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Statistics page shows translation, provider, format, and download charts"
    - "Statistics charts respond to time-range filter (7d, 30d, 90d, 365d)"
    - "Statistics data can be exported as JSON or CSV from the page"
    - "Backup tab in Settings shows create, list, download, restore, and schedule controls"
    - "User can create a ZIP backup from the UI and download it"
    - "User can upload a ZIP file to restore config and database"
    - "Logs page has a download button that saves the log file"
    - "Logs page has a rotation config section (max size, backup count)"
    - "Subtitle Tools tab in Settings offers HI removal, timing adjustment, and common fixes"
    - "Statistics page is accessible from sidebar navigation"
  artifacts:
    - path: "frontend/src/pages/Statistics.tsx"
      provides: "Statistics page with Recharts charts and time-range filter"
      min_lines: 100
    - path: "frontend/src/components/charts/TranslationChart.tsx"
      provides: "Daily translations area chart"
      exports: ["TranslationChart"]
    - path: "frontend/src/components/charts/ProviderChart.tsx"
      provides: "Provider usage bar chart"
      exports: ["ProviderChart"]
    - path: "frontend/src/components/charts/FormatChart.tsx"
      provides: "ASS vs SRT format pie chart"
      exports: ["FormatChart"]
    - path: "frontend/src/components/charts/DownloadChart.tsx"
      provides: "Downloads by provider horizontal bar chart"
      exports: ["DownloadChart"]
  key_links:
    - from: "frontend/src/pages/Statistics.tsx"
      to: "/api/v1/statistics"
      via: "useStatistics hook with range param"
      pattern: "useStatistics"
    - from: "frontend/src/pages/Settings.tsx"
      to: "/api/v1/backup/full"
      via: "useCreateFullBackup hook"
      pattern: "backup.*full"
    - from: "frontend/src/pages/Logs.tsx"
      to: "/api/v1/logs/download"
      via: "direct download link"
      pattern: "logs/download"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/Statistics.tsx"
      via: "Route path /statistics"
      pattern: "/statistics"
    - from: "frontend/src/components/layout/Sidebar.tsx"
      to: "/statistics"
      via: "NavLink in System group"
      pattern: "statistics"
---

<objective>
Build the Statistics page with Recharts charts, add Backup and Subtitle Tools tabs to Settings, and enhance the Logs page with download and rotation config.

Purpose: This plan delivers the main user-facing UI features for admin polish -- visual statistics, backup management, and subtitle tools -- consuming the APIs built in Plan 02.
Output: New Statistics page, enhanced Settings with 2 new tabs, enhanced Logs page.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-i18n-backup-admin-polish/08-RESEARCH.md
@.planning/phases/08-i18n-backup-admin-polish/08-02-SUMMARY.md
@frontend/src/pages/Settings.tsx
@frontend/src/pages/Logs.tsx
@frontend/src/pages/Dashboard.tsx
@frontend/src/App.tsx
@frontend/src/components/layout/Sidebar.tsx
@frontend/src/hooks/useApi.ts
@frontend/src/api/client.ts
@frontend/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Statistics page with Recharts charts, time-range filter, and export</name>
  <files>
    frontend/src/pages/Statistics.tsx
    frontend/src/components/charts/TranslationChart.tsx
    frontend/src/components/charts/ProviderChart.tsx
    frontend/src/components/charts/FormatChart.tsx
    frontend/src/components/charts/DownloadChart.tsx
    frontend/src/hooks/useApi.ts
    frontend/src/api/client.ts
    frontend/src/lib/types.ts
    frontend/src/App.tsx
    frontend/src/components/layout/Sidebar.tsx
  </files>
  <action>
**Install Recharts:**
```bash
cd frontend && npm install recharts
```

**types.ts additions:**
Add to `frontend/src/lib/types.ts`:
```typescript
export interface StatisticsData {
  daily: DailyStat[]
  providers: Record<string, ProviderHealthStats>
  downloads_by_provider: Array<{ provider_name: string; count: number; avg_score: number }>
  backend_stats: Array<{ backend_name: string; total_requests: number; successful_translations: number; failed_translations: number; total_characters: number }>
  upgrades: Array<{ transition: string; count: number }>
  range: string
}
```

**client.ts additions:**
Add API functions:
- `getStatistics(range: string): Promise<StatisticsData>` -- GET `/api/v1/statistics?range=${range}`
- `exportStatistics(range: string, format: 'json' | 'csv'): Promise<Blob>` -- GET `/api/v1/statistics/export?range=${range}&format=${format}` with `responseType: 'blob'`

**useApi.ts additions:**
- `useStatistics(range: string)` -- useQuery with queryKey `['statistics', range]`, refetchInterval 60000
- `useExportStatistics()` -- useMutation calling exportStatistics, triggers browser download on success

**Chart components** (create `frontend/src/components/charts/` directory):

**TranslationChart.tsx:**
- Accepts `data: DailyStat[]` prop
- Uses Recharts `AreaChart` inside `ResponsiveContainer` (width 100%, height 300)
- Two Area series: `translated` (stroke: var(--accent), fill: var(--accent-subtle)) and `failed` (stroke: var(--error), fill: var(--error-bg))
- XAxis: `dataKey="date"`, formatted short (MM/DD), stroke: var(--text-muted)
- YAxis: stroke: var(--text-muted)
- CartesianGrid: strokeDasharray="3 3", stroke: var(--border)
- Tooltip: contentStyle using var(--bg-surface), var(--border), var(--radius-md) -- matches app theme
- Data should be reversed (API returns DESC, chart needs ASC)
- Add `key={theme}` prop on ResponsiveContainer parent div to force re-render on theme change (import useTheme or use a theme context)

**ProviderChart.tsx:**
- Accepts `data: Record<string, ProviderHealthStats>` prop
- Uses Recharts `BarChart` with horizontal bars
- Transform data to array: `[{ name, searches, downloads }]`
- Two Bar series: total_searches (var(--accent)), successful_downloads (var(--success))
- Same tooltip styling as TranslationChart

**FormatChart.tsx:**
- Accepts `data: Record<string, number>` prop (by_format from daily stats aggregation)
- Uses Recharts `PieChart` with `Pie` component
- Colors: ASS = var(--accent), SRT = var(--warning), other = var(--text-muted)
- Show labels with percentage
- Responsive container, 250px height

**DownloadChart.tsx:**
- Accepts `data: Array<{ provider_name: string; count: number; avg_score: number }>` prop
- Uses Recharts `BarChart`
- Single Bar for download count, colored by provider (use a color palette based on var(--accent) with varying opacity)
- Tooltip shows avg_score alongside count

**Statistics.tsx page:**
- State: `range` (default '30d'), range selector buttons (7d, 30d, 90d, 365d)
- Use `useStatistics(range)` hook
- Layout: Header with title "Statistics" + range filter buttons + export dropdown (JSON/CSV)
- Two-column grid on lg, single column on mobile
- Row 1: TranslationChart (full width) with card wrapper
- Row 2: ProviderChart (left) + FormatChart (right)
- Row 3: DownloadChart (full width)
- Each chart in a card div with title (same .card class pattern)
- Export button: dropdown with "Export JSON" and "Export CSV" options. On click, call exportStatistics mutation then trigger browser download via URL.createObjectURL + hidden anchor click
- Loading state: skeleton placeholders for chart areas
- Empty state: "No statistics data yet" message if daily array is empty

**App.tsx:**
- Import `StatisticsPage` from `@/pages/Statistics`
- Add route: `<Route path="/statistics" element={<StatisticsPage />} />`

**Sidebar.tsx:**
- Add `BarChart3` icon import from lucide-react
- Add `{ to: '/statistics', label: 'Statistics', icon: BarChart3 }` to the System nav group, between Settings and Logs
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
2. `cd frontend && npm run build` -- builds successfully
3. Navigate to /statistics: page renders with charts and range filter
4. Click range buttons: charts update with new data
5. Click export: file downloads in browser
6. Sidebar shows "Statistics" link in System group
  </verify>
  <done>
- Statistics page renders 4 chart types with Recharts
- Time-range filter (7d/30d/90d/365d) controls all charts
- Export as JSON or CSV triggers browser download
- Statistics accessible from sidebar navigation
- Charts use CSS custom properties for theme compatibility
  </done>
</task>

<task type="auto">
  <name>Task 2: Backup Settings tab, Subtitle Tools Settings tab, Logs page enhancements</name>
  <files>
    frontend/src/pages/Settings.tsx
    frontend/src/pages/Logs.tsx
    frontend/src/hooks/useApi.ts
    frontend/src/api/client.ts
    frontend/src/lib/types.ts
  </files>
  <action>
**types.ts additions:**
```typescript
export interface FullBackupInfo {
  filename: string
  size_bytes: number
  created_at: string
  contents: string[]
}

export interface SubtitleToolResult {
  status: string
  [key: string]: unknown
}

export interface LogRotationConfig {
  max_size_mb: number
  backup_count: number
}
```

**client.ts additions:**
- `createFullBackup(): Promise<FullBackupInfo>` -- POST `/api/v1/backup/full`
- `listFullBackups(): Promise<{ backups: FullBackupInfo[] }>` -- GET `/api/v1/backup/full/list`
- `downloadFullBackup(filename: string): string` -- returns URL string `/api/v1/backup/full/download/${filename}` (direct link, not API call)
- `restoreFullBackup(file: File): Promise<{ status: string; config_imported: string[]; db_restored: boolean }>` -- POST `/api/v1/backup/full/restore` with FormData
- `getLogRotation(): Promise<LogRotationConfig>` -- GET `/api/v1/logs/rotation`
- `updateLogRotation(config: LogRotationConfig): Promise<LogRotationConfig>` -- PUT `/api/v1/logs/rotation`
- `runSubtitleTool(tool: string, params: Record<string, unknown>): Promise<SubtitleToolResult>` -- POST `/api/v1/tools/${tool}`
- `previewSubtitle(filePath: string): Promise<{ format: string; lines: string[]; total_lines: number }>` -- GET `/api/v1/tools/preview?file_path=${filePath}`

**useApi.ts additions:**
- `useFullBackups()` -- useQuery `['full-backups']`
- `useCreateFullBackup()` -- useMutation, invalidates `['full-backups']` on success
- `useRestoreFullBackup()` -- useMutation, invalidates `['full-backups', 'config']` on success
- `useLogRotation()` -- useQuery `['log-rotation']`
- `useUpdateLogRotation()` -- useMutation, invalidates `['log-rotation']`
- `useSubtitleTool()` -- useMutation for running any tool

**Settings.tsx -- Backup tab:**
Add 'Backup' to the TABS array (after 'Scoring', before 'Notifications').

Backup tab content:
1. **Create Backup** card: Button "Create Full Backup" with Database icon. On click: call createFullBackup mutation, show loading spinner, toast success with filename.
2. **Backup List** card: Table of existing ZIP backups with columns: Filename, Size (formatted as MB), Created At (relative time). Each row has Download button (opens download URL in new tab) and a Restore button (with confirmation dialog).
3. **Restore from File** card: File upload input accepting `.zip` files. On file select, show filename and "Restore" button. On click: call restoreFullBackup with the file, show loading state, toast result (imported keys + db restored). Include warning text: "API keys will need to be re-entered after restore."
4. **Auto-Backup** card: Note that the existing database backup scheduler handles daily backups. Show the current config (backup_retention_daily, backup_retention_weekly, backup_retention_monthly) from the existing config fields if they're in the FIELDS array. If not, add them as read-only display.

All cards use the collapsible card pattern consistent with other Settings tabs.

**Settings.tsx -- Subtitle Tools tab:**
Add 'Subtitle Tools' to the TABS array (after 'Backup').

Subtitle Tools tab content:
1. **Remove HI Markers** card: Text input for file path, "Remove" button. Shows result (lines removed count) on success.
2. **Adjust Timing** card: Text input for file path, number input for offset_ms (with +/- label showing "delay" or "advance"), "Apply" button. Shows result on success.
3. **Common Fixes** card: Text input for file path, checkbox group for fixes (Encoding, Whitespace, Line Breaks, Empty Lines), "Apply" button. Shows result on success.
4. **Preview** section: Text input for file path, "Preview" button. Renders first 100 lines in a monospace-font scrollable code block with syntax coloring for ASS/SRT keywords.

Each tool card shows a brief description of what the tool does. Include a caution note: "A backup (.bak) is created before any modification."

**Logs.tsx enhancements:**
1. Add Download button in the header toolbar (next to the pause/play and level filter). Uses Download icon from lucide-react. On click: opens `/api/v1/logs/download` as direct link (window.open or anchor tag with download attribute).
2. Add a collapsible "Rotation Config" section at the bottom of the page:
   - Load current rotation config via `useLogRotation()`
   - Show two inputs: "Max Size (MB)" (number, 1-100) and "Backup Count" (number, 1-20)
   - Save button calls `useUpdateLogRotation()`
   - Note text: "Changes take effect on next restart."
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
2. `cd frontend && npm run build` -- builds successfully
3. Settings page: Backup tab visible, shows create/list/restore/upload controls
4. Settings page: Subtitle Tools tab visible, shows 3 tool forms + preview
5. Logs page: Download button visible, rotation config expandable at bottom
  </verify>
  <done>
- Backup tab: create, list, download, restore from file, auto-backup info
- Subtitle Tools tab: HI removal, timing adjustment, common fixes, preview
- Logs page: download button, rotation config section
- All new UI follows existing collapsible card pattern
- All API calls use TanStack Query hooks
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` succeeds
2. Statistics page renders at /statistics with 4 charts
3. Range filter updates chart data
4. Export downloads file in JSON or CSV format
5. Backup tab creates ZIP, lists backups, enables download and restore
6. Subtitle Tools tab renders 3 tool forms
7. Logs page download button works
8. Logs page rotation config loads and saves
</verification>

<success_criteria>
- BKUP-03 (Backup UI): Settings tab with download, upload, auto-toggle -- COMPLETE
- ADMN-01 (Statistics Page): Charts, time-range filters, export -- COMPLETE
- ADMN-02 (Log Improvements): Level filter (existing), download, rotation config -- COMPLETE
- ADMN-04 (Subtitle Processing Tools): UI for HI removal, timing, common fixes -- COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/08-i18n-backup-admin-polish/08-03-SUMMARY.md`
</output>

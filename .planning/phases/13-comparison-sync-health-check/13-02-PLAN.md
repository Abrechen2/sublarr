---
phase: 13-comparison-sync-health-check
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/api/client.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/components/comparison/SubtitleComparison.tsx
  - frontend/src/components/comparison/ComparisonPanel.tsx
  - frontend/src/components/comparison/ComparisonSelector.tsx
  - frontend/src/components/sync/SyncControls.tsx
  - frontend/src/components/sync/SyncPreview.tsx
  - frontend/src/pages/SeriesDetail.tsx
autonomous: true

must_haves:
  truths:
    - "User can compare 2-4 subtitle files side-by-side with syntax highlighting"
    - "User can select which files to compare from available subtitle versions for an episode"
    - "User can adjust subtitle timing with offset, speed multiplier, and framerate controls"
    - "User can preview timing changes before applying them"
    - "Sync controls and comparison are accessible from the Series Detail page"
  artifacts:
    - path: "frontend/src/components/comparison/SubtitleComparison.tsx"
      provides: "Multi-panel comparison grid (2-4 panels)"
      min_lines: 60
    - path: "frontend/src/components/comparison/ComparisonPanel.tsx"
      provides: "Single CodeMirror read-only panel with label"
      min_lines: 40
    - path: "frontend/src/components/comparison/ComparisonSelector.tsx"
      provides: "File picker for selecting 2-4 files to compare"
      min_lines: 50
    - path: "frontend/src/components/sync/SyncControls.tsx"
      provides: "Offset/speed/framerate input controls with apply button"
      min_lines: 80
    - path: "frontend/src/components/sync/SyncPreview.tsx"
      provides: "Before/after timing preview for representative events"
      min_lines: 40
  key_links:
    - from: "frontend/src/components/comparison/SubtitleComparison.tsx"
      to: "/api/v1/tools/compare"
      via: "API call to fetch multi-file content"
      pattern: "tools/compare"
    - from: "frontend/src/components/sync/SyncControls.tsx"
      to: "/api/v1/tools/advanced-sync"
      via: "API call for sync operations"
      pattern: "tools/advanced-sync"
    - from: "frontend/src/pages/SeriesDetail.tsx"
      to: "SubtitleComparison"
      via: "Modal/panel integration for episode comparison"
      pattern: "import.*SubtitleComparison"
    - from: "frontend/src/pages/SeriesDetail.tsx"
      to: "SyncControls"
      via: "Modal/panel integration for timing sync"
      pattern: "import.*SyncControls"
---

<objective>
Frontend comparison (multi-panel diff) and sync (timing adjustment) components with SeriesDetail integration.

Purpose: Enable users to compare subtitle versions side-by-side (2-4 panels) and adjust timing with a visual sync UI. These are the primary interactive features of Phase 13, accessed from the Series Detail page.

Output: SubtitleComparison (grid of ComparisonPanels), ComparisonSelector (file picker), SyncControls + SyncPreview, TypeScript types, API hooks, SeriesDetail integration with Compare and Sync buttons per episode.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-comparison-sync-health-check/13-RESEARCH.md
@.planning/phases/13-comparison-sync-health-check/13-01-SUMMARY.md

@frontend/src/lib/types.ts
@frontend/src/api/client.ts
@frontend/src/hooks/useApi.ts
@frontend/src/components/editor/SubtitleDiff.tsx
@frontend/src/components/editor/editor-theme.ts
@frontend/src/components/editor/lang-ass.ts
@frontend/src/components/editor/lang-srt.ts
@frontend/src/pages/SeriesDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, API client functions, and React Query hooks</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/api/client.ts
    frontend/src/hooks/useApi.ts
  </files>
  <action>
**Add to `frontend/src/lib/types.ts`:**

```typescript
// ─── Health Check & Quality ─────────────────────────────────────────────────

export interface HealthIssue {
  check: string
  severity: 'error' | 'warning' | 'info'
  message: string
  line: number | null
  auto_fixable: boolean
  fix: string | null
}

export interface HealthCheckResult {
  file_path: string
  checks_run: number
  issues: HealthIssue[]
  score: number
  checked_at: string
}

export interface HealthCheckBatchResult {
  results: HealthCheckResult[]
  summary: {
    total: number
    avg_score: number
    total_issues: number
  }
}

export interface HealthFixResult {
  status: string
  fixes_applied: string[]
  counts: Record<string, number>
  new_score: number
  remaining_issues: number
}

export interface QualityTrend {
  date: string
  avg_score: number
  issues_count: number
  files_checked: number
}

// ─── Comparison ─────────────────────────────────────────────────────────────

export interface ComparisonPanel {
  path: string
  content: string
  format: 'ass' | 'srt'
  encoding: string
  total_lines: number
}

export interface ComparisonResponse {
  panels: ComparisonPanel[]
}

// ─── Sync ───────────────────────────────────────────────────────────────────

export interface SyncPreviewEvent {
  index: number
  before_start: string
  before_end: string
  after_start: string
  after_end: string
  text: string
}

export interface SyncResult {
  status: string
  operation: string
  events: number
}

export interface SyncPreviewResult {
  preview: SyncPreviewEvent[]
  operation: string
  total_events: number
}
```

**Add to `frontend/src/api/client.ts`:**

Add these functions at the end (before any default export if present), in a new section `// ─── Health Check & Sync ─────`:

```typescript
export async function runHealthCheck(filePath: string): Promise<HealthCheckResult> {
  const { data } = await api.post('/tools/health-check', { file_path: filePath })
  return data
}

export async function runHealthCheckBatch(filePaths: string[]): Promise<HealthCheckBatchResult> {
  const { data } = await api.post('/tools/health-check', { file_paths: filePaths })
  return data
}

export async function applyHealthFix(filePath: string, fixes: string[]): Promise<HealthFixResult> {
  const { data } = await api.post('/tools/health-fix', { file_path: filePath, fixes })
  return data
}

export async function getQualityTrends(days?: number): Promise<{ trends: QualityTrend[]; days: number }> {
  const { data } = await api.get('/tools/quality-trends', { params: { days } })
  return data
}

export async function compareSubtitles(filePaths: string[]): Promise<ComparisonResponse> {
  const { data } = await api.post('/tools/compare', { file_paths: filePaths })
  return data
}

export async function advancedSync(
  filePath: string,
  operation: 'offset' | 'speed' | 'framerate',
  params: Record<string, number>,
  preview?: boolean
): Promise<SyncResult | SyncPreviewResult> {
  const { data } = await api.post('/tools/advanced-sync', {
    file_path: filePath,
    operation,
    ...params,
    preview: preview ?? false,
  })
  return data
}
```

Add the proper type imports at the top of client.ts (in the existing import block from `@/lib/types`).

**Add to `frontend/src/hooks/useApi.ts`:**

Add these hooks (import the new API functions at the top alongside existing imports):

```typescript
// Health Check hooks
export function useHealthCheck(filePath: string | null) {
  return useQuery({
    queryKey: ['health-check', filePath],
    queryFn: () => runHealthCheck(filePath!),
    enabled: !!filePath,
    staleTime: 5 * 60 * 1000, // 5 min cache
  })
}

export function useHealthFix() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ filePath, fixes }: { filePath: string; fixes: string[] }) =>
      applyHealthFix(filePath, fixes),
    onSuccess: (_data, variables) => {
      void qc.invalidateQueries({ queryKey: ['health-check', variables.filePath] })
    },
  })
}

export function useQualityTrends(days?: number) {
  return useQuery({
    queryKey: ['quality-trends', days],
    queryFn: () => getQualityTrends(days),
    staleTime: 10 * 60 * 1000, // 10 min cache
  })
}

// Comparison hooks
export function useCompareSubtitles() {
  return useMutation({
    mutationFn: (filePaths: string[]) => compareSubtitles(filePaths),
  })
}

// Sync hooks
export function useAdvancedSync() {
  return useMutation({
    mutationFn: ({
      filePath,
      operation,
      params,
      preview,
    }: {
      filePath: string
      operation: 'offset' | 'speed' | 'framerate'
      params: Record<string, number>
      preview?: boolean
    }) => advancedSync(filePath, operation, params, preview),
  })
}
```
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | head -20` -- TypeScript compiles with zero errors related to the new types/functions.
  </verify>
  <done>
All Phase 13 TypeScript types (HealthIssue, HealthCheckResult, ComparisonPanel, SyncPreviewEvent, QualityTrend, etc.) exist in types.ts. API client has 6 new functions. useApi.ts has 5 new hooks (useHealthCheck, useHealthFix, useQualityTrends, useCompareSubtitles, useAdvancedSync). TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comparison + Sync components and SeriesDetail integration</name>
  <files>
    frontend/src/components/comparison/SubtitleComparison.tsx
    frontend/src/components/comparison/ComparisonPanel.tsx
    frontend/src/components/comparison/ComparisonSelector.tsx
    frontend/src/components/sync/SyncControls.tsx
    frontend/src/components/sync/SyncPreview.tsx
    frontend/src/pages/SeriesDetail.tsx
  </files>
  <action>
**Create `frontend/src/components/comparison/ComparisonPanel.tsx`:**
A single read-only CodeMirror panel with a label header. Props: `{label: string, content: string, format: 'ass' | 'srt', onScroll?: (lineNumber: number) => void}`.
- Import `CodeMirror` from `@uiw/react-codemirror`, `EditorView` from `@codemirror/view`, `EditorState` from `@codemirror/state`.
- Import `assLanguage`, `srtLanguage`, `sublarrTheme` from the editor directory.
- Set `EditorState.readOnly.of(true)`, `EditorView.lineWrapping`.
- Render with label bar (styled like existing DiffHeader: bg-slate-800/60, border-slate-700) + CodeMirror below, flex-1 overflow-auto.
- onScroll: attach `EditorView.domEventHandlers({ scroll })` that computes visible line number and calls callback.

**Create `frontend/src/components/comparison/ComparisonSelector.tsx`:**
File picker that lets user select 2-4 subtitle files from a given list. Props: `{availableFiles: Array<{path: string, label: string}>, onCompare: (paths: string[]) => void, maxPanels?: number}`.
- Render checkboxes or toggle buttons for each available file. Teal accent for selected.
- "Compare" button enabled when 2-4 files selected.
- Show selected count: "2 of 4 selected".

**Create `frontend/src/components/comparison/SubtitleComparison.tsx`:**
Multi-panel grid comparison. Props: `{filePaths: string[], onClose?: () => void}`.
- Use `useCompareSubtitles` mutation -- trigger on mount (useEffect with filePaths).
- Loading state: skeleton grid.
- Render ComparisonPanel instances in CSS grid:
  - 2 panels: `grid-cols-2`
  - 3 panels: `grid-cols-2 grid-rows-2` (third panel spans or sits alone)
  - 4 panels: `grid-cols-2 grid-rows-2`
- Implement scroll synchronization: when one panel scrolls, update all others to the same line number via ref callbacks. Use `useRef` to store EditorView refs and debounce (50ms) to prevent cascading scroll events.
- Header bar with "Comparison View" title and close button.

**Create `frontend/src/components/sync/SyncControls.tsx`:**
Timing sync UI. Props: `{filePath: string, onSynced?: () => void, onClose?: () => void}`.
- Three operation tabs: Offset | Speed | Framerate (styled as inline tab buttons, teal active).
- **Offset tab:** number input for offset_ms (with +/- buttons for 100ms increments), unit label "ms".
- **Speed tab:** number input for speed_factor (range 0.5-2.0, step 0.01), with preset buttons (0.95, 1.0, 1.05).
- **Framerate tab:** two dropdowns for in_fps and out_fps with common values (23.976, 24, 25, 29.97, 30).
- "Preview" button calls `useAdvancedSync` with `preview: true`, shows result in SyncPreview.
- "Apply" button calls `useAdvancedSync` with `preview: false`, shows success toast, calls `onSynced()`.
- Apply button has confirmation tooltip: "This will modify the file. A backup will be created."

**Create `frontend/src/components/sync/SyncPreview.tsx`:**
Before/after timing preview. Props: `{events: SyncPreviewEvent[], operation: string}`.
- Render a table with columns: #, Before Start, Before End, After Start, After End, Text (truncated to 40 chars).
- Changed timestamps highlighted in teal. Use monospace font for timestamp columns.
- Show total event count at bottom.

**Integrate into `frontend/src/pages/SeriesDetail.tsx`:**
- Add lazy imports for SubtitleComparison, ComparisonSelector, and SyncControls:
  ```typescript
  const SubtitleComparison = lazy(() => import('@/components/comparison/SubtitleComparison').then(m => ({ default: m.SubtitleComparison })))
  const SyncControls = lazy(() => import('@/components/sync/SyncControls').then(m => ({ default: m.SyncControls })))
  ```
- Add state: `comparisonPaths: string[] | null`, `syncFilePath: string | null`.
- Per episode row, add two new icon buttons (after existing preview/edit buttons):
  - **Compare** button (lucide `Columns2` or `SplitSquareHorizontal` icon): opens ComparisonSelector modal pre-populated with available subtitle files for that episode (derive from episode subs list using `deriveSubtitlePath` helper). On select, set `comparisonPaths`.
  - **Sync** button (lucide `Timer` icon): opens SyncControls for the episode's primary subtitle file.
- When `comparisonPaths` is set, render SubtitleComparison in a full-screen modal (similar to SubtitleEditorModal pattern -- overlay + large panel). On close, set comparisonPaths to null.
- When `syncFilePath` is set, render SyncControls in a modal panel. On close or onSynced, clear state and invalidate series detail query.
- Only show Compare button when episode has 2+ subtitle files. Only show Sync button when episode has at least 1 subtitle file.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | head -20` -- zero TypeScript errors.
`cd frontend && npm run build 2>&1 | tail -5` -- build succeeds.
  </verify>
  <done>
SubtitleComparison renders 2-4 panels in a synchronized scrolling CSS grid. ComparisonSelector lets users pick files with teal toggle buttons. SyncControls offers offset/speed/framerate tabs with preview and apply. SyncPreview shows before/after timestamps in a table. SeriesDetail has Compare and Sync icon buttons per episode row that open the respective modals. Frontend builds with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero errors.
2. `cd frontend && npm run build` -- production build succeeds.
3. SeriesDetail page has Compare and Sync buttons visible per episode.
4. ComparisonSelector allows selecting 2-4 files and triggers comparison view.
5. SyncControls has three operation tabs with preview functionality.
</verification>

<success_criteria>
- User can open a comparison view from SeriesDetail showing 2-4 subtitle panels side-by-side with syntax highlighting
- User can select which files to compare from available episode subtitles
- Panels scroll together (line-number-based sync)
- User can adjust timing via offset, speed, or framerate controls
- User can preview changes before applying (5 representative events with before/after timestamps)
- Frontend compiles and builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-comparison-sync-health-check/13-02-SUMMARY.md`
</output>

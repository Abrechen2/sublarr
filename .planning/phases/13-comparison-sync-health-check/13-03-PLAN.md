---
phase: 13-comparison-sync-health-check
plan: 03
type: execute
wave: 3
depends_on: ["13-01", "13-02"]
files_modified:
  - frontend/src/components/health/HealthBadge.tsx
  - frontend/src/components/health/HealthCheckPanel.tsx
  - frontend/src/components/health/HealthDashboardWidget.tsx
  - frontend/src/components/charts/QualityTrendChart.tsx
  - frontend/src/components/charts/ProviderSuccessChart.tsx
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/pages/SeriesDetail.tsx
autonomous: true

must_haves:
  truths:
    - "Health check results are displayed as color-coded badges per subtitle file"
    - "User can view detailed health issues and apply auto-fixes with one click"
    - "User can preview what auto-fix will do before applying it"
    - "Quality trend chart shows average score over time on the dashboard"
    - "Provider success rate chart is visible in the dashboard"
    - "Per-series health overview is visible on the Series Detail page"
  artifacts:
    - path: "frontend/src/components/health/HealthBadge.tsx"
      provides: "Color-coded quality score badge (green/amber/red)"
      min_lines: 20
    - path: "frontend/src/components/health/HealthCheckPanel.tsx"
      provides: "Detailed issue list with auto-fix buttons and preview"
      min_lines: 100
    - path: "frontend/src/components/health/HealthDashboardWidget.tsx"
      provides: "Dashboard widget with quality summary + issue counts"
      min_lines: 60
    - path: "frontend/src/components/charts/QualityTrendChart.tsx"
      provides: "Line chart showing avg quality score over time"
      min_lines: 30
    - path: "frontend/src/components/charts/ProviderSuccessChart.tsx"
      provides: "Bar chart showing provider download success rates"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/health/HealthCheckPanel.tsx"
      to: "/api/v1/tools/health-check"
      via: "useHealthCheck hook"
      pattern: "useHealthCheck"
    - from: "frontend/src/components/health/HealthCheckPanel.tsx"
      to: "/api/v1/tools/health-fix"
      via: "useHealthFix mutation"
      pattern: "useHealthFix"
    - from: "frontend/src/components/health/HealthDashboardWidget.tsx"
      to: "/api/v1/tools/quality-trends"
      via: "useQualityTrends hook"
      pattern: "useQualityTrends"
    - from: "frontend/src/pages/Dashboard.tsx"
      to: "HealthDashboardWidget"
      via: "Direct import and render"
      pattern: "import.*HealthDashboardWidget"
    - from: "frontend/src/pages/SeriesDetail.tsx"
      to: "HealthBadge"
      via: "Per-episode health badge rendering"
      pattern: "import.*HealthBadge"
---

<objective>
Frontend health check UI (badges, detail panel, auto-fix), quality metrics charts, and dashboard widget integration.

Purpose: Enable users to see subtitle quality at a glance (badges), drill into specific issues (panel), fix problems with one click (auto-fix), and track quality trends over time (charts/dashboard). This completes the Phase 13 user experience.

Output: HealthBadge, HealthCheckPanel (with auto-fix + preview), HealthDashboardWidget, QualityTrendChart, ProviderSuccessChart. Dashboard gets quality widget. SeriesDetail gets health badges per episode.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-comparison-sync-health-check/13-RESEARCH.md
@.planning/phases/13-comparison-sync-health-check/13-01-SUMMARY.md

@frontend/src/lib/types.ts
@frontend/src/hooks/useApi.ts
@frontend/src/pages/Dashboard.tsx
@frontend/src/pages/SeriesDetail.tsx
@frontend/src/components/charts/DownloadChart.tsx
@frontend/src/components/charts/ProviderChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Health components (HealthBadge, HealthCheckPanel, HealthDashboardWidget)</name>
  <files>
    frontend/src/components/health/HealthBadge.tsx
    frontend/src/components/health/HealthCheckPanel.tsx
    frontend/src/components/health/HealthDashboardWidget.tsx
  </files>
  <action>
**Create `frontend/src/components/health/HealthBadge.tsx`:**
Small inline badge showing quality score. Props: `{score: number | null, size?: 'sm' | 'md'}`.
- Color coding: score >= 80 = green (var(--success)), 50-79 = amber (var(--warning)), <50 = red (var(--error)).
- Null score (not yet checked) = gray with "?" text.
- `sm` size: 16px circle with score number. `md` size: pill shape showing "Score: 85" text.
- Tooltip on hover showing "Quality Score: X/100".
- Use lucide `ShieldCheck` icon for md variant prefix.

**Create `frontend/src/components/health/HealthCheckPanel.tsx`:**
Detailed health check view for a single file. Props: `{filePath: string, onClose?: () => void}`.
- Uses `useHealthCheck(filePath)` to load results.
- Loading state: spinner with "Running health checks...".
- **Header:** File name (extracted from path), HealthBadge (md), "Re-check" button (lucide RefreshCw).
- **Issue list:** Grouped by severity (errors first, then warnings, then info).
  - Each issue row: severity icon (XCircle red for error, AlertTriangle amber for warning, Info blue for info), message text, line number badge if present.
  - If `auto_fixable`: show "Fix" button (lucide Wrench icon) per-issue that calls `useHealthFix` with just that check name.
  - On fix button hover, show tooltip with `fix` description text (preview of what it does).
- **Batch fix section:** At top, if any issues are auto_fixable, show "Fix All ({N})" teal button.
  - Before applying: show confirmation with list of fixes that will be applied.
  - After fix: re-fetch health check, show success toast with `"Fixed {N} issues. New score: {score}"`.
- **Empty state:** When no issues found, show CheckCircle2 green icon with "No issues found. Score: 100".
- Style following existing panel patterns: bg-surface, border, rounded-lg. Max height with scroll for long issue lists.

**Create `frontend/src/components/health/HealthDashboardWidget.tsx`:**
Dashboard card widget. Props: `{className?: string}`.
- Uses `useQualityTrends(30)` to load last 30 days of quality data.
- **Header:** "Subtitle Quality" title with ShieldCheck icon.
- **Summary row:** Current avg score (large number + HealthBadge), total files checked, total issues found.
- **Mini trend chart:** Small sparkline-style LineChart (Recharts) showing avg_score over last 30 days. Height ~80px. Teal line color. No axis labels (compact).
- Loading: skeleton card matching dimensions.
- Empty state (no data): "No health data yet. Run a health check from Series Detail."
- Card style: matches existing StatCard pattern (bg-surface, border, rounded-lg, hover shadow).
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | head -20` -- zero TypeScript errors.
  </verify>
  <done>
HealthBadge renders color-coded score badges (green/amber/red/gray). HealthCheckPanel shows grouped issues with per-issue and batch auto-fix buttons plus fix preview tooltips. HealthDashboardWidget shows quality summary with mini trend sparkline. All components compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Quality charts + Dashboard and SeriesDetail integration</name>
  <files>
    frontend/src/components/charts/QualityTrendChart.tsx
    frontend/src/components/charts/ProviderSuccessChart.tsx
    frontend/src/pages/Dashboard.tsx
    frontend/src/pages/SeriesDetail.tsx
  </files>
  <action>
**Create `frontend/src/components/charts/QualityTrendChart.tsx`:**
Full-size quality trend line chart (for Statistics or standalone view). Props: `{data: QualityTrend[], height?: number}`.
- Uses Recharts `LineChart` with `ResponsiveContainer`.
- X axis: date (formatted short). Y axis: 0-100 domain (quality score).
- Two lines: `avg_score` (teal, var(--accent)) and `issues_count` (secondary axis, red-ish).
- Tooltip styled with Sublarr theme (bg-surface, border, rounded).
- Follow exact patterns from existing chart components (see DownloadChart.tsx, ProviderChart.tsx).

**Create `frontend/src/components/charts/ProviderSuccessChart.tsx`:**
Bar chart showing provider download success rates. Props: `{data: Array<{provider: string, success: number, failed: number}>, height?: number}`.
- Uses Recharts `BarChart` with stacked bars.
- Green for success, red for failed.
- X axis: provider names. Y axis: count.
- Tooltip shows success rate percentage.
- Follow same styling as existing chart components.

**Integrate into `frontend/src/pages/Dashboard.tsx`:**
- Add lazy import: `const HealthDashboardWidget = lazy(() => import('@/components/health/HealthDashboardWidget').then(m => ({ default: m.HealthDashboardWidget })))`.
- Add the widget in the dashboard layout. Position it after the existing stat cards section and before the recent activity section. Use Suspense wrapper with fallback SkeletonCard.
- The widget should be in its own row (full width) or in a 2-column grid alongside the existing provider status section.

**Integrate into `frontend/src/pages/SeriesDetail.tsx`:**
- Import `HealthBadge` (direct import, small component).
- Import `HealthCheckPanel` lazily for the detail view.
- Add state: `healthCheckPath: string | null` for opening the health panel.
- Per episode subtitle badge area: render a small HealthBadge next to each subtitle file badge. The score comes from a batch health check -- add a "Check Health" button (lucide ShieldCheck icon) per episode that runs health check on all subtitle files for that episode.
- When `healthCheckPath` is set, render HealthCheckPanel in a slide-over panel (right side, similar to search results panel pattern already in SeriesDetail) or a modal.
- Each issue's "Fix" button in the panel should also invalidate the series detail query on success (so badges update).
- Add to episode row action buttons: "Health" button (lucide `ShieldCheck` icon). Only shown when episode has at least 1 subtitle file. Opens health check for the primary subtitle.

NOTE: SeriesDetail.tsx is modified by Plan 02 (comparison/sync buttons) before this plan executes. Plan 03 is Wave 3 and depends on Plan 02 completion to avoid merge conflicts.
- Plan 02 (Wave 2) adds: `comparisonPaths` and `syncFilePath` state, Compare and Sync buttons.
- Plan 03 (Wave 3) adds: `healthCheckPath` state, Health button and HealthBadge/HealthCheckPanel.
- Plan 03 will READ SeriesDetail.tsx as already modified by Plan 02.
- The integration point is the episode action buttons row -- Plan 03 adds its Health button after the Compare/Sync buttons added by Plan 02.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit 2>&1 | head -20` -- zero TypeScript errors.
`cd frontend && npm run build 2>&1 | tail -5` -- production build succeeds.
  </verify>
  <done>
QualityTrendChart renders avg_score and issues_count over time. ProviderSuccessChart renders stacked success/failed bars. Dashboard has HealthDashboardWidget with quality summary and mini trend sparkline. SeriesDetail shows HealthBadge per episode subtitle and Health button that opens HealthCheckPanel with auto-fix capability. Frontend builds with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero errors.
2. `cd frontend && npm run build` -- production build succeeds.
3. Dashboard shows a "Subtitle Quality" widget with score summary and mini trend chart.
4. SeriesDetail shows Health button per episode with subtitle files.
5. HealthCheckPanel shows issues grouped by severity with Fix buttons.
6. Clicking "Fix All" applies fixes and updates the score badge.
</verification>

<success_criteria>
- Health badges show color-coded scores (green >= 80, amber 50-79, red < 50)
- HealthCheckPanel groups issues by severity with auto-fix buttons and preview tooltips
- Dashboard has quality metrics widget with sparkline trend chart
- QualityTrendChart and ProviderSuccessChart render with Recharts following existing chart patterns
- SeriesDetail has per-episode health check button and score badges
- Auto-fix applies changes, creates backup, and updates score in real-time
- Frontend compiles and builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-comparison-sync-health-check/13-03-SUMMARY.md`
</output>

---
phase: 11-subtitle-editor
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/components/editor/SubtitleEditor.tsx
  - frontend/src/components/editor/SubtitleDiff.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit subtitle content with undo/redo, line numbers, and syntax highlighting"
    - "Editor validates content in real-time and shows validation errors"
    - "Find-and-replace panel is accessible via Ctrl+H shortcut or toolbar button"
    - "Diff view shows side-by-side comparison of current content vs backup version"
    - "Editor tracks unsaved changes and warns before close"
  artifacts:
    - path: "frontend/src/components/editor/SubtitleEditor.tsx"
      provides: "Full-featured CodeMirror editor with toolbar, validation, and save"
      contains: "SubtitleEditor"
    - path: "frontend/src/components/editor/SubtitleDiff.tsx"
      provides: "Side-by-side diff comparison component"
      contains: "SubtitleDiff"
  key_links:
    - from: "frontend/src/components/editor/SubtitleEditor.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useSaveSubtitle and useValidateSubtitle hooks"
      pattern: "useSaveSubtitle|useValidateSubtitle"
    - from: "frontend/src/components/editor/SubtitleEditor.tsx"
      to: "@uiw/react-codemirror"
      via: "CodeMirror component with extensions"
      pattern: "CodeMirror|react-codemirror"
    - from: "frontend/src/components/editor/SubtitleDiff.tsx"
      to: "react-codemirror-merge"
      via: "CodeMirrorMerge with Original + Modified"
      pattern: "CodeMirrorMerge|react-codemirror-merge"
---

<objective>
Create the SubtitleEditor (full editing with CodeMirror, undo/redo, validation, save, toolbar) and SubtitleDiff (side-by-side backup comparison) components.

Purpose: Provides the editing experience (EDIT-03, EDIT-05) so users can modify subtitle files with professional editor features and compare changes against the backup version.
Output: SubtitleEditor.tsx and SubtitleDiff.tsx components.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-editor/11-RESEARCH.md
@.planning/phases/11-subtitle-editor/11-01-SUMMARY.md
@frontend/src/components/editor/lang-ass.ts
@frontend/src/components/editor/lang-srt.ts
@frontend/src/components/editor/editor-theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubtitleEditor component with toolbar, validation, and save</name>
  <files>frontend/src/components/editor/SubtitleEditor.tsx</files>
  <action>
Create the full-featured subtitle editor component.

**Props interface:**
```typescript
interface SubtitleEditorProps {
  filePath: string
  initialContent: string
  format: 'ass' | 'srt'
  lastModified: number
  onSave?: (newMtime: number) => void    // Called after successful save
  onClose?: () => void
  onDiffView?: () => void               // Switch to diff view
}
```

**State management:**
- `content` (string) -- current editor content, initialized from `initialContent`
- `hasChanges` (boolean) -- tracks if content differs from initial (set via onChange comparison)
- `validationResult` (SubtitleValidation | null) -- last validation result
- `isSaving` (boolean) -- save in progress
- `isValidating` (boolean) -- validation in progress

**CodeMirror setup:**
- Use `@uiw/react-codemirror` `<CodeMirror>` component
- Set `value` only as initial value (not on every render -- see research pitfall #2 about controlled vs uncontrolled)
- Use `onChange` callback to update `content` state and set `hasChanges = true`
- Extensions array:
  - `assLanguage` or `srtLanguage` based on `format` prop
  - `history()` from `@codemirror/commands` (undo/redo)
  - `search()` from `@codemirror/search` (find & replace panel)
  - `keymap.of([...defaultKeymap, ...historyKeymap, ...searchKeymap])` from appropriate packages
  - `EditorView.lineWrapping` for long lines
  - `lintGutter()` if lint diagnostics available (optional, skip if complex)
- Theme: `sublarrTheme` from editor-theme.ts
- `basicSetup` options: `{lineNumbers: true, foldGutter: true, highlightActiveLine: true, bracketMatching: false, autocompletion: false}`
- Maintain an `EditorView` ref via the `onCreateEditor` callback for programmatic control

**Toolbar (above editor):**
Render a horizontal toolbar with tailwind classes matching Sublarr's *arr-style:
- **Save button** (Save icon from lucide-react): Calls `useSaveSubtitle().mutateAsync({ filePath, content, lastModified })`. On success, call `onSave(result.new_mtime)` and set `hasChanges = false`. On 409 conflict, show conflict warning toast. On error, show error toast. Disabled when `!hasChanges` or `isSaving`.
- **Validate button** (CheckCircle icon): Calls `useValidateSubtitle().mutateAsync({ content, format })`. Shows green badge "Valid (N events, M styles)" or red badge "Invalid: error message". Triggered automatically 500ms after last change (debounced validation).
- **Find & Replace button** (Search icon): Programmatically opens the CodeMirror search panel via `openSearchPanel(view)` from `@codemirror/search`
- **Undo/Redo buttons** (Undo/Redo icons): Call `undo(view)` / `redo(view)` from `@codemirror/commands`
- **Diff View button** (GitCompare icon from lucide-react): Calls `onDiffView()` if provided
- **Close button** (X icon): If `hasChanges`, show "Unsaved changes" confirmation before calling `onClose()`

**Validation status bar (below editor):**
- Show format badge (ASS/SRT), line count, character count
- Show validation status: pending (gray), valid (green), invalid (red with error)
- Show "Unsaved changes" indicator when `hasChanges` is true

**Debounced validation:**
Use `useEffect` with a 500ms debounce timer on `content` changes. When content changes, set a timeout to call `validateSubtitle`. Clear timeout on unmount or new change. Only validate if content has actually changed from last validation.

**Keyboard shortcuts:**
- Ctrl+S: Save (prevent default browser save, call save handler)
- Ctrl+Z/Y: Handled by CodeMirror history extension
- Ctrl+H: Handled by CodeMirror search extension
- Escape: If search panel open, close it; otherwise, if no changes, call onClose

Register Ctrl+S via a custom keymap extension added to CodeMirror's keymap array.

**Unsaved changes guard:**
Use `useEffect` to add a `beforeunload` event listener when `hasChanges` is true, removing it when false. This prevents accidental page navigation with unsaved edits.
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript errors.
Grep for `SubtitleEditor` export and `useSaveSubtitle` usage in SubtitleEditor.tsx.
  </verify>
  <done>
SubtitleEditor renders a full CodeMirror editor with: ASS/SRT syntax highlighting, undo/redo, find-and-replace, debounced validation, save with backup + mtime conflict check, toolbar buttons, keyboard shortcuts (Ctrl+S), and unsaved changes guard.
  </done>
</task>

<task type="auto">
  <name>Task 2: SubtitleDiff component for backup comparison</name>
  <files>frontend/src/components/editor/SubtitleDiff.tsx</files>
  <action>
Create the diff view component using `react-codemirror-merge`.

**Props interface:**
```typescript
interface SubtitleDiffProps {
  filePath: string
  currentContent: string
  format: 'ass' | 'srt'
  onClose?: () => void
  onBackToEditor?: () => void
}
```

**Implementation:**
- Use `useSubtitleBackup(filePath)` to fetch the backup content
- Import `CodeMirrorMerge` from `react-codemirror-merge`
- Access `CodeMirrorMerge.Original` and `CodeMirrorMerge.Modified` sub-components
- Render a header bar with:
  - "Original (backup)" label on the left
  - "Modified (current)" label on the right
  - "Back to Editor" button (calls `onBackToEditor`)
  - "Close" button (calls `onClose`)
- Render `<CodeMirrorMerge>` with:
  - `<Original value={backupData.content} extensions={[language, sublarrTheme]} />`
  - `<Modified value={currentContent} extensions={[language, sublarrTheme]} />`
  - Where `language` is `assLanguage` or `srtLanguage` based on `format`
- Both sides should be read-only (diff view is for comparison, not editing)
- If backup not found (404), show message "No backup file found. Save your changes first to create a backup."
- Loading state: show spinner while backup is being fetched
- Error state: show error with retry

**Styling:**
- Full width of the modal/container
- Split view with equal columns
- Header labels use muted text color
- Change highlights use CodeMirror merge's built-in diff coloring (additions green-ish, deletions red-ish)
- Apply `sublarrTheme` to both sides for consistency
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript errors.
Grep for `SubtitleDiff` export and `CodeMirrorMerge` usage in SubtitleDiff.tsx.
  </verify>
  <done>
SubtitleDiff renders a side-by-side comparison of backup (original) vs current (modified) content using react-codemirror-merge, with syntax highlighting, header labels, and navigation buttons.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. Grep for `SubtitleEditor` export in SubtitleEditor.tsx
3. Grep for `SubtitleDiff` export in SubtitleDiff.tsx
4. Grep for `CodeMirrorMerge` in SubtitleDiff.tsx
5. Grep for `openSearchPanel` in SubtitleEditor.tsx (find & replace)
6. Grep for `history()` in SubtitleEditor.tsx (undo/redo)
</verification>

<success_criteria>
- SubtitleEditor provides full editing with syntax highlighting, undo/redo, find-and-replace, validation, and save
- SubtitleDiff shows side-by-side backup comparison with diff highlighting
- Save creates backup before writing (via API)
- Unsaved changes prompt before close
- All components compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-editor/11-03-SUMMARY.md`
</output>

---
phase: 11-subtitle-editor
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/api/client.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/components/editor/SubtitlePreview.tsx
  - frontend/src/components/editor/SubtitleTimeline.tsx
autonomous: true

must_haves:
  truths:
    - "SubtitlePreview displays file content with ASS or SRT syntax highlighting in a read-only CodeMirror view"
    - "SubtitleTimeline renders visual cue markers on a horizontal time axis based on parsed cue data"
    - "Clicking a cue in the timeline scrolls the preview to the corresponding line"
    - "API client functions for content, backup, validate, and parse endpoints are typed and functional"
    - "React Query hooks wrap all new API calls with proper caching and mutation patterns"
  artifacts:
    - path: "frontend/src/components/editor/SubtitlePreview.tsx"
      provides: "Read-only subtitle preview with syntax highlighting and timeline"
      contains: "SubtitlePreview"
    - path: "frontend/src/components/editor/SubtitleTimeline.tsx"
      provides: "Visual cue timeline bar"
      contains: "SubtitleTimeline"
    - path: "frontend/src/lib/types.ts"
      provides: "TypeScript interfaces for editor API responses"
      contains: "SubtitleContent"
    - path: "frontend/src/api/client.ts"
      provides: "API client functions for editor endpoints"
      contains: "getSubtitleContent"
    - path: "frontend/src/hooks/useApi.ts"
      provides: "React Query hooks for editor data"
      contains: "useSubtitleContent"
  key_links:
    - from: "frontend/src/components/editor/SubtitlePreview.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useSubtitleContent and useSubtitleParse hooks"
      pattern: "useSubtitleContent|useSubtitleParse"
    - from: "frontend/src/components/editor/SubtitlePreview.tsx"
      to: "frontend/src/components/editor/lang-ass.ts"
      via: "assLanguage extension for CodeMirror"
      pattern: "assLanguage|srtLanguage"
    - from: "frontend/src/components/editor/SubtitleTimeline.tsx"
      to: "frontend/src/components/editor/SubtitlePreview.tsx"
      via: "onCueClick callback for scroll-to-line"
      pattern: "onCueClick"
---

<objective>
Create the SubtitlePreview (read-only syntax-highlighted view) and SubtitleTimeline components, plus all TypeScript types, API client functions, and React Query hooks for the editor API endpoints.

Purpose: Provides the read-only preview experience that users access from Wanted, History, and SeriesDetail pages, and the typed API layer that the editor also depends on.
Output: SubtitlePreview.tsx, SubtitleTimeline.tsx, plus types/client/hooks extensions.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-editor/11-RESEARCH.md
@.planning/phases/11-subtitle-editor/11-01-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/api/client.ts
@frontend/src/hooks/useApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, API client functions, and React Query hooks</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/api/client.ts
    frontend/src/hooks/useApi.ts
  </files>
  <action>
**Add to types.ts** -- New interfaces in the Subtitle Tools section:

```typescript
export interface SubtitleContent {
  format: 'ass' | 'srt'
  content: string
  encoding: string
  size_bytes: number
  total_lines: number
  last_modified: number
}

export interface SubtitleSaveResult {
  status: string
  backup_path: string
  new_mtime: number
}

export interface SubtitleBackup {
  content: string
  encoding: string
  backup_path: string
}

export interface SubtitleValidation {
  valid: boolean
  error?: string
  event_count?: number
  style_count?: number
  warnings: string[]
}

export interface SubtitleCue {
  start: number    // seconds
  end: number      // seconds
  text: string
  style: string
}

export interface SubtitleParseResult {
  cues: SubtitleCue[]
  total_duration: number
  cue_count: number
  format: string
  styles: Record<string, string> | null  // style_name -> "dialog"|"signs"|"songs"
}
```

**Add to client.ts** -- New API functions in the Subtitle Tools section (after existing `previewSubtitle`):

```typescript
export async function getSubtitleContent(filePath: string): Promise<SubtitleContent> {
  const { data } = await api.get('/tools/content', { params: { file_path: filePath } })
  return data
}

export async function saveSubtitleContent(filePath: string, content: string, lastModified: number): Promise<SubtitleSaveResult> {
  const { data } = await api.put('/tools/content', { file_path: filePath, content, last_modified: lastModified })
  return data
}

export async function getSubtitleBackup(filePath: string): Promise<SubtitleBackup> {
  const { data } = await api.get('/tools/backup', { params: { file_path: filePath } })
  return data
}

export async function validateSubtitle(content: string, format?: string, filePath?: string): Promise<SubtitleValidation> {
  const { data } = await api.post('/tools/validate', { content, format, file_path: filePath })
  return data
}

export async function parseSubtitleCues(filePath: string): Promise<SubtitleParseResult> {
  const { data } = await api.post('/tools/parse', { file_path: filePath })
  return data
}
```

Import all new types at the top of client.ts.

**Add to useApi.ts** -- New hooks in the Subtitle Tools section (after existing `usePreviewSubtitle`):

```typescript
export function useSubtitleContent(filePath: string | null) {
  return useQuery({
    queryKey: ['subtitle-content', filePath],
    queryFn: () => getSubtitleContent(filePath!),
    enabled: !!filePath,
    staleTime: 0,  // Always refetch (file may change externally)
  })
}

export function useSubtitleParse(filePath: string | null) {
  return useQuery({
    queryKey: ['subtitle-parse', filePath],
    queryFn: () => parseSubtitleCues(filePath!),
    enabled: !!filePath,
    staleTime: 30_000,  // Cue data unlikely to change frequently
  })
}

export function useSubtitleBackup(filePath: string | null) {
  return useQuery({
    queryKey: ['subtitle-backup', filePath],
    queryFn: () => getSubtitleBackup(filePath!),
    enabled: !!filePath,
  })
}

export function useSaveSubtitle() {
  const queryClient = useQueryClient()
  return useMutation({
    mutationFn: ({ filePath, content, lastModified }: { filePath: string; content: string; lastModified: number }) =>
      saveSubtitleContent(filePath, content, lastModified),
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({ queryKey: ['subtitle-content', variables.filePath] })
      queryClient.invalidateQueries({ queryKey: ['subtitle-backup', variables.filePath] })
    },
  })
}

export function useValidateSubtitle() {
  return useMutation({
    mutationFn: ({ content, format, filePath }: { content: string; format?: string; filePath?: string }) =>
      validateSubtitle(content, format, filePath),
  })
}
```

Import `useQueryClient` from `@tanstack/react-query` if not already imported. Import all new client functions from `@/api/client`.
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript errors.
Grep for `useSubtitleContent` in useApi.ts and `getSubtitleContent` in client.ts.
  </verify>
  <done>
TypeScript interfaces (SubtitleContent, SubtitleSaveResult, SubtitleBackup, SubtitleValidation, SubtitleCue, SubtitleParseResult), 5 API client functions, and 5 React Query hooks are defined and type-safe.
  </done>
</task>

<task type="auto">
  <name>Task 2: SubtitlePreview and SubtitleTimeline components</name>
  <files>
    frontend/src/components/editor/SubtitlePreview.tsx
    frontend/src/components/editor/SubtitleTimeline.tsx
  </files>
  <action>
**Create `SubtitlePreview.tsx`** -- Read-only subtitle viewer with syntax highlighting:

Props interface:
```typescript
interface SubtitlePreviewProps {
  filePath: string
  onEdit?: () => void           // Optional callback to switch to edit mode
  onClose?: () => void          // Close preview
  className?: string
}
```

Implementation:
- Use `useSubtitleContent(filePath)` to fetch full file content
- Use `useSubtitleParse(filePath)` to fetch cue data for timeline
- Render a CodeMirror instance from `@uiw/react-codemirror` with:
  - `value={data.content}`
  - `editable={false}` and `readOnly={true}`
  - Extensions: `[assLanguage]` or `[srtLanguage]` based on `data.format`
  - Theme: `sublarrTheme` (import from editor-theme.ts)
  - `basicSetup` with `{lineNumbers: true, foldGutter: false, highlightActiveLine: false}`
- Store a ref to the EditorView for scroll-to-line functionality
- Render file metadata bar at top: format badge (ASS/SRT), encoding, total lines, file size
- Render `<SubtitleTimeline>` below the metadata bar with parsed cue data
- When a cue is clicked in the timeline, scroll CodeMirror to that approximate line position using `view.dispatch({ effects: EditorView.scrollIntoView(line_pos) })`
  - Estimate line from cue index: for ASS, dialogue lines start after header sections; for SRT, each cue is ~3-4 lines. Use `cueIndex` to calculate approximate line position.
- If `onEdit` prop provided, show an "Edit" button in the metadata bar (Pencil icon from lucide-react)
- Loading state: show a spinner (Loader2 from lucide-react with animate-spin class)
- Error state: show error message with retry button
- Use `useTranslation` from react-i18next for translatable strings (use 'editor' namespace). For this plan, use English strings as fallback -- i18n JSON files will be created in a later phase or can use inline defaults.

**Create `SubtitleTimeline.tsx`** -- Visual cue timeline:

Props interface:
```typescript
interface SubtitleTimelineProps {
  cues: SubtitleCue[]
  totalDuration: number
  onCueClick: (index: number) => void
  styles?: Record<string, string> | null  // style classification for color-coding
  className?: string
}
```

Implementation:
- Render a horizontal bar (`relative h-8 rounded overflow-hidden`) with background matching `bg-elevated`
- For each cue, render an absolutely positioned div:
  - `left = (cue.start / totalDuration) * 100%`
  - `width = max((cue.end - cue.start) / totalDuration * 100, 0.3)%` (min width for visibility)
  - Background color: teal for dialog cues, amber for signs/songs cues (use `styles` prop to determine)
  - `opacity-60 hover:opacity-100 cursor-pointer` transition
  - `title` attribute: `"HH:MM:SS - HH:MM:SS"` formatted from start/end seconds
  - onClick: call `onCueClick(index)`
- Add a time ruler below the bar showing evenly spaced time labels (e.g., "0:00", "5:00", "10:00", etc.)
- Helper function `formatTime(seconds: number): string` -- converts seconds to `H:MM:SS` or `MM:SS` format
- If `totalDuration === 0` or `cues.length === 0`, show a "No cues" placeholder
- Keep the component lightweight -- avoid React.memo unless performance issues arise
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript errors.
Grep for `SubtitlePreview` in SubtitlePreview.tsx and `SubtitleTimeline` in SubtitleTimeline.tsx.
  </verify>
  <done>
SubtitlePreview renders full file content with ASS/SRT syntax highlighting, file metadata bar, and integrated timeline. SubtitleTimeline renders cue markers with color-coding by style classification and click-to-scroll. Both components are type-safe and use React Query hooks for data fetching.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. Grep for all 6 new TypeScript interfaces in types.ts
3. Grep for all 5 new API client functions in client.ts
4. Grep for all 5 new hooks in useApi.ts
5. Grep for `SubtitlePreview` export in SubtitlePreview.tsx
6. Grep for `SubtitleTimeline` export in SubtitleTimeline.tsx
</verification>

<success_criteria>
- SubtitlePreview renders syntax-highlighted subtitle content with format detection
- SubtitleTimeline visualizes cue positions on a time axis
- Clicking a timeline cue scrolls the preview to that position
- All API types, client functions, and hooks are present and TypeScript-valid
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-editor/11-02-SUMMARY.md`
</output>

---
phase: 11-subtitle-editor
plan: 04
type: execute
wave: 3
depends_on: ["11-02", "11-03"]
files_modified:
  - frontend/src/components/editor/SubtitleEditorModal.tsx
  - frontend/src/pages/SeriesDetail.tsx
  - frontend/src/pages/Wanted.tsx
  - frontend/src/pages/History.tsx
autonomous: true

must_haves:
  truths:
    - "User can open a subtitle preview from Wanted page by clicking a preview button on any wanted item with an existing subtitle"
    - "User can open a subtitle preview from History page by clicking a preview button on any history entry"
    - "User can open a subtitle preview and editor from SeriesDetail page for any episode's subtitle file"
    - "The editor modal lazy-loads CodeMirror (React.lazy + Suspense) to avoid bloating the main bundle"
    - "Modal supports three modes: preview, edit, and diff, with navigation between them"
  artifacts:
    - path: "frontend/src/components/editor/SubtitleEditorModal.tsx"
      provides: "Modal wrapper with lazy loading and mode switching"
      contains: "SubtitleEditorModal"
    - path: "frontend/src/pages/SeriesDetail.tsx"
      provides: "Preview and edit buttons per episode subtitle"
      contains: "SubtitleEditorModal"
    - path: "frontend/src/pages/Wanted.tsx"
      provides: "Preview button per wanted item"
      contains: "SubtitleEditorModal"
    - path: "frontend/src/pages/History.tsx"
      provides: "Preview and diff button per history entry"
      contains: "SubtitleEditorModal"
  key_links:
    - from: "frontend/src/components/editor/SubtitleEditorModal.tsx"
      to: "frontend/src/components/editor/SubtitlePreview.tsx"
      via: "React.lazy dynamic import"
      pattern: "lazy.*SubtitlePreview"
    - from: "frontend/src/components/editor/SubtitleEditorModal.tsx"
      to: "frontend/src/components/editor/SubtitleEditor.tsx"
      via: "React.lazy dynamic import"
      pattern: "lazy.*SubtitleEditor"
    - from: "frontend/src/pages/SeriesDetail.tsx"
      to: "frontend/src/components/editor/SubtitleEditorModal.tsx"
      via: "Modal open state and filePath prop"
      pattern: "SubtitleEditorModal"
---

<objective>
Create the SubtitleEditorModal wrapper component with lazy loading and mode switching, then integrate preview/edit buttons into SeriesDetail, Wanted, and History pages.

Purpose: Connects the editor components to the existing pages (EDIT-02, EDIT-04), completing the user-facing experience for subtitle preview and editing.
Output: SubtitleEditorModal.tsx and updated SeriesDetail, Wanted, History pages with preview/edit entry points.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-editor/11-RESEARCH.md
@.planning/phases/11-subtitle-editor/11-02-SUMMARY.md
@.planning/phases/11-subtitle-editor/11-03-SUMMARY.md
@frontend/src/pages/SeriesDetail.tsx
@frontend/src/pages/Wanted.tsx
@frontend/src/pages/History.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubtitleEditorModal with lazy loading and mode switching</name>
  <files>frontend/src/components/editor/SubtitleEditorModal.tsx</files>
  <action>
Create a modal wrapper that lazy-loads editor components and manages mode transitions.

**Props interface:**
```typescript
interface SubtitleEditorModalProps {
  filePath: string | null         // null = modal closed
  initialMode?: 'preview' | 'edit' | 'diff'
  onClose: () => void
}
```

**Lazy imports:**
```typescript
const SubtitlePreview = lazy(() => import('@/components/editor/SubtitlePreview'))
const SubtitleEditor = lazy(() => import('@/components/editor/SubtitleEditor'))
const SubtitleDiff = lazy(() => import('@/components/editor/SubtitleDiff'))
```

Note: SubtitlePreview, SubtitleEditor, and SubtitleDiff must use `export default` or have a default export adapter. If they use named exports, use the adapter pattern from research: `.then(m => ({ default: m.SubtitlePreview }))`. Check the actual exports from Plans 02 and 03 and adapt accordingly.

**State:**
- `mode`: 'preview' | 'edit' | 'diff' (initialized from `initialMode ?? 'preview'`)
- `content`: string | null (loaded content for editor and diff use)
- `lastModified`: number | null (mtime from content load, passed to editor for save)
- `format`: 'ass' | 'srt' | null

**Data loading:**
- Use `useSubtitleContent(filePath)` from Plan 02's hooks
- When content loads, store `content`, `lastModified`, and `format` in state
- Pass these to SubtitleEditor and SubtitleDiff as props

**Mode transitions:**
- Preview mode: Render `<SubtitlePreview filePath={filePath} onEdit={() => setMode('edit')} onClose={onClose} />`
- Edit mode: Render `<SubtitleEditor filePath={filePath} initialContent={content} format={format} lastModified={lastModified} onSave={(newMtime) => { setLastModified(newMtime); }} onClose={onClose} onDiffView={() => setMode('diff')} />`
- Diff mode: Render `<SubtitleDiff filePath={filePath} currentContent={content} format={format} onClose={onClose} onBackToEditor={() => setMode('edit')} />`

**Modal UI:**
- When `filePath` is null, render nothing (modal closed)
- Overlay: `fixed inset-0 z-50 bg-black/60 flex items-center justify-center`
- Content: `w-[92vw] h-[88vh] max-w-7xl rounded-lg overflow-hidden flex flex-col` with background matching `bg-surface` and border
- Header: mode tab buttons (Preview | Edit | Diff), file path display (truncated), close button (X icon)
- Body: `<Suspense fallback={loading spinner}>` wrapping the active mode component
- Handle Escape key: close modal (if no unsaved changes in edit mode)
- Click outside modal (on overlay): close (if no unsaved changes)
- Prevent body scroll when modal is open: apply `overflow-hidden` to document.body via useEffect

**Loading spinner:**
- Show centered `<Loader2 className="animate-spin h-8 w-8 text-teal-500" />` with "Loading editor..." text during lazy load
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript errors.
Grep for `SubtitleEditorModal` export and `React.lazy` usage in SubtitleEditorModal.tsx.
  </verify>
  <done>
SubtitleEditorModal renders a full-screen modal with lazy-loaded editor components, three mode tabs (preview/edit/diff), and proper state management for mode switching. CodeMirror is not bundled in the main chunk.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate preview/edit buttons into SeriesDetail, Wanted, and History</name>
  <files>
    frontend/src/pages/SeriesDetail.tsx
    frontend/src/pages/Wanted.tsx
    frontend/src/pages/History.tsx
  </files>
  <action>
Add preview and edit entry points to the three pages. For each page, the pattern is: add state for selected file path, render SubtitleEditorModal conditionally, add button(s) to table/list rows.

**SeriesDetail.tsx:**
- Add state: `const [editorFilePath, setEditorFilePath] = useState<string | null>(null)`
- Add state: `const [editorMode, setEditorMode] = useState<'preview' | 'edit'>('preview')`
- In the episode list/table rows, for each episode that has subtitles (check `episode.subtitles` Record):
  - For each language entry in `episode.subtitles` where value is non-empty ("ass" or "srt"):
    - Compute the subtitle file path: derive from `episode.file_path` by replacing the video extension with `.{lang}.{format}` (e.g., `/media/show/S01E01.en.ass`). The subtitle path convention is: same directory as the video file, same base name, with `.{lang_code}.{ext}` suffix.
    - Add a small "Preview" button (Eye icon from lucide-react, `h-5 w-5`) that sets `editorFilePath` to the computed path and `editorMode` to 'preview'
    - Add a small "Edit" button (Pencil icon, `h-5 w-5`) that sets `editorFilePath` and `editorMode` to 'edit'
    - Buttons should be inline with the subtitle status badges, using `gap-1` spacing
- At the bottom of the component, render:
  ```tsx
  {editorFilePath && (
    <SubtitleEditorModal
      filePath={editorFilePath}
      initialMode={editorMode}
      onClose={() => setEditorFilePath(null)}
    />
  )}
  ```
- Import `SubtitleEditorModal` directly (not lazy -- the modal itself handles lazy loading internally)

**Wanted.tsx:**
- Add state: `const [previewFilePath, setPreviewFilePath] = useState<string | null>(null)`
- In the wanted items list, for items that have an existing subtitle file (check if `item.file_path` exists and the subtitle file can be derived):
  - The wanted item has `file_path` (media file path). Derive subtitle path from it using the target language and existing subtitle format.
  - Add a "Preview" button (Eye icon) that opens the modal in preview mode
  - Only show preview for items that already have a subtitle file (the "existing" column or subtitle status indicates one exists)
- Render `<SubtitleEditorModal>` at bottom with `initialMode="preview"` and `onClose`
- Note: Wanted items may not always have a subtitle file to preview. Only show the button when there is an existing subtitle.

**History.tsx:**
- Add state: `const [editorFilePath, setEditorFilePath] = useState<string | null>(null)`
- Add state: `const [editorMode, setEditorMode] = useState<'preview' | 'edit'>('preview')`
- In the history list/table, for each entry that has a subtitle path:
  - Add "Preview" button (Eye icon) -> opens modal in preview mode
  - Add "Diff" button (GitCompare icon) -> opens modal in diff mode (compare current vs backup)
- Render `<SubtitleEditorModal>` at bottom

**Subtitle path derivation helper:**
Create a small helper function (can be inline or in a shared util) to derive the subtitle file path from a media file path + language code + format:
```typescript
function deriveSubtitlePath(mediaPath: string, lang: string, format: string): string {
  const lastDot = mediaPath.lastIndexOf('.')
  const base = lastDot > 0 ? mediaPath.substring(0, lastDot) : mediaPath
  return `${base}.${lang}.${format}`
}
```

**Button styling:**
Use compact icon-only buttons with tooltips (title attribute): `p-1 rounded hover:bg-white/10 text-muted hover:text-primary transition-colors`. This keeps the UI clean without adding excessive visual weight.

**Import considerations:**
- Import `SubtitleEditorModal` from `@/components/editor/SubtitleEditorModal`
- Import icons (Eye, Pencil, GitCompare) from `lucide-react`
- The modal lazy-loads CodeMirror internally, so page bundle size is not affected
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript errors.
Grep for `SubtitleEditorModal` in SeriesDetail.tsx, Wanted.tsx, and History.tsx.
Grep for `setEditorFilePath` or `setPreviewFilePath` in all three pages (state management present).
  </verify>
  <done>
SeriesDetail shows preview/edit buttons per episode subtitle. Wanted shows preview button for items with existing subtitles. History shows preview and diff buttons per entry. All three pages render SubtitleEditorModal conditionally. CodeMirror is lazy-loaded and does not affect page bundle sizes.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. `cd frontend && npm run build` -- production build succeeds, verify CodeMirror is in a separate chunk (check dist/assets/ for a lazy-loaded chunk)
3. Grep for `SubtitleEditorModal` in all four files
4. Grep for `React.lazy` in SubtitleEditorModal.tsx
5. Grep for eye/pencil/gitcompare icon imports in the three pages
</verification>

<success_criteria>
- SubtitleEditorModal opens from SeriesDetail, Wanted, and History pages
- Modal lazy-loads CodeMirror (not in main bundle)
- Preview, edit, and diff modes work via tab switching
- Modal handles escape, overlay click, and unsaved changes guard
- All TypeScript compiles cleanly
- Production build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-editor/11-04-SUMMARY.md`
</output>

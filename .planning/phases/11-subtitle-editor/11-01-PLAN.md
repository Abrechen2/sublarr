---
phase: 11-subtitle-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/routes/tools.py
  - frontend/package.json
  - frontend/src/components/editor/lang-ass.ts
  - frontend/src/components/editor/lang-srt.ts
  - frontend/src/components/editor/editor-theme.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/tools/content returns full file content with encoding and format metadata"
    - "PUT /api/v1/tools/content saves edited content after creating a .bak backup"
    - "GET /api/v1/tools/backup returns the .bak file content for diff comparison"
    - "POST /api/v1/tools/validate checks ASS/SRT structure via pysubs2 and returns errors"
    - "POST /api/v1/tools/parse returns structured cue data (start, end, text, style) for timeline"
    - "ASS syntax highlighting tokenizer classifies section headers, keywords, timestamps, override tags, and comments"
    - "SRT syntax highlighting tokenizer classifies cue numbers, timestamps, arrows, and HTML tags"
  artifacts:
    - path: "backend/routes/tools.py"
      provides: "5 new API endpoints for subtitle editor"
      contains: "get_file_content"
    - path: "frontend/src/components/editor/lang-ass.ts"
      provides: "ASS StreamLanguage tokenizer for CodeMirror"
      contains: "assLanguage"
    - path: "frontend/src/components/editor/lang-srt.ts"
      provides: "SRT StreamLanguage tokenizer for CodeMirror"
      contains: "srtLanguage"
    - path: "frontend/src/components/editor/editor-theme.ts"
      provides: "Dark theme matching Sublarr's teal design"
      contains: "sublarrTheme"
  key_links:
    - from: "backend/routes/tools.py"
      to: "pysubs2"
      via: "pysubs2.load() for validation and cue parsing"
      pattern: "pysubs2\\.load"
    - from: "backend/routes/tools.py"
      to: "_validate_file_path"
      via: "Security validation reuse"
      pattern: "_validate_file_path"
---

<objective>
Add backend API endpoints for full subtitle file reading, saving, validation, and cue parsing, plus install CodeMirror npm dependencies and create ASS/SRT syntax highlighting tokenizers and a dark theme for the editor.

Purpose: Provides the API foundation and CodeMirror infrastructure that all editor UI components depend on.
Output: 5 new backend endpoints in tools.py, CodeMirror packages installed, ASS/SRT tokenizers, and editor dark theme.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-editor/11-RESEARCH.md
@backend/routes/tools.py
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend API endpoints for subtitle editor</name>
  <files>backend/routes/tools.py</files>
  <action>
Extend the existing tools.py blueprint with 5 new endpoints. Reuse the existing `_validate_file_path()` and `_create_backup()` helpers.

**GET /tools/content** -- Read full subtitle file content for editing:
- Accept `file_path` query param, validate with `_validate_file_path()`
- Detect encoding via chardet (with ImportError fallback to utf-8)
- Read full file content (not limited to 100 lines like preview)
- Return JSON: `{format: "ass"|"srt", content: string, encoding: string, size_bytes: int, total_lines: int, last_modified: float}` where `last_modified` is `os.path.getmtime()` for optimistic concurrency
- Add OpenAPI YAML docstring following existing tools.py pattern

**PUT /tools/content** -- Save edited subtitle content:
- Accept JSON body: `{file_path: string, content: string, last_modified: float}`
- Validate file_path with `_validate_file_path()`
- Compare `last_modified` with current `os.path.getmtime()` -- if different, return 409 Conflict with `{error: "File has been modified since you loaded it", current_mtime: float}`
- Call `_create_backup()` BEFORE writing (mandatory -- project safety rule)
- Write content as UTF-8
- Return JSON: `{status: "saved", backup_path: string, new_mtime: float}`
- Add OpenAPI YAML docstring

**GET /tools/backup** -- Read backup file for diff view:
- Accept `file_path` query param (the ORIGINAL file path, not the .bak path)
- Validate with `_validate_file_path()`
- Compute backup path: `base.bak{ext}` (same logic as `_create_backup`)
- If backup exists, read and return its content; if not, return 404
- Return JSON: `{content: string, encoding: string, backup_path: string}`
- Add OpenAPI YAML docstring

**POST /tools/validate** -- Validate subtitle structure:
- Accept JSON body: `{file_path: string, content: string}` -- content is the text to validate (not read from disk, to validate before saving)
- Use `pysubs2.SSAFile.from_string(content, format_=fmt)` to parse
- If parsing succeeds, return `{valid: true, event_count: int, style_count: int, warnings: []}`
- If parsing fails, return `{valid: false, error: string, warnings: []}`
- Do NOT require file_path to exist (validating unsaved content) but if provided, use extension for format detection; otherwise accept `format` param ("ass" or "srt")
- Add OpenAPI YAML docstring

**POST /tools/parse** -- Extract structured cue data for timeline:
- Accept JSON body: `{file_path: string}`
- Validate with `_validate_file_path()`
- Use `pysubs2.load()` to parse the file
- Extract cues: `[{start: float_seconds, end: float_seconds, text: string, style: string}]` for each event
- Convert pysubs2 millisecond timestamps to seconds (divide by 1000)
- Include `total_duration` (max end time) and `cue_count` in response
- For ASS files, include style classification using `classify_styles()` from ass_utils (lazy import) if available
- Return JSON: `{cues: [...], total_duration: float, cue_count: int, format: string, styles: {style_name: "dialog"|"signs"|"songs"} | null}`
- Add OpenAPI YAML docstring

Import pysubs2 at the function level (lazy import) to match existing tools.py patterns. All new endpoints must be wrapped in try/except with logger.error, consistent with existing endpoint error handling.
  </action>
  <verify>
Run: `cd backend && python -c "from routes.tools import bp; print([r.rule for r in bp.deferred_functions if hasattr(r, 'rule')] if hasattr(bp, 'deferred_functions') else 'Blueprint loaded OK')"` -- confirms blueprint loads without import errors.

Verify the 5 new routes exist: grep for `def get_file_content`, `def save_file_content`, `def get_backup_content`, `def validate_content`, `def parse_cues` in tools.py.
  </verify>
  <done>
tools.py has 5 new endpoints (content GET/PUT, backup GET, validate POST, parse POST) all using _validate_file_path for security and _create_backup before writes. PUT /content includes mtime-based optimistic concurrency check. POST /parse returns pysubs2-parsed cue data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install CodeMirror dependencies and create tokenizers + theme</name>
  <files>
    frontend/package.json
    frontend/src/components/editor/lang-ass.ts
    frontend/src/components/editor/lang-srt.ts
    frontend/src/components/editor/editor-theme.ts
  </files>
  <action>
**Install CodeMirror packages:**
```bash
cd frontend && npm install @uiw/react-codemirror @uiw/codemirror-themes @codemirror/merge react-codemirror-merge @codemirror/search @codemirror/language @codemirror/commands @codemirror/state @codemirror/view @lezer/highlight
```
Note: Some packages may already be peer dependencies. Run `npm install` and verify no version conflicts in package-lock.json.

**Create `frontend/src/components/editor/` directory** (new directory under components).

**Create `lang-ass.ts`** -- ASS format StreamLanguage tokenizer:
- Import `StreamLanguage` from `@codemirror/language`
- Define tokenizer that classifies:
  - Section headers `[Script Info]`, `[V4+ Styles]`, `[Events]` -> `heading`
  - Semicolon comment lines (`;` at start) -> `comment`
  - Event type keywords `Dialogue:`, `Comment:`, `Format:`, `Style:` at start of line -> `keyword`
  - Metadata `Key:` lines -> `propertyName`
  - Override tags `{...}` -> `meta`
  - ASS timestamps `H:MM:SS.CC` -> `number`
  - ASS line break markers `\N`, `\n` -> `escape`
  - Default: consume one char, return null
- Add `languageData: { commentTokens: { line: ';' } }`
- Export as `assLanguage`
- Follow the complete tokenizer from 11-RESEARCH.md

**Create `lang-srt.ts`** -- SRT format StreamLanguage tokenizer:
- Import `StreamLanguage` from `@codemirror/language`
- Define tokenizer that classifies:
  - Cue numbers (digits only on a line) -> `number`
  - SRT timestamps `00:00:00,000` -> `number`
  - Arrow `-->` -> `operator`
  - HTML-style tags `<i>`, `</i>`, `<b>`, `<font...>` -> `meta`
  - Default: consume one char, return null
- Export as `srtLanguage`
- Follow the tokenizer from 11-RESEARCH.md

**Create `editor-theme.ts`** -- Sublarr dark theme for CodeMirror:
- Import `createTheme` from `@uiw/codemirror-themes`
- Import `tags as t` from `@lezer/highlight`
- Create theme with `theme: 'dark'` settings:
  - background: `#1a1a2e` (dark surface matching Sublarr)
  - foreground: `#e2e8f0`
  - caret: `#1db8d4` (teal accent)
  - selection: `rgba(29, 184, 212, 0.2)` (teal with alpha)
  - selectionMatch: `rgba(29, 184, 212, 0.1)`
  - lineHighlight: `rgba(255, 255, 255, 0.04)`
  - gutterBackground: `#16162a`
  - gutterForeground: `#6b7280`
- Define styles:
  - heading -> `#22d3ee` bold (section headers)
  - keyword -> `#a78bfa` (Dialogue/Format/Style)
  - comment -> `#6b7280` italic
  - number -> `#34d399` (timestamps)
  - meta -> `#f59e0b` (override tags / HTML tags)
  - propertyName -> `#60a5fa` (metadata keys)
  - escape -> `#fb923c` (\\N line breaks)
  - operator -> `#94a3b8` (-->)
- Export as `sublarrTheme`
- Also export a `sublarrLightTheme` variant with inverted background/foreground for the light theme mode (if current theme context is light)
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit src/components/editor/lang-ass.ts src/components/editor/lang-srt.ts src/components/editor/editor-theme.ts 2>&1 | head -20` -- TypeScript compiles without errors.

Verify package.json has all new dependencies: grep for `@uiw/react-codemirror` and `@codemirror/merge` in package.json.
  </verify>
  <done>
CodeMirror packages installed in frontend/package.json. Three editor infrastructure files created: lang-ass.ts (ASS tokenizer), lang-srt.ts (SRT tokenizer), editor-theme.ts (dark + light themes). All files compile with TypeScript.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -c "from routes.tools import bp; print('OK')"` -- blueprint loads
2. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
3. Grep for all 5 endpoint functions in tools.py
4. Grep for `@uiw/react-codemirror` in frontend/package.json
5. Grep for `assLanguage` in lang-ass.ts and `srtLanguage` in lang-srt.ts
</verification>

<success_criteria>
- 5 new backend API endpoints functional in tools.py
- CodeMirror npm packages installed
- ASS and SRT tokenizers created and TypeScript-valid
- Editor dark theme created
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-editor/11-01-SUMMARY.md`
</output>

---
phase: 04-whisper-speech-to-text
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/api/client.ts
  - frontend/src/pages/Settings.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a Whisper tab in Settings with backend configuration cards"
    - "User can expand a Whisper backend card to see and edit its config fields"
    - "User can test a Whisper backend connection from the Settings UI"
    - "User can enable/disable Whisper and select the active backend"
    - "User can set max concurrent Whisper jobs from the UI"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "WhisperBackendInfo, WhisperJob, WhisperConfig TypeScript interfaces"
      contains: "WhisperBackendInfo"
    - path: "frontend/src/hooks/useApi.ts"
      provides: "React Query hooks for Whisper API endpoints"
      contains: "useWhisperBackends"
    - path: "frontend/src/api/client.ts"
      provides: "Axios client functions for Whisper API"
      contains: "whisper"
    - path: "frontend/src/pages/Settings.tsx"
      provides: "Whisper tab with backend cards, config form, test buttons"
      contains: "WhisperTab"
  key_links:
    - from: "frontend/src/pages/Settings.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useWhisperBackends, useWhisperConfig hooks"
      pattern: "useWhisperBackends|useWhisperConfig"
    - from: "frontend/src/hooks/useApi.ts"
      to: "frontend/src/api/client.ts"
      via: "Axios client functions"
      pattern: "getWhisperBackends|getWhisperConfig"
    - from: "frontend/src/api/client.ts"
      to: "/api/v1/whisper/"
      via: "HTTP requests to Whisper API"
      pattern: "/api/v1/whisper"
---

<objective>
Create the frontend Whisper Settings tab with backend configuration cards, test buttons, global Whisper config (enable/disable, active backend, max concurrent), and TypeScript types + React Query hooks for all Whisper API endpoints.

Purpose: This gives users the UI to configure and manage Whisper backends, matching the collapsible card pattern established for Translation Backends (Phase 2) and Media Servers (Phase 3). After this plan, users can configure faster-whisper or Subgen from the browser.

Output: Whisper tab in Settings page with full backend management UI, TypeScript types, API client functions, and React Query hooks
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-whisper-speech-to-text/04-RESEARCH.md
@.planning/phases/04-whisper-speech-to-text/04-01-SUMMARY.md
@.planning/phases/04-whisper-speech-to-text/04-02-SUMMARY.md

Key pattern references:
@frontend/src/lib/types.ts (existing TypeScript types: TranslationBackendInfo, MediaServerType, etc.)
@frontend/src/hooks/useApi.ts (existing React Query hooks: useBackends, useMediaServerTypes, etc.)
@frontend/src/api/client.ts (existing Axios client functions)
@frontend/src/pages/Settings.tsx (TranslationBackendsTab and MediaServersTab patterns to mirror)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, API client functions, and React Query hooks</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/hooks/useApi.ts
    frontend/src/api/client.ts
  </files>
  <action>
    Add Whisper-related types, API functions, and hooks following the established patterns.

    **frontend/src/lib/types.ts** -- Add at end of file:
    ```typescript
    // ─── Whisper Types ──────────────────────────────────────────────────────────
    export interface WhisperBackendInfo {
      name: string
      display_name: string
      config_fields: Array<{
        key: string
        label: string
        type: 'text' | 'password' | 'number'
        required: boolean
        default: string
        help: string
      }>
      configured: boolean
      supports_gpu: boolean
      supports_language_detection: boolean
    }

    export interface WhisperJob {
      id: string
      file_path: string
      language: string
      status: 'queued' | 'extracting' | 'loading' | 'transcribing' | 'saving' | 'completed' | 'failed' | 'cancelled'
      progress: number
      phase: string
      backend_name: string
      detected_language: string
      language_probability: number
      srt_content: string
      segment_count: number
      duration_seconds: number
      processing_time_ms: number
      error: string
      created_at: string
      started_at: string
      completed_at: string
    }

    export interface WhisperConfig {
      whisper_enabled: boolean
      whisper_backend: string
      max_concurrent_whisper: number
    }

    export interface WhisperStats {
      total: number
      by_status: Record<string, number>
      avg_processing_time: number
    }

    export interface WhisperHealthResult {
      healthy: boolean
      message: string
    }
    ```

    **frontend/src/api/client.ts** -- Add Whisper API functions (after existing media server functions):
    ```typescript
    // ─── Whisper API ──────────────────────────────────────────────────────────
    export const getWhisperBackends = () => api.get('/whisper/backends').then(r => r.data)
    export const testWhisperBackend = (name: string) => api.post(`/whisper/backends/test/${name}`).then(r => r.data)
    export const getWhisperBackendConfig = (name: string) => api.get(`/whisper/backends/config/${name}`).then(r => r.data)
    export const saveWhisperBackendConfig = (name: string, config: Record<string, string>) => api.put(`/whisper/backends/config/${name}`, config).then(r => r.data)
    export const getWhisperConfig = () => api.get('/whisper/config').then(r => r.data)
    export const saveWhisperConfig = (config: Record<string, unknown>) => api.put('/whisper/config', config).then(r => r.data)
    export const getWhisperQueue = (params?: { status?: string; limit?: number }) => api.get('/whisper/queue', { params }).then(r => r.data)
    export const getWhisperJob = (jobId: string) => api.get(`/whisper/jobs/${jobId}`).then(r => r.data)
    export const submitWhisperJob = (data: { file_path: string; language?: string }) => api.post('/whisper/transcribe', data).then(r => r.data)
    export const deleteWhisperJob = (jobId: string) => api.delete(`/whisper/jobs/${jobId}`).then(r => r.data)
    export const getWhisperStats = () => api.get('/whisper/stats').then(r => r.data)
    ```

    **frontend/src/hooks/useApi.ts** -- Add React Query hooks (after existing media server hooks):
    ```typescript
    // ─── Whisper Hooks ──────────────────────────────────────────────────────────
    export function useWhisperBackends() {
      return useQuery({ queryKey: ['whisper-backends'], queryFn: getWhisperBackends })
    }
    export function useTestWhisperBackend() {
      return useMutation({ mutationFn: (name: string) => testWhisperBackend(name) })
    }
    export function useWhisperBackendConfig(name: string) {
      return useQuery({
        queryKey: ['whisper-backend-config', name],
        queryFn: () => getWhisperBackendConfig(name),
        enabled: !!name,
      })
    }
    export function useSaveWhisperBackendConfig() {
      const qc = useQueryClient()
      return useMutation({
        mutationFn: ({ name, config }: { name: string; config: Record<string, string> }) => saveWhisperBackendConfig(name, config),
        onSuccess: () => { qc.invalidateQueries({ queryKey: ['whisper-backends'] }) },
      })
    }
    export function useWhisperConfig() {
      return useQuery({ queryKey: ['whisper-config'], queryFn: getWhisperConfig })
    }
    export function useSaveWhisperConfig() {
      const qc = useQueryClient()
      return useMutation({
        mutationFn: (config: Record<string, unknown>) => saveWhisperConfig(config),
        onSuccess: () => { qc.invalidateQueries({ queryKey: ['whisper-config'] }) },
      })
    }
    export function useWhisperQueue(params?: { status?: string; limit?: number }) {
      return useQuery({ queryKey: ['whisper-queue', params], queryFn: () => getWhisperQueue(params), refetchInterval: 5000 })
    }
    export function useWhisperStats() {
      return useQuery({ queryKey: ['whisper-stats'], queryFn: getWhisperStats })
    }
    ```

    Import the new API functions at the top of useApi.ts from client.ts. Import useQueryClient where needed (likely already imported).
  </action>
  <verify>
    cd frontend && npx tsc --noEmit 2>&1 | head -20  # TypeScript compiles without errors
    grep "WhisperBackendInfo" frontend/src/lib/types.ts  # Type exists
    grep "useWhisperBackends" frontend/src/hooks/useApi.ts  # Hook exists
    grep "getWhisperBackends" frontend/src/api/client.ts  # API function exists
  </verify>
  <done>
    TypeScript types for Whisper (backend info, job, config, stats) are defined. API client functions call all Whisper endpoints. React Query hooks provide data fetching with proper caching and invalidation. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Whisper Settings tab with backend cards and global config</name>
  <files>
    frontend/src/pages/Settings.tsx
  </files>
  <action>
    Add the Whisper tab to Settings.tsx following the exact pattern of TranslationBackendsTab and MediaServersTab (collapsible card layout).

    **Step 1: Add 'Whisper' to the TABS array:**
    Insert 'Whisper' after 'Media Servers' in the TABS constant:
    ```typescript
    const TABS = [
      'General',
      'Translation',
      'Translation Backends',
      'Languages',
      'Automation',
      'Wanted',
      'Providers',
      'Sonarr',
      'Radarr',
      'Media Servers',
      'Whisper',        // NEW
      'Notifications',
      'Prompt Presets',
    ]
    ```

    **Step 2: Add imports** at the top of the file:
    - Add to the useApi import: `useWhisperBackends, useTestWhisperBackend, useWhisperBackendConfig, useSaveWhisperBackendConfig, useWhisperConfig, useSaveWhisperConfig, useWhisperStats`
    - Add to the types import: `WhisperBackendInfo, WhisperConfig, WhisperHealthResult, WhisperStats`

    **Step 3: Create WhisperTab function component** (place after MediaServersTab):

    ```
    // --- Whisper Tab ---
    function WhisperTab() { ... }
    ```

    The WhisperTab has two sections:

    **Section A: Global Whisper Config (top of tab):**
    - Toggle switch for whisper_enabled (true/false)
    - Dropdown to select active whisper_backend from available backends
    - Number input for max_concurrent_whisper (default 1, range 1-4)
    - Save button that calls useSaveWhisperConfig
    - Use useWhisperConfig() to load current config
    - Stats summary from useWhisperStats() (total jobs, avg processing time) -- show below config if data available

    **Section B: Backend Cards (below config):**
    Follow EXACTLY the TranslationBackendsTab collapsible card pattern:
    - useWhisperBackends() to get list of backends
    - For each backend, render a card with:
      - Header: display_name, configured badge (green/gray), supports_gpu badge if true
      - Collapse/expand toggle (ChevronUp/ChevronDown)
      - When expanded: load config via useWhisperBackendConfig(name)
      - Config form: dynamically render input fields from backend.config_fields array
        - text -> text input
        - password -> password input with Eye/EyeOff toggle (same pattern as TranslationBackendsTab)
        - number -> number input
        - Show help text below each field
        - Show default value as placeholder
      - Test button: calls useTestWhisperBackend(), shows result (green check or red X with message)
      - Save button: calls useSaveWhisperBackendConfig with form values
      - Available models section (for faster_whisper only): Display the model size/VRAM table as a help reference below the config form

    **Section C (inline in cards): Model info for faster-whisper:**
    When the faster_whisper backend card is expanded, show a small info table:
    | Model | Approx Size |
    | tiny | ~150MB |
    | base | ~300MB |
    | small | ~900MB |
    | medium | ~3GB |
    | large-v2 | ~6GB |
    | large-v3 | ~6GB |
    | distil-large-v3 | ~1.5GB |

    **Step 4: Wire WhisperTab into the tab router:**
    In the main Settings component's JSX, add a condition:
    ```typescript
    const isWhisperTab = activeTab === 'Whisper'
    ```
    And in the rendering logic (near isTranslationBackendsTab / isMediaServersTab):
    ```typescript
    ) : isWhisperTab ? (
      <WhisperTab />
    ) : isMediaServersTab ? (
    ```
    Note: Insert the Whisper check BEFORE the MediaServers check since Whisper comes after Media Servers in the TABS array -- or simply add it as another branch in the conditional chain at the correct position.

    **Styling:** Use the same Tailwind classes and CSS variables as TranslationBackendsTab:
    - Card: `rounded-lg p-4` with `backgroundColor: 'var(--bg-surface)'`, `border: '1px solid var(--border)'`
    - Badge: `px-2 py-0.5 rounded-full text-xs` with green for configured, gray for not configured
    - Buttons: Same teal accent color (`var(--accent)`) as other tabs
    - Loading: Loader2 spinner like other tabs
  </action>
  <verify>
    cd frontend && npm run build 2>&1 | tail -10  # Build succeeds
    grep "'Whisper'" frontend/src/pages/Settings.tsx  # Tab name exists
    grep "WhisperTab" frontend/src/pages/Settings.tsx  # Component exists
    grep "isWhisperTab" frontend/src/pages/Settings.tsx  # Tab routing exists
  </verify>
  <done>
    Whisper tab appears in Settings page with global config (enable/disable, backend selection, max concurrent) and collapsible backend cards for faster-whisper and Subgen. Each card shows config fields, test button, and save button. The UI follows the established collapsible card pattern from Translation Backends and Media Servers tabs. Frontend builds without errors.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npm run build` -- No build errors
- `cd frontend && npx tsc --noEmit` -- No TypeScript errors
- Whisper tab visible in Settings page navigation
- Backend cards expand/collapse correctly
- Config fields render dynamically from backend.config_fields
- Test button shows health check result
- Global Whisper config (enabled, backend, max concurrent) saves and loads correctly
</verification>

<success_criteria>
- WhisperBackendInfo, WhisperJob, WhisperConfig, WhisperStats types defined in types.ts
- All Whisper API client functions created in client.ts
- React Query hooks created for backends, config, queue, stats
- WhisperTab component in Settings.tsx with global config section and backend cards
- Collapsible card pattern matches TranslationBackendsTab/MediaServersTab exactly
- Frontend builds and TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-whisper-speech-to-text/04-03-SUMMARY.md`
</output>

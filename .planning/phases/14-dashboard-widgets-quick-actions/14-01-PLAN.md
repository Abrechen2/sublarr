---
phase: 14-dashboard-widgets-quick-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/stores/dashboardStore.ts
  - frontend/src/components/dashboard/widgetRegistry.ts
  - frontend/src/components/dashboard/WidgetWrapper.tsx
  - frontend/src/components/dashboard/DashboardGrid.tsx
  - frontend/src/components/dashboard/WidgetSettingsModal.tsx
  - frontend/src/components/dashboard/widgets/StatCardsWidget.tsx
  - frontend/src/components/dashboard/widgets/QuickActionsWidget.tsx
  - frontend/src/components/dashboard/widgets/ServiceStatusWidget.tsx
  - frontend/src/components/dashboard/widgets/ProviderHealthWidget.tsx
  - frontend/src/components/dashboard/widgets/QualityWidget.tsx
  - frontend/src/components/dashboard/widgets/RecentActivityWidget.tsx
  - frontend/src/components/dashboard/widgets/TranslationStatsWidget.tsx
  - frontend/src/components/dashboard/widgets/WantedSummaryWidget.tsx
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/i18n/locales/en/dashboard.json
  - frontend/src/i18n/locales/de/dashboard.json
autonomous: true

must_haves:
  truths:
    - "User can drag dashboard widgets to rearrange their position"
    - "User can resize dashboard widgets by dragging the bottom-right corner"
    - "User can toggle visibility of individual widgets via a settings modal"
    - "User can reset dashboard layout to defaults"
    - "Dashboard layout persists across browser refreshes"
    - "At least 8 predefined widget types are rendered on the dashboard"
    - "Dashboard is responsive across lg/md/sm breakpoints"
  artifacts:
    - path: "frontend/src/stores/dashboardStore.ts"
      provides: "Zustand store with persist middleware for layout and visibility state"
      exports: ["useDashboardStore"]
    - path: "frontend/src/components/dashboard/widgetRegistry.ts"
      provides: "Widget definition registry with 8+ widget types"
      exports: ["WIDGET_REGISTRY", "WidgetDefinition", "WidgetId"]
    - path: "frontend/src/components/dashboard/DashboardGrid.tsx"
      provides: "Responsive grid layout using react-grid-layout v2"
      exports: ["DashboardGrid"]
    - path: "frontend/src/components/dashboard/WidgetWrapper.tsx"
      provides: "Generic widget chrome with drag handle, header, remove button"
      exports: ["WidgetWrapper"]
    - path: "frontend/src/components/dashboard/WidgetSettingsModal.tsx"
      provides: "Modal to toggle widget visibility and reset layout"
      exports: ["WidgetSettingsModal"]
    - path: "frontend/src/components/dashboard/widgets/StatCardsWidget.tsx"
      provides: "Ollama status, wanted count, translated today, queue stat cards"
    - path: "frontend/src/components/dashboard/widgets/QuickActionsWidget.tsx"
      provides: "Scan Library, Search Wanted action buttons"
    - path: "frontend/src/components/dashboard/widgets/ServiceStatusWidget.tsx"
      provides: "Service health status dots"
    - path: "frontend/src/components/dashboard/widgets/ProviderHealthWidget.tsx"
      provides: "Provider health list"
    - path: "frontend/src/components/dashboard/widgets/QualityWidget.tsx"
      provides: "Subtitle quality sparkline (wraps existing HealthDashboardWidget)"
    - path: "frontend/src/components/dashboard/widgets/RecentActivityWidget.tsx"
      provides: "Activity feed with recent jobs"
    - path: "frontend/src/components/dashboard/widgets/TranslationStatsWidget.tsx"
      provides: "Total stats, by format breakdown"
    - path: "frontend/src/components/dashboard/widgets/WantedSummaryWidget.tsx"
      provides: "Wanted items breakdown by status"
  key_links:
    - from: "frontend/src/pages/Dashboard.tsx"
      to: "frontend/src/components/dashboard/DashboardGrid.tsx"
      via: "JSX composition"
      pattern: "<DashboardGrid"
    - from: "frontend/src/components/dashboard/DashboardGrid.tsx"
      to: "frontend/src/stores/dashboardStore.ts"
      via: "Zustand hook"
      pattern: "useDashboardStore"
    - from: "frontend/src/components/dashboard/DashboardGrid.tsx"
      to: "frontend/src/components/dashboard/widgetRegistry.ts"
      via: "import WIDGET_REGISTRY"
      pattern: "WIDGET_REGISTRY"
    - from: "frontend/src/stores/dashboardStore.ts"
      to: "localStorage"
      via: "zustand persist middleware"
      pattern: "persist.*sublarr-dashboard"
---

<objective>
Create the drag-and-drop dashboard widget system with 8 predefined widgets, layout persistence, and a settings modal for toggling widget visibility.

Purpose: Transform the static Dashboard page into a customizable widget-based layout where users can rearrange, resize, and show/hide widgets. This satisfies DASH-01 (Widget-System) and DASH-02 (Vordefinierte Widgets).

Output: Fully functional drag-and-drop dashboard with 8 widget types, Zustand-persisted layout, responsive breakpoints, and a widget settings modal.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-widgets-quick-actions/14-RESEARCH.md
@frontend/src/pages/Dashboard.tsx
@frontend/src/stores/selectionStore.ts
@frontend/src/components/health/HealthDashboardWidget.tsx
@frontend/src/hooks/useApi.ts
@frontend/src/i18n/locales/en/dashboard.json
@frontend/src/i18n/locales/de/dashboard.json
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-grid-layout, create dashboard store and widget infrastructure</name>
  <files>
    frontend/package.json
    frontend/src/stores/dashboardStore.ts
    frontend/src/components/dashboard/widgetRegistry.ts
    frontend/src/components/dashboard/WidgetWrapper.tsx
    frontend/src/components/dashboard/DashboardGrid.tsx
    frontend/src/components/dashboard/WidgetSettingsModal.tsx
  </files>
  <action>
    1. Install react-grid-layout:
       ```
       cd frontend && npm install react-grid-layout
       ```
       Note: @types/react-grid-layout is NOT needed -- v2 ships with built-in TypeScript types.

    2. Create `frontend/src/stores/dashboardStore.ts`:
       - Zustand store with `persist` middleware, storage key `'sublarr-dashboard'`
       - State: `layouts: Record<string, Layout[]>` (breakpoint -> Layout[]), `hiddenWidgets: string[]` (array of widget IDs, NOT Set -- Set does not serialize to JSON cleanly)
       - Actions: `setLayouts(breakpoint: string, layout: Layout[])`, `toggleWidget(widgetId: string)`, `resetToDefault()`, `isWidgetHidden(widgetId: string): boolean`
       - Use immutable patterns: spread to create new arrays/objects, never mutate
       - Import `Layout` type from `react-grid-layout`
       - Follow the existing selectionStore.ts pattern for Zustand store structure

    3. Create `frontend/src/components/dashboard/widgetRegistry.ts`:
       - Define `WidgetDefinition` interface: `{ id: string, titleKey: string, icon: LucideIcon, defaultLayout: { w: number, h: number, minW?: number, minH?: number, x: number, y: number }, component: React.LazyExoticComponent<React.ComponentType> }`
       - Define `WIDGET_REGISTRY` as a readonly array of 8 widget definitions:
         - `stat-cards`: icon=BarChart3, defaultLayout={w:12, h:2, x:0, y:0, minW:6, minH:2}
         - `quick-actions`: icon=Zap, defaultLayout={w:12, h:2, x:0, y:2, minW:4, minH:2}
         - `service-status`: icon=Server, defaultLayout={w:6, h:3, x:0, y:4, minW:4, minH:2}
         - `provider-health`: icon=Shield, defaultLayout={w:6, h:3, x:6, y:4, minW:4, minH:2}
         - `quality`: icon=ShieldCheck, defaultLayout={w:12, h:3, x:0, y:7, minW:6, minH:3}
         - `translation-stats`: icon=Languages, defaultLayout={w:4, h:3, x:0, y:10, minW:3, minH:2}
         - `wanted-summary`: icon=AlertCircle, defaultLayout={w:4, h:3, x:4, y:10, minW:3, minH:2}
         - `recent-activity`: icon=Activity, defaultLayout={w:4, h:4, x:8, y:10, minW:4, minH:3}
       - Export `WidgetId` type derived from the registry: `type WidgetId = typeof WIDGET_REGISTRY[number]['id']`
       - Use `React.lazy(() => import('./widgets/XxxWidget'))` for each component
       - Export a helper function `getDefaultLayouts(): Layout[]` that maps WIDGET_REGISTRY to a Layout[] array using defaultLayout values, with `i` field set to the widget id

    4. Create `frontend/src/components/dashboard/WidgetWrapper.tsx`:
       - Props: `definition: WidgetDefinition`, `children: React.ReactNode`, `onRemove?: () => void`, `noPadding?: boolean`
       - Renders a card with:
         - Header div with class `widget-drag-handle` (this class is used by react-grid-layout's drag handle config)
         - Header contains: icon (14px, accent color), title (from `t(definition.titleKey)` using `useTranslation('dashboard')`), and optional X button (onRemove)
         - Header uses `cursor-grab active:cursor-grabbing` classes
         - Content area: if noPadding, use `flex-1 overflow-auto`; else `flex-1 overflow-auto p-4`
       - Style using CSS variables: `var(--bg-surface)`, `var(--border)`, `var(--accent)`, `var(--text-muted)`
       - Full height flex column layout: `h-full flex flex-col rounded-lg overflow-hidden`

    5. Create `frontend/src/components/dashboard/DashboardGrid.tsx`:
       - Import `Responsive, useContainerWidth` from `react-grid-layout`
       - Import RGL CSS: `import 'react-grid-layout/css/styles.css'` and `import 'react-resizable/css/styles.css'`
       - Use `useContainerWidth()` hook for container measurement
       - Read layouts and hiddenWidgets from `useDashboardStore()`
       - Merge stored layouts with default layouts: for each breakpoint, if stored layout exists use it, else fall back to `getDefaultLayouts()`
       - Filter WIDGET_REGISTRY to exclude hidden widgets
       - Responsive breakpoints: `{ lg: 1200, md: 996, sm: 768, xs: 480, xxs: 0 }`
       - Columns: `{ lg: 12, md: 10, sm: 6, xs: 4, xxs: 2 }`
       - rowHeight: 60, margin: [12, 12]
       - Drag handle: `.widget-drag-handle`
       - Resize handles: `['se']` (bottom-right only)
       - IMPORTANT (Pitfall 5): Persist layout on `onDragStop` and `onResizeStop` ONLY (not on every `onLayoutChange` pixel), to avoid janky drag performance. Use `onLayoutChange` for the allLayouts update to Zustand store.
       - Check `useDashboardStore.persist.hasHydrated()` or use a `mounted` guard to prevent layout flash (Pitfall 4)
       - Each widget wrapped in `<WidgetWrapper>` with `<Suspense fallback={<WidgetSkeleton />}>` inside
       - Export a `WidgetSkeleton` component (simple rounded div with skeleton animation)
       - Props: `onOpenSettings: () => void` -- passed to render a "Customize" button in the grid header area
       - Determine `noPadding` per widget: set `noPadding={true}` for 'stat-cards' widget ID (it renders a grid of sub-cards that need edge-to-edge layout)

    6. Create `frontend/src/components/dashboard/WidgetSettingsModal.tsx`:
       - Props: `open: boolean`, `onClose: () => void`
       - Shows a modal overlay (similar to existing modals in the codebase)
       - Lists all widgets from WIDGET_REGISTRY with toggle switches for visibility
       - Each row shows: widget icon, widget title (translated), toggle switch
       - Toggle calls `useDashboardStore().toggleWidget(widgetId)`
       - "Reset to Default" button calls `useDashboardStore().resetToDefault()` and closes modal
       - Use CSS variables for theming, match existing modal patterns
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes without TypeScript errors
    - `react-grid-layout` appears in frontend/package.json dependencies
    - All 6 files exist and export their main components/functions
  </verify>
  <done>
    Dashboard store persists layout to localStorage under 'sublarr-dashboard'. Widget registry defines 8 widget types with default layouts. DashboardGrid renders a responsive drag-and-drop grid. WidgetWrapper provides drag handle and card chrome. WidgetSettingsModal toggles widget visibility. All infrastructure compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract 8 widget components from Dashboard.tsx and rewrite Dashboard page</name>
  <files>
    frontend/src/components/dashboard/widgets/StatCardsWidget.tsx
    frontend/src/components/dashboard/widgets/QuickActionsWidget.tsx
    frontend/src/components/dashboard/widgets/ServiceStatusWidget.tsx
    frontend/src/components/dashboard/widgets/ProviderHealthWidget.tsx
    frontend/src/components/dashboard/widgets/QualityWidget.tsx
    frontend/src/components/dashboard/widgets/RecentActivityWidget.tsx
    frontend/src/components/dashboard/widgets/TranslationStatsWidget.tsx
    frontend/src/components/dashboard/widgets/WantedSummaryWidget.tsx
    frontend/src/pages/Dashboard.tsx
    frontend/src/i18n/locales/en/dashboard.json
    frontend/src/i18n/locales/de/dashboard.json
  </files>
  <action>
    Extract each section of the current Dashboard.tsx into its own widget component. Each widget is a self-contained component that fetches its own data via existing React Query hooks (useHealth, useStats, useJobs, useWantedSummary, useProviders, etc.). Widgets do NOT receive data as props -- they are fully autonomous.

    1. `StatCardsWidget.tsx` -- Extract the "Status Cards" grid (lines 124-164 of current Dashboard.tsx):
       - Uses `useHealth()`, `useStats()`, `useWantedSummary()`
       - Renders 4 StatCard components (Ollama, Wanted, Translated Today, Queue)
       - Include the `StatCard` and `SkeletonCard` sub-components from current Dashboard.tsx
       - Default export for lazy loading compatibility

    2. `QuickActionsWidget.tsx` -- Extract the "Quick Actions" section (lines 167-220):
       - Uses `useWantedSummary()`, `useRefreshWanted()`, `useStartWantedBatch()`, `useWantedBatchStatus()`
       - Renders Scan Library and Search Wanted buttons with loading states
       - Default export

    3. `ServiceStatusWidget.tsx` -- Extract the "Service Connections" section (lines 224-253):
       - Uses `useHealth()`
       - Renders service health dots grid
       - Default export

    4. `ProviderHealthWidget.tsx` -- Extract the "Subtitle Providers" section (lines 255-295):
       - Uses `useProviders()`
       - Renders provider health list with status colors
       - Default export

    5. `QualityWidget.tsx` -- Thin wrapper around the existing `HealthDashboardWidget`:
       - Imports `HealthDashboardWidget` from `@/components/health/HealthDashboardWidget`
       - Renders it in a Suspense boundary
       - Default export

    6. `TranslationStatsWidget.tsx` -- Extract the "Total Stats" + "By Format" + "System" sections (lines 304-380):
       - Uses `useStats()`
       - Combines the Total Stats, By Format, and System panels into a single widget (three columns on wide, stacked on narrow)
       - Include uptime counter logic (the useEffect with interval) from current Dashboard.tsx
       - Default export

    7. `WantedSummaryWidget.tsx` -- NEW widget (not a direct extract):
       - Uses `useWantedSummary()`
       - Shows wanted items breakdown by status: wanted, searching, downloaded, translated counts
       - Shows total count prominently
       - Uses existing design tokens (var(--bg-surface), var(--border), etc.)
       - Default export

    8. `RecentActivityWidget.tsx` -- Extract the "Recent Activity" section (lines 384-441):
       - Uses `useJobs(1, 10)`
       - Renders job list with StatusBadge, file path, relative time
       - Includes "View All" link to /activity
       - Default export

    9. Rewrite `frontend/src/pages/Dashboard.tsx`:
       - Remove ALL existing section code (StatCard, SkeletonCard, all JSX sections)
       - Import and render `DashboardGrid` component
       - Add a "Customize" button (Settings2 icon from lucide-react) that opens `WidgetSettingsModal`
       - Manage `settingsOpen` state for the modal
       - Keep the `<h1>{t('title')}</h1>` header
       - The page becomes ~30-40 lines: title, customize button, DashboardGrid, WidgetSettingsModal
       - Remove unused imports (the old hooks, icons, etc. are now in widget files)

    10. Update `frontend/src/i18n/locales/en/dashboard.json`:
        - Add `"widgets"` section with keys for all 8 widget titles:
          ```
          "widgets": {
            "stat_cards": "Status Overview",
            "quick_actions": "Quick Actions",
            "service_status": "Service Connections",
            "provider_health": "Subtitle Providers",
            "quality": "Subtitle Quality",
            "translation_stats": "Translation Stats",
            "wanted_summary": "Wanted Summary",
            "recent_activity": "Recent Activity",
            "customize": "Customize",
            "settings_title": "Dashboard Widgets",
            "settings_description": "Toggle widgets on or off. Drag widgets to rearrange.",
            "reset_layout": "Reset to Default",
            "no_widgets": "No widgets visible. Use Customize to add widgets."
          }
          ```

    11. Update `frontend/src/i18n/locales/de/dashboard.json`:
        - Add matching `"widgets"` section:
          ```
          "widgets": {
            "stat_cards": "Status-Uebersicht",
            "quick_actions": "Schnellaktionen",
            "service_status": "Dienst-Verbindungen",
            "provider_health": "Untertitel-Provider",
            "quality": "Untertitel-Qualitaet",
            "translation_stats": "Uebersetzungs-Statistiken",
            "wanted_summary": "Gesuchte-Zusammenfassung",
            "recent_activity": "Letzte Aktivitaet",
            "customize": "Anpassen",
            "settings_title": "Dashboard-Widgets",
            "settings_description": "Widgets ein- oder ausschalten. Widgets zum Anordnen ziehen.",
            "reset_layout": "Auf Standard zuruecksetzen",
            "no_widgets": "Keine Widgets sichtbar. Verwende Anpassen, um Widgets hinzuzufuegen."
          }
          ```

    IMPORTANT: Each widget should NOT have its own card wrapper (no rounded-lg border div) -- that chrome is provided by WidgetWrapper in DashboardGrid. The widget just renders its content directly. Exception: StatCardsWidget renders a grid of StatCard sub-components which have their own individual card styling (this is fine since StatCards are a grid-within-grid pattern).
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes without TypeScript errors
    - `cd frontend && npm run build` completes successfully
    - All 8 widget files exist in `frontend/src/components/dashboard/widgets/`
    - Dashboard.tsx is under 50 lines (was 445)
    - No unused imports in Dashboard.tsx (old hooks/icons removed)
  </verify>
  <done>
    8 widget components exist as self-contained files with own data fetching. Dashboard.tsx is rewritten to render DashboardGrid with WidgetSettingsModal. Widgets are draggable, resizable, and hideable. Layout persists in localStorage. Build compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. Run `cd frontend && npm run build` -- build completes without errors
2. Run `cd frontend && npx tsc --noEmit` -- type checking passes
3. Manual verification: Dashboard loads with 8 widgets in a responsive grid
4. Manual verification: Dragging a widget header repositions it; resizing bottom-right corner changes size
5. Manual verification: Refreshing the page preserves the customized layout
6. Manual verification: Opening widget settings modal allows toggling individual widgets on/off
7. Manual verification: "Reset to Default" restores original widget arrangement
</verification>

<success_criteria>
- Dashboard renders 8 widget types in a draggable, resizable grid layout
- Widget layout persists across page refreshes via localStorage
- Widget visibility can be toggled via settings modal
- Layout resets to defaults on user action
- Dashboard is responsive (12 cols on lg, 10 on md, 6 on sm, 4 on xs)
- No TypeScript errors, clean build
- Dashboard.tsx reduced from ~445 lines to ~40 lines
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-widgets-quick-actions/14-01-SUMMARY.md`
</output>

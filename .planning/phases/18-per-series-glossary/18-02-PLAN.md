---
phase: 18-per-series-glossary
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - frontend/src/api/client.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/pages/Settings/TranslationTab.tsx
  - frontend/src/pages/SeriesDetail.tsx
autonomous: false

must_haves:
  truths:
    - "User can view global glossary entries in Settings Translation tab"
    - "User can add a new global glossary entry from Settings"
    - "User can edit and delete global glossary entries from Settings"
    - "User can still manage per-series glossary entries in Series Detail view (no regression)"
    - "Series Detail glossary panel shows indication when entries override global entries"
  artifacts:
    - path: "frontend/src/api/client.ts"
      provides: "Updated glossary API functions accepting optional seriesId"
    - path: "frontend/src/hooks/useApi.ts"
      provides: "useGlobalGlossaryEntries hook and updated mutation hooks"
    - path: "frontend/src/pages/Settings/TranslationTab.tsx"
      provides: "GlobalGlossaryPanel component in Translation settings"
    - path: "frontend/src/pages/SeriesDetail.tsx"
      provides: "Updated GlossaryPanel with global override indicator"
  key_links:
    - from: "frontend/src/pages/Settings/TranslationTab.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useGlobalGlossaryEntries hook"
      pattern: "useGlobalGlossaryEntries"
    - from: "frontend/src/hooks/useApi.ts"
      to: "frontend/src/api/client.ts"
      via: "getGlossaryEntries(undefined) for global"
      pattern: "getGlossaryEntries"
    - from: "frontend/src/api/client.ts"
      to: "/api/v1/glossary"
      via: "GET without series_id param for global"
---

<objective>
Frontend UI for global glossary management in Settings and API client updates.

Purpose: Users need a way to manage global glossary entries (visible in Settings > Translation) and the API client needs to support optional seriesId for the updated backend endpoints.

Output: GlobalGlossaryPanel in TranslationTab, updated API client and hooks, and a subtle override indicator in SeriesDetail GlossaryPanel.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-per-series-glossary/18-RESEARCH.md
@.planning/phases/18-per-series-glossary/18-01-SUMMARY.md

@frontend/src/api/client.ts
@frontend/src/hooks/useApi.ts
@frontend/src/pages/Settings/TranslationTab.tsx
@frontend/src/pages/SeriesDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client + hooks for global glossary support</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/hooks/useApi.ts
  </files>
  <action>
1. **API client** (frontend/src/api/client.ts):
   - Update `GlossaryEntry` interface: change `series_id: number` to `series_id: number | null`
   - Update `getGlossaryEntries` signature: `seriesId: number` becomes `seriesId?: number | null`. When seriesId is undefined/null, do NOT include series_id in params (GET /glossary returns global). When seriesId is a number, include it as before.
     ```typescript
     export async function getGlossaryEntries(seriesId?: number | null, query?: string): Promise<{ entries: GlossaryEntry[]; series_id: number | null }> {
       const params: Record<string, unknown> = {}
       if (seriesId != null) params.series_id = seriesId
       if (query) params.query = query
       const { data } = await api.get('/glossary', { params })
       return data
     }
     ```
   - Update `createGlossaryEntry` signature: `series_id: number` becomes `series_id?: number | null`. When null/undefined, omit from body.
     ```typescript
     export async function createGlossaryEntry(entry: { series_id?: number | null; source_term: string; target_term: string; notes?: string }): Promise<GlossaryEntry> {
       const { data } = await api.post('/glossary', entry)
       return data
     }
     ```

2. **Hooks** (frontend/src/hooks/useApi.ts):
   - Add `useGlobalGlossaryEntries` hook:
     ```typescript
     export function useGlobalGlossaryEntries() {
       return useQuery({
         queryKey: ['glossary', 'global'],
         queryFn: () => getGlossaryEntries(null),
       })
     }
     ```
   - Update `useGlossaryEntries` to handle the updated signature (should still work since seriesId is still required when calling from SeriesDetail).
   - Update `useCreateGlossaryEntry` mutation: on success, invalidate both the specific series key AND the global key:
     ```typescript
     onSuccess: (_, variables) => {
       if (variables.series_id != null) {
         queryClient.invalidateQueries({ queryKey: ['glossary', variables.series_id] })
       } else {
         queryClient.invalidateQueries({ queryKey: ['glossary', 'global'] })
       }
     }
     ```
   - Update `useUpdateGlossaryEntry` and `useDeleteGlossaryEntry` similarly to invalidate the correct cache key (series-specific or global).
  </action>
  <verify>
    Run: `cd Z:/CC/Sublarr/frontend && npx tsc --noEmit` to confirm no TypeScript errors.
    Run: `cd Z:/CC/Sublarr/frontend && npm run lint` to confirm no lint errors.
  </verify>
  <done>
    GlossaryEntry.series_id is number | null in TypeScript.
    getGlossaryEntries() without seriesId calls GET /glossary (global).
    getGlossaryEntries(123) calls GET /glossary?series_id=123 (per-series).
    createGlossaryEntry without series_id creates global entry.
    useGlobalGlossaryEntries hook exists and queries global entries.
    Cache invalidation works for both global and per-series mutations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Global glossary UI in Settings + Series Detail indicator</name>
  <files>
    frontend/src/pages/Settings/TranslationTab.tsx
    frontend/src/pages/SeriesDetail.tsx
  </files>
  <action>
1. **GlobalGlossaryPanel** (frontend/src/pages/Settings/TranslationTab.tsx):
   - Add a new `GlobalGlossaryPanel` component at the bottom of TranslationTab (after Prompt Presets section).
   - Reuse the same UI pattern as the existing `GlossaryPanel` in SeriesDetail.tsx but adapted for global scope:
     - Use `useGlobalGlossaryEntries()` hook to fetch entries
     - Use `useCreateGlossaryEntry()` with `series_id: null` for new entries
     - Use `useUpdateGlossaryEntry()` and `useDeleteGlossaryEntry()` for edit/delete
     - Section header: "Global Glossary" with entry count badge
     - Add form: source_term input, target_term input, optional notes input, Add button
     - Entry list: each row shows source_term -> target_term with edit/delete icons
     - Inline editing: click edit to turn row into inputs, save/cancel buttons
     - Delete confirmation via window.confirm
     - Empty state: "No global glossary entries. Add terms that should be consistently translated across all series."
   - Import needed icons: Plus, Trash2, Edit2, X, Check, BookOpen (from lucide-react, most already imported)
   - Import hooks: useGlobalGlossaryEntries, useCreateGlossaryEntry, useUpdateGlossaryEntry, useDeleteGlossaryEntry from @/hooks/useApi
   - Style: Use existing CSS variables (--bg-surface, --border, --text-primary, --text-muted, --accent). Follow the card-based layout pattern used elsewhere in TranslationTab.
   - Add the panel in the TranslationTab return JSX after the PromptPresetsPanel section with a section heading.

2. **Series Detail override indicator** (frontend/src/pages/SeriesDetail.tsx):
   - In the existing GlossaryPanel component, add a subtle info line below the header:
     "Series-specific entries override global entries with the same source term."
   - Use text-xs and --text-muted color. Only show when there are entries.
   - No functional change to the existing GlossaryPanel CRUD operations.
  </action>
  <verify>
    Run: `cd Z:/CC/Sublarr/frontend && npx tsc --noEmit` to confirm no TypeScript errors.
    Run: `cd Z:/CC/Sublarr/frontend && npm run lint` to confirm no lint errors.
    Run: `cd Z:/CC/Sublarr/frontend && npm run build` to confirm production build succeeds.
  </verify>
  <done>
    TranslationTab has a "Global Glossary" section at the bottom.
    Users can add, edit, and delete global glossary entries from Settings.
    Global entries are created with series_id=null.
    SeriesDetail GlossaryPanel shows override info text.
    TypeScript compiles without errors.
    Production build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Global glossary management UI in Settings > Translation tab, and updated Series Detail glossary panel with override indicator.
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev` from project root
    2. Open http://localhost:5173/settings and go to Translation tab
    3. Scroll down to "Global Glossary" section
    4. Add a global entry: source="Titan" target="Titan" -- verify it appears in the list
    5. Edit the entry: change target to "Titane" -- verify inline edit works
    6. Delete the entry -- verify confirmation dialog and removal
    7. Navigate to any series detail page (e.g., /series/1)
    8. Click "Glossary" button to expand the panel
    9. Verify the info text about series-specific overriding global entries appears
    10. Add a per-series entry -- verify it still works as before
    11. Verify the existing per-series glossary CRUD is unchanged
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. API client: GlossaryEntry.series_id is number | null
2. API client: getGlossaryEntries() without args returns global, with seriesId returns per-series
3. Hooks: useGlobalGlossaryEntries() exists and works
4. Settings: TranslationTab has GlobalGlossaryPanel with full CRUD
5. Series Detail: GlossaryPanel shows override info text
6. TypeScript: No errors
7. Build: Production build succeeds
</verification>

<success_criteria>
- Global glossary entries can be managed from Settings > Translation
- Per-series glossary entries still work from Series Detail (no regression)
- Series Detail shows informational text about per-series overriding global
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-per-series-glossary/18-02-SUMMARY.md`
</output>

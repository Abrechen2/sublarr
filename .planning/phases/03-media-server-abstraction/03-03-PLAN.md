---
phase: 03-media-server-abstraction
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/api/client.ts
  - frontend/src/hooks/useApi.ts
  - frontend/src/pages/Settings.tsx
  - frontend/src/pages/Onboarding.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see a 'Media Servers' tab in Settings that replaces the old 'Jellyfin' tab"
    - "User can add multiple media server instances of different types (Jellyfin, Plex, Kodi) from a dropdown"
    - "User can test each configured media server instance and see a success/failure result"
    - "User can enable/disable individual media server instances"
    - "User can configure path mappings per media server instance"
    - "Onboarding wizard includes a media server configuration step with multi-server support"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "MediaServerType, MediaServerInstance, MediaServerHealthResult interfaces"
      contains: "MediaServerInstance"
    - path: "frontend/src/api/client.ts"
      provides: "API client functions for media server CRUD and test"
      contains: "getMediaServerTypes"
    - path: "frontend/src/hooks/useApi.ts"
      provides: "React Query hooks for media servers"
      contains: "useMediaServerTypes"
    - path: "frontend/src/pages/Settings.tsx"
      provides: "Media Servers tab replacing Jellyfin tab"
      contains: "MediaServersTab"
    - path: "frontend/src/pages/Onboarding.tsx"
      provides: "Media server step in onboarding wizard"
      contains: "media server"
  key_links:
    - from: "frontend/src/pages/Settings.tsx"
      to: "frontend/src/hooks/useApi.ts"
      via: "useMediaServerTypes, useMediaServerInstances, useSaveMediaServerInstances, useTestMediaServer"
      pattern: "useMediaServer"
    - from: "frontend/src/hooks/useApi.ts"
      to: "frontend/src/api/client.ts"
      via: "getMediaServerTypes, getMediaServerInstances, etc."
      pattern: "getMediaServer"
    - from: "frontend/src/api/client.ts"
      to: "/api/v1/mediaservers/*"
      via: "axios GET/PUT/POST"
      pattern: "mediaservers"
---

<objective>
Build the frontend Media Servers settings tab and onboarding wizard step, replacing the legacy Jellyfin-only tab with a multi-server editor supporting all three backends.

Purpose: Gives users a unified interface to configure any combination of Jellyfin, Emby, Plex, and Kodi media servers with test buttons, path mappings, and enable/disable toggles.

Output: New Media Servers tab in Settings (replacing Jellyfin tab), media server step in Onboarding, TypeScript types, API hooks.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-media-server-abstraction/03-RESEARCH.md
@.planning/phases/03-media-server-abstraction/03-01-SUMMARY.md
@.planning/phases/03-media-server-abstraction/03-02-SUMMARY.md
@.planning/phases/02-translation-multi-backend/02-05-SUMMARY.md

# Files to modify (read before editing)
@frontend/src/lib/types.ts
@frontend/src/api/client.ts
@frontend/src/hooks/useApi.ts
@frontend/src/pages/Settings.tsx
@frontend/src/pages/Onboarding.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, API client functions, and React Query hooks</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/api/client.ts
    frontend/src/hooks/useApi.ts
  </files>
  <action>
**1. Add TypeScript interfaces to `frontend/src/lib/types.ts`:**

Add after the existing BackendStats interface block:

```typescript
// Media Server types (Phase 3)
export interface MediaServerType {
  name: string           // "jellyfin", "plex", "kodi"
  display_name: string   // "Jellyfin / Emby", "Plex", "Kodi"
  config_fields: BackendConfigField[]  // Reuse existing BackendConfigField interface
}

export interface MediaServerInstance {
  type: string           // "jellyfin", "plex", "kodi"
  name: string           // User-defined name, e.g. "Living Room Plex"
  enabled: boolean
  [key: string]: unknown // Dynamic config keys (url, api_key, token, username, password, path_mapping)
}

export interface MediaServerHealthResult {
  name: string
  type: string
  healthy: boolean
  message: string
}

export interface MediaServerTestResult {
  healthy: boolean
  message: string
}
```

Note: `BackendConfigField` is already defined (key, label, type, required, default, help) and is reused here since media server config fields follow the same schema.

**2. Add API client functions to `frontend/src/api/client.ts`:**

Add after the existing backend API functions:

```typescript
// Media Servers API
export const getMediaServerTypes = () =>
  api.get<MediaServerType[]>('/mediaservers/types').then(r => r.data)

export const getMediaServerInstances = () =>
  api.get<MediaServerInstance[]>('/mediaservers/instances').then(r => r.data)

export const saveMediaServerInstances = (instances: MediaServerInstance[]) =>
  api.put<MediaServerInstance[]>('/mediaservers/instances', instances).then(r => r.data)

export const testMediaServer = (config: Record<string, unknown>) =>
  api.post<MediaServerTestResult>('/mediaservers/test', config).then(r => r.data)

export const getMediaServerHealth = () =>
  api.get<MediaServerHealthResult[]>('/mediaservers/health').then(r => r.data)
```

Add the necessary imports from types.ts (MediaServerType, MediaServerInstance, MediaServerTestResult, MediaServerHealthResult).

**3. Add React Query hooks to `frontend/src/hooks/useApi.ts`:**

Add after the existing backend hooks:

```typescript
// Media Server hooks
export const useMediaServerTypes = () =>
  useQuery({ queryKey: ['mediaServerTypes'], queryFn: getMediaServerTypes, staleTime: 60_000 })

export const useMediaServerInstances = () =>
  useQuery({ queryKey: ['mediaServerInstances'], queryFn: getMediaServerInstances, staleTime: 10_000 })

export const useSaveMediaServerInstances = () => {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: saveMediaServerInstances,
    onSuccess: () => { qc.invalidateQueries({ queryKey: ['mediaServerInstances'] }) }
  })
}

export const useTestMediaServer = () =>
  useMutation({ mutationFn: testMediaServer })

export const useMediaServerHealth = () =>
  useQuery({ queryKey: ['mediaServerHealth'], queryFn: getMediaServerHealth, staleTime: 30_000 })
```

Import the necessary API functions from client.ts and types.
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit 2>&1 | head -20
echo "---"
grep -c "MediaServer" src/lib/types.ts
grep -c "mediaserver\|MediaServer" src/api/client.ts
grep -c "mediaserver\|MediaServer" src/hooks/useApi.ts
```
  </verify>
  <done>TypeScript interfaces for media servers defined. API client functions for all 5 endpoints added. React Query hooks with appropriate stale times created. No TypeScript compilation errors.</done>
</task>

<task type="auto">
  <name>Task 2: Media Servers settings tab and onboarding update</name>
  <files>
    frontend/src/pages/Settings.tsx
    frontend/src/pages/Onboarding.tsx
  </files>
  <action>
**1. Update `frontend/src/pages/Settings.tsx`** -- Replace Jellyfin tab with Media Servers tab.

Changes:
- In the `tabs` array (around line 20-25), replace `'Jellyfin'` with `'Media Servers'`.
- Remove the Jellyfin-specific FIELDS entries (jellyfin_url, jellyfin_api_key around lines 78-79) -- they are no longer needed since media servers have their own dynamic config.
- Remove `'Jellyfin'` from the `hasTestConnection` array (line 1937).

Create a new `MediaServersTab` component (inside Settings.tsx, similar to TranslationBackendsTab):

```
MediaServersTab component:
- Uses useMediaServerTypes() to get available server types
- Uses useMediaServerInstances() to get currently configured instances
- Uses useSaveMediaServerInstances() mutation
- Uses useTestMediaServer() mutation

UI layout:
- Header: "Media Servers" with "Add Server" button
- "Add Server" button opens a dropdown to select type (Jellyfin / Emby, Plex, Kodi)
- List of configured instances, each as a collapsible card (reuse the BackendCard pattern from Translation Backends)

Each instance card shows:
- Header: instance name + type badge + enabled toggle (checkbox) + expand/collapse arrow
- Expanded content (only when opened):
  - Name field (text input, editable)
  - Dynamic config fields rendered from the type's config_fields (same pattern as TranslationBackendsTab BackendCard)
  - Password/token fields have show/hide toggle (reuse existing pattern)
  - Path Mapping field with help text: "Map container paths, e.g. /media:/data"
  - "Test Connection" button that calls useTestMediaServer with the instance config
  - Test result display (green OK or red error message)
  - "Remove" button (red, with confirmation)

When any change is made (add, edit, remove, toggle enabled):
- Update local state
- Call useSaveMediaServerInstances with the full updated array
- This follows the "save full array" pattern, not individual instance saves

Empty state: "No media servers configured. Add one to enable library refresh notifications after subtitle downloads."
```

In the main Settings component render (around line 2050-2230):
- Add `const isMediaServersTab = activeTab === 'Media Servers'`
- Add a render block: `{isMediaServersTab && <MediaServersTab />}`
- Remove any Jellyfin-specific render blocks if they exist beyond the FIELDS-driven form

**2. Update `frontend/src/pages/Onboarding.tsx`** -- Add media server step.

Read the current Onboarding.tsx to understand its step structure. Add a new optional step for media server configuration:

- Step title: "Media Servers (Optional)"
- Step description: "Configure media servers for automatic library refresh after subtitle downloads"
- Show server type selection buttons (Jellyfin, Plex, Kodi) with icons or labels
- When a type is selected, show the config fields for that type (url, token/api_key, etc.)
- "Test" button to verify connection
- "Skip" button to proceed without configuring
- "Add Another" button to add multiple servers
- Configured servers shown as compact cards with name + type

This step should come AFTER the Sonarr/Radarr step (if present) and BEFORE the completion step.

The onboarding should save instances via the same `saveMediaServerInstances` API call as Settings. Use the same hooks.

Keep the onboarding step simple -- users can always configure more details in Settings later. Focus on: select type, enter URL + credentials, test, done.
  </action>
  <verify>
```bash
cd frontend && npm run build 2>&1 | tail -10
echo "---"
# Verify tab replacement
grep -c "'Media Servers'" src/pages/Settings.tsx
grep -c "'Jellyfin'" src/pages/Settings.tsx
# Verify component exists
grep -c "MediaServersTab" src/pages/Settings.tsx
# Verify onboarding update
grep -ci "media.server" src/pages/Onboarding.tsx
```
  </verify>
  <done>Settings page has "Media Servers" tab (no more "Jellyfin" tab). Tab shows collapsible instance cards with dynamic config forms, test buttons, enable/disable toggles, and add/remove controls. Onboarding includes optional media server configuration step. Frontend builds without errors.</done>
</task>

</tasks>

<verification>
```bash
cd frontend && npm run build 2>&1 | tail -5
echo "=== TypeScript check ==="
npx tsc --noEmit 2>&1 | tail -10
echo "=== Tab check ==="
grep "'Media Servers'" src/pages/Settings.tsx
echo "=== No old Jellyfin tab ==="
grep "tab: 'Jellyfin'" src/pages/Settings.tsx || echo "Jellyfin tab removed: OK"
echo "=== Onboarding ==="
grep -i "media.server" src/pages/Onboarding.tsx | head -3
```
</verification>

<success_criteria>
- Settings has "Media Servers" tab, "Jellyfin" tab is removed
- Media Servers tab shows registered server types with "Add Server" dropdown
- Each configured instance renders as a collapsible card with dynamic config form
- Test button sends config to POST /mediaservers/test and shows result
- Enable/disable toggle works per instance
- Path mapping field present per instance
- Saving instances calls PUT /mediaservers/instances with full array
- Onboarding has optional media server step with type selection and quick config
- Frontend builds and TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-media-server-abstraction/03-03-SUMMARY.md`
</output>

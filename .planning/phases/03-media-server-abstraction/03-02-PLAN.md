---
phase: 03-media-server-abstraction
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/routes/mediaservers.py
  - backend/routes/__init__.py
  - backend/routes/config.py
  - backend/routes/system.py
  - backend/translator.py
  - backend/app.py
  - backend/config.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API endpoints exist for listing server types, listing configured instances, adding/removing instances, testing instances, and health-checking all"
    - "After subtitle download or translation, _notify_integrations calls MediaServerManager.refresh_all instead of jellyfin_client directly"
    - "Config changes trigger media server manager invalidation so new settings take effect"
    - "Health endpoint reports status of all configured media server instances"
    - "Legacy jellyfin_url + jellyfin_api_key config auto-migrates to media_servers_json on first load"
  artifacts:
    - path: "backend/routes/mediaservers.py"
      provides: "Blueprint with /api/v1/mediaservers/* endpoints"
      contains: "bp = Blueprint"
    - path: "backend/translator.py"
      provides: "Updated _notify_integrations using MediaServerManager"
      contains: "get_media_server_manager"
    - path: "backend/routes/__init__.py"
      provides: "mediaservers blueprint registration"
      contains: "mediaservers"
    - path: "backend/config.py"
      provides: "media_servers_json setting + legacy migration helper"
      contains: "media_servers_json"
  key_links:
    - from: "backend/routes/mediaservers.py"
      to: "backend/mediaserver/__init__.py"
      via: "get_media_server_manager import"
      pattern: "from mediaserver import get_media_server_manager"
    - from: "backend/translator.py"
      to: "backend/mediaserver/__init__.py"
      via: "_notify_integrations calls refresh_all"
      pattern: "manager\\.refresh_all"
    - from: "backend/routes/config.py"
      to: "backend/mediaserver/__init__.py"
      via: "invalidate_media_server_manager on config change"
      pattern: "invalidate_media_server_manager"
    - from: "backend/routes/system.py"
      to: "backend/mediaserver/__init__.py"
      via: "health_check_all for health endpoint"
      pattern: "health_check_all"
---

<objective>
Wire the MediaServer package into the application: API blueprint, translator.py notification dispatch, config invalidation, health endpoint, and legacy config migration.

Purpose: Connects the media server abstraction (built in Plan 01) to all existing call sites so the entire system uses the new multi-server architecture instead of the hardcoded Jellyfin singleton.

Output: New mediaservers blueprint registered, translator.py rewired, health endpoint updated, legacy config migration in place.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-media-server-abstraction/03-RESEARCH.md
@.planning/phases/03-media-server-abstraction/03-01-SUMMARY.md

# Files to modify (read before editing)
@backend/routes/__init__.py
@backend/routes/config.py
@backend/routes/system.py
@backend/translator.py
@backend/app.py
@backend/config.py

# Pattern reference
@backend/routes/translate.py (lines 574-700 for backend API endpoint pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Media servers API blueprint + config migration</name>
  <files>
    backend/routes/mediaservers.py
    backend/routes/__init__.py
    backend/config.py
  </files>
  <action>
**1. Create `backend/routes/mediaservers.py`** -- Blueprint for media server management API.

Blueprint: `bp = Blueprint("mediaservers", __name__, url_prefix="/api/v1")` with these endpoints:

- `GET /mediaservers/types` -- Return list of registered server type info (name, display_name, config_fields) from `manager.get_all_server_types()`. No auth needed.

- `GET /mediaservers/instances` -- Return the current media_servers_json array from config_entries. Each entry has: type, name, enabled, and type-specific config keys. Mask password/token fields in response (show only last 4 chars). Load from `get_all_config_entries()` key `media_servers_json`, parse JSON.

- `PUT /mediaservers/instances` -- Save the full instances array. Accept JSON body as the complete array. Validate each entry has required fields (type, name). Store as JSON string in config_entries under key `media_servers_json` using `set_config_entry("media_servers_json", json.dumps(body))`. After saving, call `invalidate_media_server_manager()` then `get_media_server_manager().load_instances()` to reload. Return 200 with the saved array.

- `POST /mediaservers/test` -- Test a single media server instance. Accept JSON body with type + config (url, token, etc.). Create a temporary instance of the specified type class, call `health_check()`. Return `{"healthy": bool, "message": str}`. Do NOT persist anything. This is for the "Test" button in UI.

- `GET /mediaservers/health` -- Call `manager.health_check_all()` to get health status of all configured instances. Return list of `{name, type, healthy, message}`.

Follow the same patterns as `routes/translate.py` backend endpoints (lines 574-700): import manager, try/except for clean errors, return JSON.

**2. Update `backend/routes/__init__.py`** -- Register the mediaservers blueprint.

Add `from routes.mediaservers import bp as mediaservers_bp` and add `mediaservers_bp` to the blueprint list.

**3. Update `backend/config.py`** -- Add `media_servers_json` setting and legacy migration helper.

Add field to SublarrSettings class (after jellyfin_api_key line):
```python
media_servers_json: str = ""  # JSON array of media server instances
```

Add a helper function `get_media_server_instances()` (similar to `get_sonarr_instances()`):
- First check config_entries for `media_servers_json` key
- If found and non-empty, parse and return the JSON array
- If not found, check for legacy `jellyfin_url` + `jellyfin_api_key` in settings
- If legacy values exist, auto-create a single-entry array: `[{"type": "jellyfin", "name": "Jellyfin", "enabled": True, "url": jellyfin_url, "api_key": jellyfin_api_key}]`
- Store this migrated array back into config_entries as `media_servers_json` (one-time migration)
- If neither exists, return empty list

This mirrors the `get_sonarr_instances()` / `get_radarr_instances()` legacy fallback pattern already in config.py.
  </action>
  <verify>
```bash
cd backend && python -c "
# Verify blueprint imports
from routes.mediaservers import bp
assert bp.name == 'mediaservers'
print(f'Blueprint: {bp.name}, url_prefix: {bp.url_prefix}')

# Verify config field
from config import SublarrSettings
s = SublarrSettings()
assert hasattr(s, 'media_servers_json')
print(f'media_servers_json default: \"{s.media_servers_json}\"')

# Verify blueprint registration
from routes import register_blueprints
from flask import Flask
app = Flask(__name__)
register_blueprints(app)
rules = [r.rule for r in app.url_map.iter_rules()]
ms_rules = [r for r in rules if 'mediaserver' in r]
print(f'Media server routes: {ms_rules}')
assert any('mediaserver' in r for r in rules), 'No mediaserver routes found'
print('All checks passed')
"
```
  </verify>
  <done>Media servers API blueprint with 5 endpoints (types, instances GET/PUT, test, health) registered and accessible. Config.py has media_servers_json setting with legacy jellyfin migration helper.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire translator.py, health endpoint, and config invalidation</name>
  <files>
    backend/translator.py
    backend/routes/system.py
    backend/routes/config.py
    backend/app.py
  </files>
  <action>
**1. Rewire `backend/translator.py` `_notify_integrations()`** (around line 951).

Replace the current implementation that directly imports `jellyfin_client` with:

```python
def _notify_integrations(context, file_path=None):
    """Notify all configured media servers about new subtitle files.

    Args:
        context: arr_context dict with sonarr_series_id, sonarr_episode_id, or radarr_movie_id
        file_path: File path for media server item lookup
    """
    if not context or not file_path:
        return

    item_type = ""
    if context.get("sonarr_series_id") or context.get("sonarr_episode_id"):
        item_type = "episode"
    elif context.get("radarr_movie_id"):
        item_type = "movie"

    try:
        from mediaserver import get_media_server_manager
        manager = get_media_server_manager()
        results = manager.refresh_all(file_path, item_type)
        for r in results:
            if r.success:
                logger.info("Media server refresh: %s", r.message)
            else:
                logger.warning("Media server refresh failed: %s", r.message)
    except Exception as e:
        logger.warning("Media server notification failed: %s", e)
```

Remove the `from jellyfin_client import get_jellyfin_client` import that was inside the old function. The new code uses only the media server manager.

**2. Update `backend/routes/system.py` health endpoint** (around line 58-68).

Replace the Jellyfin-specific health check block with a generic media server health check:

```python
# Media Servers (replaces old Jellyfin-specific check)
try:
    from mediaserver import get_media_server_manager
    manager = get_media_server_manager()
    ms_health = manager.health_check_all()
    if ms_health:
        healthy_count = sum(1 for h in ms_health if h["healthy"])
        service_status["media_servers"] = f"{healthy_count}/{len(ms_health)} healthy"
        # Also add individual server status
        for h in ms_health:
            key = f"media_server:{h['name']}"
            service_status[key] = h["message"] if h["healthy"] else f"unhealthy: {h['message']}"
    else:
        service_status["media_servers"] = "none configured"
except Exception:
    service_status["media_servers"] = "error"
```

Remove the old `from jellyfin_client import get_jellyfin_client` block.

**3. Update `backend/routes/config.py` invalidation** (two locations).

In both places where `_inv_jellyfin()` is called (around lines 73-78 and 163-167):
- Replace `from jellyfin_client import invalidate_client as _inv_jellyfin` with `from mediaserver import invalidate_media_server_manager as _inv_media`
- Replace `_inv_jellyfin()` with `_inv_media()`
- After invalidation, also reload instances: add `from mediaserver import get_media_server_manager; get_media_server_manager().load_instances()` wrapped in try/except

**4. Update `backend/app.py` `create_app()`** -- Initialize media server manager at startup.

After the plugin system initialization block (around line 172) and before blueprint registration (line 181), add:

```python
# Initialize media server manager (loads configured instances)
try:
    from mediaserver import get_media_server_manager
    ms_manager = get_media_server_manager()
    ms_manager.load_instances()
    types = ms_manager.get_all_server_types()
    logger.info("Media server manager initialized: %d types registered", len(types))
except Exception as e:
    logger.warning("Media server manager initialization failed: %s", e)
```

Do NOT delete `backend/jellyfin_client.py` yet -- it may still be imported by tests. It will be cleaned up in a later phase or gap closure. Just ensure no production code imports it anymore.
  </action>
  <verify>
```bash
cd backend && python -c "
# Verify translator.py no longer imports jellyfin_client
import ast
with open('translator.py', 'r') as f:
    content = f.read()
# Check _notify_integrations uses mediaserver
assert 'get_media_server_manager' in content, 'translator.py should use get_media_server_manager'
assert 'from jellyfin_client' not in content.split('def _notify_integrations')[1].split('def ')[0] if 'def _notify_integrations' in content else True, 'jellyfin_client import should be removed from _notify_integrations'
print('translator.py: OK - uses MediaServerManager')

# Verify system.py uses media_servers
with open('routes/system.py', 'r') as f:
    sys_content = f.read()
assert 'get_media_server_manager' in sys_content or 'media_server' in sys_content, 'system.py should use media server manager'
print('system.py: OK - uses media server health check')

# Verify config.py invalidation
with open('routes/config.py', 'r') as f:
    cfg_content = f.read()
assert 'invalidate_media_server_manager' in cfg_content, 'config.py should invalidate media server manager'
print('config.py: OK - invalidates media server manager')

# Verify app.py initialization
with open('app.py', 'r') as f:
    app_content = f.read()
assert 'media_server_manager' in app_content.lower() or 'get_media_server_manager' in app_content, 'app.py should initialize media server manager'
print('app.py: OK - initializes media server manager')

# Full import test
from app import create_app
app = create_app(testing=True)
print('App creation: OK')
" && echo "All wiring checks passed"
```
  </verify>
  <done>translator.py _notify_integrations uses MediaServerManager.refresh_all. Health endpoint reports all media server statuses. Config changes trigger manager invalidation + reload. App initializes media server manager at startup. No production code imports jellyfin_client directly.</done>
</task>

</tasks>

<verification>
```bash
cd backend && python -c "
from app import create_app
app = create_app(testing=True)

with app.test_client() as client:
    # Test health endpoint includes media servers
    resp = client.get('/api/v1/health')
    assert resp.status_code == 200
    data = resp.get_json()
    assert 'media_servers' in data.get('services', {}), 'Health should report media_servers'
    print(f'Health services: {list(data[\"services\"].keys())}')

    # Test mediaservers/types endpoint
    resp = client.get('/api/v1/mediaservers/types')
    assert resp.status_code == 200
    types = resp.get_json()
    assert len(types) >= 3, f'Expected >= 3 server types, got {len(types)}'
    print(f'Server types: {[t[\"name\"] for t in types]}')

    # Test mediaservers/instances endpoint (should be empty initially)
    resp = client.get('/api/v1/mediaservers/instances')
    assert resp.status_code == 200
    print(f'Instances: {resp.get_json()}')

    print('All integration checks passed')
"
```
</verification>

<success_criteria>
- GET /api/v1/mediaservers/types returns 3 server types (jellyfin, plex, kodi)
- GET /api/v1/mediaservers/instances returns configured instances (empty if none)
- PUT /api/v1/mediaservers/instances saves and reloads configuration
- POST /api/v1/mediaservers/test creates temporary instance and runs health_check
- translator.py _notify_integrations uses MediaServerManager.refresh_all
- Health endpoint reports media_servers status instead of jellyfin-only
- Config save triggers media server manager invalidation and reload
- Legacy jellyfin_url/jellyfin_api_key auto-migrates to media_servers_json
- App creates without errors with testing=True
</success_criteria>

<output>
After completion, create `.planning/phases/03-media-server-abstraction/03-02-SUMMARY.md`
</output>

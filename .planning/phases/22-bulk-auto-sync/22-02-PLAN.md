---
phase: 22-bulk-auto-sync
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - frontend/src/hooks/useWebSocket.ts
  - frontend/src/api/client.ts
  - frontend/src/pages/Library.tsx
  - frontend/src/pages/SeriesDetail.tsx
  - frontend/src/components/editor/SubtitleEditorModal.tsx
  - frontend/src/pages/Settings/TranslationTab.tsx
autonomous: false

must_haves:
  truths:
    - "User can trigger single-file auto-sync from Library view, Series Detail, or Subtitle Editor"
    - "User can trigger bulk auto-sync for series or library from Library or Tools section"
    - "Bulk sync progress is shown in real time (current file, completed count, failed count)"
    - "User can choose sync engine (alass/ffsubsync) in Settings or per operation"
  artifacts:
    - path: "frontend/src/hooks/useWebSocket.ts"
      provides: "Handlers for sync_batch_progress, sync_batch_complete"
    - path: "frontend/src/api/client.ts"
      provides: "autoSyncFile, autoSyncBulk, getSyncConfig, saveSyncConfig"
    - path: "frontend/src/pages/Library.tsx"
      provides: "Single-file sync button per row; Bulk sync controls"
    - path: "frontend/src/pages/SeriesDetail.tsx"
      provides: "Sync button for episode subtitle"
    - path: "frontend/src/components/editor/SubtitleEditorModal.tsx"
      provides: "Sync button in editor"
    - path: "frontend/src/pages/Settings/TranslationTab.tsx"
      provides: "Default sync engine setting"
  key_links:
    - from: "frontend"
      to: "POST /api/v1/tools/auto-sync"
      via: "autoSyncFile"
    - from: "frontend"
      to: "POST /api/v1/tools/auto-sync/bulk"
      via: "autoSyncBulk"
---

<objective>
Frontend: UI to trigger single-file and bulk auto-sync; progress display; Settings for default sync engine.

Purpose: Users trigger sync from Library, Series Detail, and Editor; bulk sync with live progress; configure default engine in Settings.

Output: Sync buttons in Library, Series Detail, Editor; bulk sync dialog or section with progress; useWebSocket handlers for sync_batch_*; Settings Translation (or Tools) for default engine.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-bulk-auto-sync/22-01-SUMMARY.md

@frontend/src/hooks/useWebSocket.ts
@frontend/src/api/client.ts
@frontend/src/pages/Library.tsx
@frontend/src/pages/SeriesDetail.tsx
@frontend/src/components/editor/SubtitleEditorModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client and WebSocket handlers</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/hooks/useWebSocket.ts
  </files>
  <action>
1. Add autoSyncFile(filePath: string, mediaPath?: string, engine?: string): POST /tools/auto-sync. Add autoSyncBulk(scope: "series"|"library", seriesId?: number, engine?: string): POST /tools/auto-sync/bulk. Add getSyncConfig / saveSyncConfig for sync_default_engine if exposed.
2. In useWebSocket (or equivalent): register handlers for sync_batch_progress and sync_batch_complete; expose state (current, total, completed, failed, file_path) for UI to show progress. Optional: useSyncBatchStatus() hook that returns last progress and complete event.
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit` and `npm run lint`.
  </verify>
  <done>
    API client has autoSyncFile and autoSyncBulk; WebSocket handlers for sync batch events; optional status hook.
  </done>
</task>

<task type="auto">
  <name>Task 2: Single-file sync triggers in Library, Series Detail, Editor</name>
  <files>
    frontend/src/pages/Library.tsx
    frontend/src/pages/SeriesDetail.tsx
    frontend/src/components/editor/SubtitleEditorModal.tsx
  </files>
  <action>
1. Library: per row with a subtitle file, add "Sync" or "Auto-sync" button; on click call autoSyncFile(file_path) (media path derived or from row data). Show toast on success/error.
2. Series Detail: for each episode with subtitle, add Sync button; call autoSyncFile with episode subtitle path.
3. Subtitle Editor modal: add "Sync timing" or "Auto-sync" button; call autoSyncFile with current file_path; on success refresh content or notify user.
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit`. Manually trigger sync from each place; confirm API called and feedback shown.
  </verify>
  <done>
    Sync button available from Library, Series Detail, and Editor; single-file sync works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Bulk sync UI and progress display</name>
  <files>
    frontend/src/pages/Library.tsx
  </files>
  <action>
1. In Library (or Tools section): add "Bulk auto-sync" control: scope selector (Series / Library), optional series picker when Series, optional engine override. On submit call autoSyncBulk(scope, seriesId, engine).
2. Show progress: when sync_batch_progress / sync_batch_complete are received, display current file, completed/total/failed counts (e.g. progress bar or list). Reuse pattern from Wanted batch progress if available.
  </action>
  <verify>
    Run: `cd frontend && npm run build`. Trigger bulk sync; confirm progress updates in UI.
  </verify>
  <done>
    Bulk sync trigger and real-time progress display implemented.
  </done>
</task>

<task type="auto">
  <name>Task 4: Settings for default sync engine</name>
  <files>
    frontend/src/pages/Settings/TranslationTab.tsx
  </files>
  <action>
1. In Settings (Translation or new Tools section): add "Default sync engine" dropdown (Alass, ffsubsync). Save to config sync_default_engine. Used when user does not override per operation.
  </action>
  <verify>
    Set default engine, save; confirm value persists and is used when no per-request engine.
  </verify>
  <done>
    Default sync engine configurable in Settings.
  </done>
</task>

</tasks>

<verification>
1. Single-file sync trigger from Library, Series Detail, Editor.
2. Bulk sync trigger with scope and progress display; WebSocket events drive UI.
3. Default sync engine in Settings.
</verification>

<success_criteria>
- User can trigger single-file sync from Library, Series Detail, and Editor.
- User can trigger bulk sync and see real-time progress.
- Default sync engine configurable in Settings.
</success_criteria>

<output>
After completion, create `.planning/phases/22-bulk-auto-sync/22-02-SUMMARY.md`
</output>

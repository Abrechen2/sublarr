---
phase: 25-anidb-absolute-episode-order
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - backend/providers/base.py
  - backend/providers/animetosho.py
  - backend/providers/jimaku.py
  - backend/routes/library.py
  - frontend/src/pages/SeriesDetail.tsx
  - frontend/src/api/client.ts
autonomous: false

must_haves:
  truths:
    - "Providers that accept absolute episode numbers (AnimeTosho, Jimaku) receive the AniDB absolute number; S/E providers receive Sonarr numbering unchanged"
    - "User can enable Absolute Order mode per series in Series Settings"
    - "Mapping management (refresh, status) visible in UI where appropriate"
  artifacts:
    - path: "backend/providers/base.py"
      provides: "VideoQuery has absolute_episode (optional int)"
    - path: "backend/providers/animetosho.py"
      provides: "Use query.absolute_episode when set for search/params"
    - path: "backend/providers/jimaku.py"
      provides: "Use query.absolute_episode when set for scoring/filtering"
    - path: "frontend/src/pages/SeriesDetail.tsx"
      provides: "Absolute Order toggle in series settings"
  key_links:
    - from: "backend/wanted_search.py"
      to: "VideoQuery.absolute_episode"
    - from: "backend/providers/animetosho.py"
      to: "query.absolute_episode"
---

<objective>
Backend + Frontend: VideoQuery.absolute_episode; AnimeTosho/Jimaku use it; Series Settings toggle and mapping UI.

Purpose: When absolute order is enabled and mapping exists, providers that support absolute episode (AnimeTosho, Jimaku) use it; others keep S/E. Users enable per series and can trigger mapping refresh.

Output: VideoQuery.absolute_episode; AnimeTosho and Jimaku use it in search/params; Series Detail (or Settings) has Absolute Order toggle; API to set series absolute_order and trigger mapping refresh; optional mapping status in UI.
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-anidb-absolute-episode-order/25-01-SUMMARY.md

@backend/providers/base.py
@backend/providers/animetosho.py
@backend/providers/jimaku.py
@frontend/src/pages/SeriesDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: VideoQuery.absolute_episode and provider use</name>
  <files>
    backend/providers/base.py
    backend/providers/animetosho.py
    backend/providers/jimaku.py
  </files>
  <action>
1. In VideoQuery (base.py): add optional absolute_episode: int. build_query_from_wanted (25-01) already sets it when mapping exists and series has absolute order.
2. AnimeTosho: when query.absolute_episode is set, use it for search (e.g. episode param or aid + absolute episode) per AnimeTosho API; keep episode as fallback for display. Check API docs for exact param.
3. Jimaku: when query.absolute_episode is set, use it for filtering/scoring if the API or filename matching supports absolute episode; otherwise document and use where applicable.
  </action>
  <verify>
    With absolute_episode set, AnimeTosho search uses absolute number; S/E-only providers still get season/episode.
  </verify>
  <done>
    VideoQuery has absolute_episode; AnimeTosho and Jimaku use it where supported.
  </done>
</task>

<task type="auto">
  <name>Task 2: API for series absolute order and mapping refresh</name>
  <files>
    backend/routes/library.py
    backend/routes/profiles.py
  </files>
  <action>
1. PUT /api/v1/series/:id/settings or PATCH: accept absolute_order: boolean. Store in series_settings or config_entries. GET series detail includes absolute_order.
2. POST /api/v1/anidb-mapping/refresh (or /refresh): trigger full mapping sync (or per-series). Return job id or status. Optional: GET /api/v1/anidb-mapping/status for last sync time and entry count.
  </action>
  <verify>
    curl sets absolute_order for series; refresh endpoint triggers sync.
  </verify>
  <done>
    API to set series absolute_order and trigger mapping refresh; optional status endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 3: Frontend Series Settings and mapping UI</name>
  <files>
    frontend/src/pages/SeriesDetail.tsx
    frontend/src/api/client.ts
  </files>
  <action>
1. In Series Detail: add "Absolute order" toggle (or in series settings section). Save via API (PUT series settings). Help text: "Use AniDB absolute episode numbers for subtitle search (anime)."
2. Optional: "Refresh AniDB mapping" button that calls POST anidb-mapping/refresh; show last sync time if GET status available.
  </action>
  <verify>
    Run: `cd frontend && npx tsc --noEmit` and `npm run build`. Toggle saves; refresh button triggers sync.
  </verify>
  <done>
    Series Detail has Absolute Order toggle; optional mapping refresh and status.
  </done>
</task>

</tasks>

<verification>
1. VideoQuery.absolute_episode set by 25-01; AnimeTosho/Jimaku use it.
2. API: series absolute_order get/set; mapping refresh trigger.
3. Frontend: Absolute Order toggle; optional refresh/status.
</verification>

<success_criteria>
- Providers accepting absolute numbers receive AniDB absolute episode when series has absolute order.
- User can enable Absolute Order per series and trigger mapping refresh.
</success_criteria>

<output>
After completion, create `.planning/phases/25-anidb-absolute-episode-order/25-02-SUMMARY.md`
</output>

---
phase: 25-anidb-absolute-episode-order
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/db/models/
  - backend/db/repositories/
  - backend/db/
  - backend/wanted_search.py
  - backend/sonarr_client.py
autonomous: true

must_haves:
  truths:
    - "System maintains AniDB mapping table (TVDB series ID + season/episode to AniDB absolute episode number)"
    - "Mapping is sourced from anime-lists or manual entry; auto-refresh on schedule (default weekly) and manual trigger"
    - "build_query_from_wanted can resolve absolute_episode from mapping when series uses absolute order"
  artifacts:
    - path: "backend/db/models/"
      provides: "AnidbAbsoluteMapping or equivalent (tvdb_id, season, episode, anidb_absolute_episode)"
    - path: "backend/db/migrations/versions/"
      provides: "Migration for anidb_absolute_mapping table"
    - path: "backend/db/repositories/"
      provides: "get_anidb_absolute(tvdb_id, season, episode), set/update mapping, list for series"
    - path: "backend/wanted_search.py"
      provides: "build_query_from_wanted uses mapping when series has absolute order enabled"
  key_links:
    - from: "backend/wanted_search.py"
      to: "backend/db/"
      via: "get_anidb_absolute(tvdb_id, season, episode)"
    - from: "backend/"
      to: "anime-lists or external source"
      via: "Sync job to populate mapping"
---

<objective>
Backend: AniDB absolute episode mapping table and sync; query uses mapping when series is in absolute order mode.

Purpose: Anime series using absolute numbering get correct subtitle matches by mapping Sonarr S/E to AniDB absolute episode number. Mapping table is filled from anime-lists (or manual) and refreshed on schedule.

Output: DB table anidb_absolute_mapping (tvdb_id, season, episode, anidb_absolute_episode, updated_at); repository get/set/list; sync job (anime-lists or CSV/API) with scheduler (weekly) and manual trigger; wanted_search.build_query_from_wanted looks up absolute_episode when series has absolute order enabled (series-level flag in DB or config).
</objective>

<execution_context>
@C:/Users/Dennis Wittke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dennis Wittke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@backend/wanted_search.py
@backend/sonarr_client.py
@backend/db/
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB model and migration for AniDB absolute mapping</name>
  <files>
    backend/db/models/
    backend/db/migrations/versions/
  </files>
  <action>
1. Create model AnidbAbsoluteMapping: tvdb_id (int), season (int), episode (int), anidb_absolute_episode (int), updated_at (datetime). Unique on (tvdb_id, season, episode). Optional: source (str) e.g. "anime-lists".
2. Alembic migration: create table anidb_absolute_mapping with index on (tvdb_id, season, episode).
  </action>
  <verify>
    Run: `cd backend && alembic upgrade head`; import model and insert/query row.
  </verify>
  <done>
    Table and model exist; migration applies cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Repository and sync from anime-lists</name>
  <files>
    backend/db/repositories/
    backend/db/
  </files>
  <action>
1. Repository: get_anidb_absolute(tvdb_id, season, episode) -> optional int; upsert_mapping(tvdb_id, season, episode, anidb_absolute_episode); list_by_tvdb(tvdb_id); clear_for_tvdb(tvdb_id) for full refresh.
2. Sync job: fetch anime-lists data (e.g. anime-lists.github.io or clone) â€” map TVDB ID + S/E to AniDB absolute episode; upsert into table. Run as scheduled job (default weekly) and via API trigger (POST /api/v1/anidb-mapping/refresh). Document anime-lists format/source.
  </action>
  <verify>
    Run sync for one series; query get_anidb_absolute; confirm correct absolute number.
  </verify>
  <done>
    Repository and sync job implemented; mapping refresh on schedule and manual.
  </done>
</task>

<task type="auto">
  <name>Task 3: Series absolute-order flag and use in build_query_from_wanted</name>
  <files>
    backend/db/models/core.py
    backend/db/repositories/
    backend/wanted_search.py
  </files>
  <action>
1. Store per-series "absolute order" flag: either new table series_settings (sonarr_series_id, absolute_order bool) or config_entries key per series (e.g. series.<id>.absolute_order). Default false.
2. In build_query_from_wanted: when item has sonarr_series_id and that series has absolute_order enabled, get tvdb_id and S/E from episode metadata, call get_anidb_absolute(tvdb_id, season, episode). If found, set query.absolute_episode (or anidb_absolute_episode) for use by providers. Otherwise keep S/E only.
  </action>
  <verify>
    With mapping and series absolute_order=true, build_query_from_wanted produces absolute_episode; providers receive it in 25-02.
  </verify>
  <done>
    Absolute order per series stored; build_query_from_wanted sets absolute_episode from mapping when enabled.
  </done>
</task>

</tasks>

<verification>
1. anidb_absolute_mapping table exists; repository get/upsert/list/clear.
2. Sync job populates mapping from anime-lists; scheduler and manual trigger.
3. Series absolute_order flag stored; build_query_from_wanted uses mapping and sets absolute_episode on VideoQuery when enabled.
</verification>

<success_criteria>
- Mapping table and sync from anime-lists (or manual) with weekly and manual refresh.
- When series has absolute order, query includes AniDB absolute episode number for providers.
</success_criteria>

<output>
After completion, create `.planning/phases/25-anidb-absolute-episode-order/25-01-SUMMARY.md`
</output>
